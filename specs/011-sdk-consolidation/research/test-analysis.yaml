timestamp: "2025-12-28T16:30:00Z"
agent: test-analyzer

# ==============================================================================
# UNTESTED FILES
# Source files with no corresponding test coverage
# ==============================================================================
untested_files:
  # Core Infrastructure
  - file: src/core/vault.ts
    exports: [SecretVault, getSecret, setSecret]
    priority: medium
    reason: "No tests for secret management - critical for security"

  - file: src/core/tokens.ts
    exports: [DI tokens and injection keys]
    priority: low
    reason: "Token definitions are declarative, low risk"

  - file: src/core/decorators.ts
    exports: [injectable, inject decorators]
    priority: low
    reason: "Thin wrappers around needle-di"

  - file: src/core/recording-factory.ts
    exports: [createRecording, loadRecording]
    priority: high
    reason: "Recording infrastructure lacks direct unit tests"

  - file: src/core/replay-runner.ts
    exports: [ReplayRunner class]
    priority: high
    reason: "Replay logic tested only through integration tests"

  # Harness System
  - file: src/harness/base-harness.ts
    exports: [BaseHarness class]
    priority: medium
    reason: "Tested indirectly via harness.test.ts but no dedicated tests"

  - file: src/harness/base-renderer.ts
    exports: [BaseHarnessRenderer class]
    priority: medium
    reason: "Abstract base class - needs unit tests for shared behavior"

  - file: src/harness/composite-renderer.ts
    exports: [CompositeRenderer class]
    priority: high
    reason: "No tests for multi-renderer dispatch, error isolation"

  - file: src/harness/console-renderer.ts
    exports: [ConsoleRenderer class]
    priority: medium
    reason: "Console output - hard to test but needs snapshot tests"

  - file: src/harness/render-output.ts
    exports: [RenderOutput, Spinner types]
    priority: low
    reason: "Terminal rendering utilities - visual output"

  - file: src/harness/renderer-interface.ts
    exports: [IHarnessRenderer interface types]
    priority: low
    reason: "Type-only file, no runtime behavior"

  - file: src/harness/replay-controller.ts
    exports: [ReplayController class]
    priority: high
    reason: "Critical replay functionality with zero unit tests"

  - file: src/harness/harness-recorder.ts
    exports: [HarnessRecorder, loadHarnessRun, reconstructCheckpoint]
    priority: high
    reason: "Recording/resume functionality needs dedicated tests"

  - file: src/harness/task-harness.ts
    exports: [TaskHarness class]
    priority: medium
    reason: "Tested indirectly via replay tests, needs unit coverage"

  - file: src/harness/task-state.ts
    exports: [createInitialState, getTask, completeTask, failTask, etc.]
    priority: medium
    reason: "State management functions tested indirectly"

  - file: src/harness/agent.ts
    exports: [Agent class wrapper]
    priority: low
    reason: "Simple wrapper, tested via harness.test.ts"

  - file: src/harness/event-protocol.ts
    exports: [Event type definitions and guards]
    priority: low
    reason: "Type guards should have unit tests but low impact"

  # Factory System
  - file: src/factory/harness-factory.ts
    exports: [createHarness factory]
    priority: medium
    reason: "Factory logic tested via define-harness integration"

  - file: src/factory/agent-factory.ts
    exports: [AgentFactory class]
    priority: medium
    reason: "Covered by agent-factory.test.ts but gaps exist"

  # Providers (Anthropic)
  - file: src/providers/anthropic/agents/base-anthropic-agent.ts
    exports: [BaseAnthropicAgent class]
    priority: high
    reason: "Base agent class - only tested via integration"

  - file: src/providers/anthropic/agents/coding-agent.ts
    exports: [CodingAgent class]
    priority: high
    reason: "Core agent - tested via replay only"

  - file: src/providers/anthropic/agents/parser-agent.ts
    exports: [ParserAgent class]
    priority: medium
    reason: "Has replay tests but needs unit tests"

  - file: src/providers/anthropic/agents/planner-agent.ts
    exports: [PlannerAgent class]
    priority: high
    reason: "No dedicated tests"

  - file: src/providers/anthropic/agents/review-agent.ts
    exports: [ReviewAgent class]
    priority: high
    reason: "No dedicated tests"

  - file: src/providers/anthropic/agents/validation-review-agent.ts
    exports: [ValidationReviewAgent class]
    priority: high
    reason: "No dedicated tests"

  - file: src/providers/anthropic/runner/anthropic-runner.ts
    exports: [AnthropicRunner class]
    priority: medium
    reason: "Runner integration logic"

  - file: src/providers/anthropic/runner/base-agent.ts
    exports: [BaseAgent class]
    priority: medium
    reason: "Base class for agents"

  - file: src/providers/anthropic/runner/models.ts
    exports: [Model definitions]
    priority: low
    reason: "Configuration data"

  - file: src/providers/anthropic/runner/prompts.ts
    exports: [Prompt templates]
    priority: low
    reason: "Template strings"

  # Monologue System
  - file: src/monologue/anthropic-llm.ts
    exports: [AnthropicLLM class]
    priority: high
    reason: "Real LLM wrapper - needs mocked unit tests"

  - file: src/monologue/prompts.ts
    exports: [Prompt templates]
    priority: low
    reason: "Template definitions"

  - file: src/monologue/tokens.ts
    exports: [DI tokens]
    priority: low
    reason: "Token definitions"

  # Dashboard (if used)
  - file: src/dashboard/
    exports: [Dashboard components]
    priority: low
    reason: "UI components - would need visual testing"

  # Workflow
  - file: src/workflow/orchestrator.ts
    exports: [WorkflowOrchestrator]
    priority: medium
    reason: "No dedicated tests"

  - file: src/workflow/task-list.ts
    exports: [TaskList management]
    priority: medium
    reason: "No dedicated tests"

# ==============================================================================
# TEST-ONLY UTILITIES
# Code that exists only in tests but should be in src/
# ==============================================================================
test_only_utilities:
  - location: tests/helpers/mock-monologue-llm.ts
    should_move_to: src/testing/mock-monologue-llm.ts
    exports: [MockMonologueLLM, createMockLLM, createWaitingMockLLM]
    reason: "Reusable mock for any test - should be exported for SDK users"

  - location: tests/helpers/recording-wrapper.ts
    should_move_to: src/testing/recording-wrapper.ts
    exports: [RecordingWrapper utilities]
    reason: "Recording test utilities should be available to SDK consumers"

  - location: tests/helpers/replay-runner.ts
    should_move_to: src/testing/replay-runner.ts
    exports: [Test replay helpers]
    reason: "Replay testing utilities for external use"

# ==============================================================================
# COVERAGE GAPS
# Files with tests but missing important scenarios
# ==============================================================================
coverage_gaps:
  - file: src/harness/harness-instance.ts
    tested_in: tests/unit/transport.test.ts
    missing_scenarios:
      - "Abort handling when workflow calls waitForUser() with timeout"
      - "Error propagation from nested phase/task contexts"
      - "Memory cleanup after long-running sessions"
      - "Multiple concurrent async iterator consumers"
      - "Edge case: reply() after workflow completes"
    priority: high

  - file: src/harness/session-context.ts
    tested_in: tests/unit/session-context.test.ts
    missing_scenarios:
      - "Timeout edge case at exactly timeout boundary"
      - "Multiple concurrent waitForUser() calls"
      - "Validator throwing exceptions"
      - "AbortController signal removal race condition"
    priority: medium

  - file: src/harness/async-queue.ts
    tested_in: tests/unit/async-queue.test.ts
    missing_scenarios:
      - "Memory pressure with large queues"
      - "Rapid push/pop cycles"
      - "Edge case: pop() when closed during wait"
    priority: low

  - file: src/core/unified-event-bus.ts
    tested_in: tests/unit/unified-event-bus.test.ts
    missing_scenarios:
      - "Deeply nested scoped contexts (>10 levels)"
      - "Cross-async-boundary context preservation"
      - "Event emission during event handler (re-entrancy)"
    priority: medium

  - file: src/factory/define-harness.ts
    tested_in: tests/unit/factory/define-harness.test.ts
    missing_scenarios:
      - "Agent dependency injection with circular deps"
      - "State factory error handling"
      - "Multiple run() calls on same instance"
    priority: medium

  - file: src/factory/wrap-agent.ts
    tested_in: tests/unit/factory/wrap-agent.test.ts
    missing_scenarios:
      - "Agent with constructor dependencies"
      - "Async agent execution with abort"
    priority: low

  - file: src/harness/control-flow.ts
    tested_in: tests/unit/harness/control-flow.test.ts
    missing_scenarios:
      - "Retry with exponential backoff exhaustion"
      - "Parallel with mixed success/failure/abort"
      - "Nested retry inside parallel"
    priority: medium

  - file: src/monologue/monologue-service.ts
    tested_in: tests/unit/monologue/monologue-service.test.ts
    missing_scenarios:
      - "History buffer overflow behavior"
      - "Concurrent addEvent() calls"
      - "LLM returning malformed responses"
    priority: medium

# ==============================================================================
# TEST QUALITY ISSUES
# Problems with existing tests that could cause flakiness or false positives
# ==============================================================================
test_quality_issues:
  # Flaky patterns - setTimeout without proper waiting
  - file: tests/unit/transport.test.ts
    issue: "Heavy use of setTimeout for timing-dependent tests"
    locations:
      - line: 148
      - line: 409
      - line: 424
      - line: 672
      - line: 720
      - line: 782
      - line: 818
      - line: 840
      - line: 886
      - line: 905
      - line: 942
      - line: 974
    fix: "Use event-based waiting or deterministic timing mocks"
    severity: high

  - file: tests/integration/unified-events.test.ts
    issue: "Math.random() in tests creates non-deterministic behavior"
    locations:
      - line: 45
      - line: 295
      - line: 297
      - line: 337
    fix: "Use fixed delays or seeded random for reproducibility"
    severity: medium

  - file: tests/unit/harness/control-flow.test.ts
    issue: "Hardcoded setTimeout delays make tests slow and potentially flaky"
    locations:
      - line: 316
      - line: 320
      - line: 348
      - line: 355
      - line: 362
      - line: 369
    fix: "Use smaller delays or mock timers"
    severity: medium

  - file: tests/replay/interactive-session.test.ts
    issue: "setTimeout delays throughout interactive tests"
    locations:
      - line: 82
      - line: 157
      - line: 209
      - line: 259
      - line: 277
      - line: 341
    fix: "Use proper async coordination instead of arbitrary delays"
    severity: medium

  - file: tests/unit/backoff.test.ts
    issue: "Tests using Date.now() for timing verification"
    locations:
      - line: 108
      - line: 118
    fix: "Use mock timers for deterministic testing"
    severity: low

  - file: tests/helpers/mock-monologue-llm.ts
    issue: "setTimeout in mock can cause flaky tests"
    locations:
      - line: 175
    fix: "Make latency configurable per-test, default to 0"
    severity: low

  # Potential false positives
  - file: tests/unit/factory/wrap-agent.test.ts
    issue: "Short setTimeout delays may not be sufficient on slow CI"
    locations:
      - line: 29
      - line: 51
    fix: "Use proper async completion detection"
    severity: low

  # Missing assertions
  - file: tests/integration/fluent-harness.test.ts
    issue: "Some tests verify counts but not content/ordering"
    locations:
      - "test 'complete harness lifecycle' only checks event count"
    fix: "Add assertions for event ordering and content"
    severity: low

# ==============================================================================
# DUPLICATE TEST COVERAGE
# Same functionality tested multiple times in different ways
# ==============================================================================
test_duplication:
  - description: "Transport attach/cleanup tested in multiple files"
    files:
      - tests/unit/transport.test.ts
      - tests/integration/fluent-harness.test.ts
    recommendation: "Keep comprehensive transport tests in transport.test.ts, simplify integration tests"

  - description: "Phase/task event emission tested redundantly"
    files:
      - tests/unit/harness.test.ts
      - tests/integration/fluent-harness.test.ts
      - tests/integration/unified-events.test.ts
    recommendation: "Consolidate into single integration test suite"

  - description: "Monologue service tested in multiple contexts"
    files:
      - tests/unit/monologue/monologue-service.test.ts
      - tests/unit/monologue/monologue-decorator.test.ts
      - tests/unit/monologue/mock-injection.test.ts
    recommendation: "Consider merging mock-injection tests into main service tests"

# ==============================================================================
# SUMMARY STATISTICS
# ==============================================================================
summary:
  total_source_files: 68
  source_files_with_tests: 26
  source_files_untested: 42
  test_coverage_percentage: 38

  flaky_test_count: 45
  math_random_usage: 4
  settimeout_in_tests: 45

  high_priority_untested: 10
  medium_priority_untested: 14
  low_priority_untested: 18

  test_only_utilities_to_move: 3

  recommended_actions:
    - "Add unit tests for replay-controller.ts and harness-recorder.ts"
    - "Add unit tests for provider agents (coding, planner, review)"
    - "Move test utilities to src/testing/ for SDK consumers"
    - "Replace setTimeout in tests with event-based coordination"
    - "Replace Math.random() with deterministic values in tests"
    - "Add missing edge case coverage for harness-instance.ts"
    - "Create snapshot tests for console-renderer.ts output"
