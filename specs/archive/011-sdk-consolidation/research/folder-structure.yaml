timestamp: "2025-12-28T06:30:00Z"
agent: structure-analyzer

# ============================================================================
# CURRENT STRUCTURE ANALYSIS
# ============================================================================

current_structure:
  src/:
    harness/:
      file_count: 26
      size_kb: ~180
      concerns:
        - events: [event-types.ts, event-context.ts, event-protocol.ts]
        - rendering: [base-renderer.ts, console-renderer.ts, composite-renderer.ts, define-renderer.ts, render-output.ts, renderer-interface.ts]
        - transport: [harness-instance.ts, session-context.ts, async-queue.ts]
        - state: [state.ts, task-state.ts]
        - task-execution: [task-harness.ts, task-harness-types.ts]
        - utilities: [backoff.ts, control-flow.ts, dependency-resolver.ts]
        - recording: [harness-recorder.ts, replay-controller.ts]
        - base-classes: [base-harness.ts, agent.ts]
        - types: [types.ts]
      notes: |
        CRITICAL: 26 files is too many for a single folder.
        Contains 6+ distinct concerns that are conflated.
        The "harness" folder has become a dumping ground.

    core/:
      file_count: 9
      concerns:
        - di: [container.ts, tokens.ts, decorators.ts]
        - events: [event-bus.ts, unified-event-bus.ts]
        - recording: [recording-factory.ts, vault.ts, replay-runner.ts]
        - unified-events/: [index.ts, types.ts, filter.ts]
      notes: |
        Reasonable structure but event-related code is split between
        core/unified-events/ and harness/event-*.ts

    factory/:
      file_count: 5
      concerns:
        - agent-creation: [agent-factory.ts, wrap-agent.ts]
        - harness-creation: [harness-factory.ts, define-harness.ts]
        - workflow: [workflow-builder.ts]
      notes: |
        Clean separation. Could be merged with core/ for discoverability.

    callbacks/:
      file_count: 2
      concerns:
        - callback-types: [types.ts, index.ts]
      notes: |
        Minimal - types only. Could be moved to types/ or core/.

    monologue/:
      file_count: 7
      concerns:
        - narrative-generation: [monologue-service.ts, monologue-decorator.ts]
        - llm-integration: [anthropic-llm.ts]
        - configuration: [prompts.ts, tokens.ts, types.ts]
      notes: |
        Well-scoped feature module. Good model for other features.

    workflow/:
      file_count: 2
      concerns:
        - orchestration: [orchestrator.ts, task-list.ts]
      notes: |
        Minimal. orchestrator.ts could move to core/.
        task-list.ts is utility.

    providers/:
      file_count: 15
      concerns:
        - anthropic/:
          - agents/: [base-anthropic-agent.ts, parser-agent.ts, planner-agent.ts, coding-agent.ts, review-agent.ts, validation-review-agent.ts, types.ts, index.ts]
          - runner/: [anthropic-runner.ts, base-agent.ts, event-mapper.ts, prompts.ts, models.ts, index.ts]
      notes: |
        Well-structured provider pattern. Could add opencode/ later.

    dashboard/:
      file_count: 0
      concerns:
        - components/: [empty]
        - utils/: [empty]
        - web/: [empty]
      notes: |
        DEAD CODE: Empty directory structure. Should be removed.

# ============================================================================
# MISPLACED FILES
# ============================================================================

misplaced_files:
  - file: src/harness/backoff.ts
    current: src/harness/
    should_be: src/utils/retry/
    reason: |
      Generic retry utility not harness-specific.
      Used by control-flow.ts but could be used anywhere.

  - file: src/harness/async-queue.ts
    current: src/harness/
    should_be: src/utils/async/
    reason: |
      Generic async FIFO queue data structure.
      Not harness-specific at all.

  - file: src/harness/dependency-resolver.ts
    current: src/harness/
    should_be: src/utils/graph/
    reason: |
      Generic topological sort / DAG utilities.
      Could be used for any dependency resolution.

  - file: src/harness/control-flow.ts
    current: src/harness/
    should_be: src/harness/helpers/ or src/utils/control-flow/
    reason: |
      retry() and parallel() helpers that emit events.
      Hybrid - emits harness events but logic is generic.
      Could stay if renamed to harness-control-flow.ts.

  - file: src/harness/event-context.ts
    current: src/harness/
    should_be: src/events/context.ts
    reason: |
      Defines EventContext, all event payload types.
      This IS the event system, not harness-specific.
      Currently re-exported from core/unified-events/types.ts (circular).

  - file: src/harness/event-types.ts
    current: src/harness/
    should_be: src/events/fluent-types.ts
    reason: |
      Fluent API event types (PhaseEvent, TaskEvent, etc).
      Separate from event-context.ts but related.

  - file: src/harness/event-protocol.ts
    current: src/harness/
    should_be: src/events/protocol.ts
    reason: |
      TaskHarness-specific event protocol.
      Could merge with event-context.ts or stay separate.

  - file: src/harness/define-renderer.ts
    current: src/harness/
    should_be: src/transports/define-transport.ts or src/rendering/define-renderer.ts
    reason: |
      Creates renderers that attach to event bus.
      Is about rendering/transports, not harness runtime.
      toAttachment() adapter lives here - transport concern.

  - file: src/harness/base-renderer.ts
    current: src/harness/
    should_be: src/rendering/base-renderer.ts
    reason: |
      Abstract base class for renderers.
      Rendering infrastructure, not harness runtime.

  - file: src/harness/console-renderer.ts
    current: src/harness/
    should_be: src/rendering/console-renderer.ts
    reason: |
      Console-based renderer implementation.
      Rendering infrastructure.

  - file: src/harness/composite-renderer.ts
    current: src/harness/
    should_be: src/rendering/composite-renderer.ts
    reason: |
      Combines multiple renderers.
      Rendering infrastructure.

  - file: src/harness/render-output.ts
    current: src/harness/
    should_be: src/rendering/output.ts
    reason: |
      Terminal output helpers (colors, unicode).
      Rendering infrastructure.

  - file: src/harness/renderer-interface.ts
    current: src/harness/
    should_be: src/rendering/types.ts
    reason: |
      IHarnessRenderer interface and related types.
      Rendering infrastructure.

  - file: src/harness/session-context.ts
    current: src/harness/
    should_be: src/session/context.ts or src/transports/session-context.ts
    reason: |
      Session/transport-related. Created for interactive workflows.
      More about transport architecture than harness runtime.

  - file: src/core/unified-events/types.ts
    current: src/core/unified-events/
    should_be: src/events/types.ts
    reason: |
      Currently RE-EXPORTS from harness/event-context.ts.
      This is inverted - types should be in events/, harness imports them.
      Creates confusing circular dependency pattern.

  - file: src/callbacks/types.ts
    current: src/callbacks/
    should_be: src/core/callbacks.ts or src/types/callbacks.ts
    reason: |
      Tiny module (2 files). Could be absorbed into core/.

# ============================================================================
# CROSS-CUTTING CONCERNS
# ============================================================================

cross_cutting_concerns:
  - name: Event System
    current_locations:
      - src/harness/event-types.ts (fluent API events)
      - src/harness/event-context.ts (context types, ALL base events)
      - src/harness/event-protocol.ts (TaskHarness events)
      - src/core/event-bus.ts (legacy event bus)
      - src/core/unified-event-bus.ts (unified bus implementation)
      - src/core/unified-events/ (re-exports, filter)
    problem: |
      Event types defined in harness/, implementation in core/,
      re-exports in core/unified-events/ that import from harness/.
      Circular and confusing.

  - name: Rendering/Transport
    current_locations:
      - src/harness/define-renderer.ts
      - src/harness/base-renderer.ts
      - src/harness/console-renderer.ts
      - src/harness/composite-renderer.ts
      - src/harness/render-output.ts
      - src/harness/renderer-interface.ts
      - src/harness/session-context.ts
    problem: |
      All in harness/ but none are about harness execution.
      They consume harness events but should be separate module.

  - name: Utilities
    current_locations:
      - src/harness/backoff.ts
      - src/harness/async-queue.ts
      - src/harness/dependency-resolver.ts
      - src/harness/control-flow.ts
    problem: |
      Generic utilities mixed with harness-specific code.
      No src/utils/ directory exists.

  - name: Types
    current_locations:
      - src/harness/types.ts
      - src/harness/task-harness-types.ts
      - src/core/tokens.ts (types + tokens)
      - src/callbacks/types.ts
      - src/monologue/types.ts
      - src/providers/anthropic/agents/types.ts
    problem: |
      Types scattered. Some in dedicated files, some mixed.
      No central type location for shared types.

# ============================================================================
# PROPOSED STRUCTURE
# ============================================================================

proposed_structure:
  src/:
    # -------------------------------------------------------------------------
    # CORE INFRASTRUCTURE (internal)
    # -------------------------------------------------------------------------
    core/:
      purpose: "DI container, configuration, shared infrastructure"
      files:
        - container.ts (DI container creation)
        - tokens.ts (all injection tokens)
        - decorators.ts (DI decorators)
      readme_sections: [purpose, tokens, container-usage]

    # -------------------------------------------------------------------------
    # EVENT SYSTEM (shared across all layers)
    # -------------------------------------------------------------------------
    events/:
      purpose: "Unified event types, bus, and utilities"
      files:
        - types.ts (ALL event types - consolidate from harness/event-context.ts)
        - bus.ts (UnifiedEventBus implementation - from core/unified-event-bus.ts)
        - filter.ts (event filtering - from core/unified-events/filter.ts)
        - fluent-types.ts (fluent API events - from harness/event-types.ts)
        - protocol.ts (TaskHarness protocol - from harness/event-protocol.ts, optional merge)
        - legacy-bus.ts (old EventBus - deprecation path, from core/event-bus.ts)
        - index.ts
      readme_sections:
        - overview
        - event-categories (workflow, agent, narrative, session)
        - subscribing
        - emitting
        - filtering
        - migration-from-legacy

    # -------------------------------------------------------------------------
    # HARNESS RUNTIME (core execution)
    # -------------------------------------------------------------------------
    harness/:
      purpose: "Harness execution runtime - what makes harnesses run"
      files:
        - base-harness.ts (abstract harness class)
        - agent.ts (lightweight agent wrapper)
        - state.ts (PersistentState)
        - task-state.ts (task state management)
        - task-harness.ts (TaskHarness implementation)
        - task-harness-types.ts (TaskHarness types/schemas)
        - harness-instance.ts (fluent API runtime)
        - control-flow.ts (phase/task/retry/parallel helpers)
        - index.ts
      readme_sections:
        - architecture
        - task-harness
        - fluent-api
        - state-management
        - event-emission

    # -------------------------------------------------------------------------
    # TRANSPORTS (output destinations)
    # -------------------------------------------------------------------------
    transports/:
      purpose: "Event consumers - renderers, loggers, API bridges"
      files:
        - types.ts (Transport, Attachment, IUnifiedRenderer interfaces)
        - define-renderer.ts (declarative renderer factory)
        - base-renderer.ts (abstract renderer base)
        - console-renderer.ts (console output)
        - composite-renderer.ts (multi-renderer)
        - session-context.ts (interactive session support)
        - output.ts (terminal output helpers - from render-output.ts)
        - index.ts
      readme_sections:
        - architecture
        - defining-renderers
        - built-in-renderers
        - attachments
        - session-mode

    # -------------------------------------------------------------------------
    # FACTORY (API surface)
    # -------------------------------------------------------------------------
    factory/:
      purpose: "Public API for creating harnesses and agents"
      files:
        - define-harness.ts (fluent harness factory)
        - harness-factory.ts (TaskHarness factory)
        - agent-factory.ts (agent creation)
        - wrap-agent.ts (agent wrapper)
        - workflow-builder.ts (workflow DSL)
        - index.ts
      readme_sections:
        - quick-start
        - define-harness
        - agents
        - workflows

    # -------------------------------------------------------------------------
    # RECORDING (replay infrastructure)
    # -------------------------------------------------------------------------
    recording/:
      purpose: "Recording and replay infrastructure for testing"
      files:
        - recorder.ts (from harness/harness-recorder.ts)
        - replay-controller.ts (from harness/replay-controller.ts)
        - replay-runner.ts (from core/replay-runner.ts)
        - vault.ts (from core/vault.ts)
        - factory.ts (from core/recording-factory.ts)
        - index.ts
      readme_sections:
        - architecture
        - recording-sessions
        - replay-mode
        - test-integration

    # -------------------------------------------------------------------------
    # PROVIDERS (LLM implementations)
    # -------------------------------------------------------------------------
    providers/:
      purpose: "LLM provider implementations"
      anthropic/:
        agents/:
          - base-anthropic-agent.ts
          - parser-agent.ts
          - planner-agent.ts
          - coding-agent.ts
          - review-agent.ts
          - validation-review-agent.ts
          - types.ts
          - index.ts
        runner/:
          - anthropic-runner.ts
          - base-agent.ts
          - event-mapper.ts
          - prompts.ts
          - models.ts
          - index.ts
        - index.ts
      readme_sections:
        - adding-providers
        - anthropic-agents
        - runner-architecture

    # -------------------------------------------------------------------------
    # UTILITIES (shared helpers)
    # -------------------------------------------------------------------------
    utils/:
      purpose: "Generic utilities not tied to harness/events"
      files:
        - async-queue.ts (from harness/async-queue.ts)
        - backoff.ts (from harness/backoff.ts)
        - dependency-resolver.ts (from harness/dependency-resolver.ts)
        - index.ts
      readme_sections:
        - async-queue
        - backoff
        - dependency-graph

    # -------------------------------------------------------------------------
    # MONOLOGUE (feature module)
    # -------------------------------------------------------------------------
    monologue/:
      purpose: "LLM-generated narrative summaries"
      files: [unchanged - well-structured]
      readme_sections: [architecture, usage, configuration]

    # -------------------------------------------------------------------------
    # WORKFLOW (minimal)
    # -------------------------------------------------------------------------
    workflow/:
      purpose: "Workflow orchestration utilities"
      files:
        - orchestrator.ts
        - task-list.ts
        - index.ts
      notes: Consider merging into harness/ or factory/

    # -------------------------------------------------------------------------
    # CALLBACKS (merge candidate)
    # -------------------------------------------------------------------------
    callbacks/:
      purpose: "Agent callback interfaces"
      files:
        - types.ts
        - index.ts
      notes: |
        MERGE CANDIDATE: Only 2 files. Could move to:
        - core/callbacks.ts
        - providers/anthropic/callbacks.ts (if anthropic-specific)

    # -------------------------------------------------------------------------
    # ROOT
    # -------------------------------------------------------------------------
    index.ts:
      purpose: "Public API re-exports"
      notes: |
        Should only re-export from module indexes.
        No direct file imports.

# ============================================================================
# MIGRATION STEPS
# ============================================================================

migration_steps:
  # Phase 1: Create new directories
  - action: mkdir
    path: src/events

  - action: mkdir
    path: src/transports

  - action: mkdir
    path: src/recording

  - action: mkdir
    path: src/utils

  # Phase 2: Move event system (highest impact, do first)
  - action: move
    from: src/harness/event-context.ts
    to: src/events/types.ts
    notes: |
      This is the AUTHORITATIVE source of event types.
      Update all imports.

  - action: move
    from: src/harness/event-types.ts
    to: src/events/fluent-types.ts

  - action: move
    from: src/harness/event-protocol.ts
    to: src/events/protocol.ts
    notes: Consider merging into types.ts

  - action: move
    from: src/core/unified-event-bus.ts
    to: src/events/bus.ts

  - action: move
    from: src/core/unified-events/filter.ts
    to: src/events/filter.ts

  - action: move
    from: src/core/event-bus.ts
    to: src/events/legacy-bus.ts
    notes: Mark as deprecated

  - action: delete
    path: src/core/unified-events/
    notes: Now empty after moves

  # Phase 3: Move transports/rendering
  - action: move
    from: src/harness/define-renderer.ts
    to: src/transports/define-renderer.ts

  - action: move
    from: src/harness/base-renderer.ts
    to: src/transports/base-renderer.ts

  - action: move
    from: src/harness/console-renderer.ts
    to: src/transports/console-renderer.ts

  - action: move
    from: src/harness/composite-renderer.ts
    to: src/transports/composite-renderer.ts

  - action: move
    from: src/harness/render-output.ts
    to: src/transports/output.ts

  - action: move
    from: src/harness/renderer-interface.ts
    to: src/transports/types.ts

  - action: move
    from: src/harness/session-context.ts
    to: src/transports/session-context.ts

  # Phase 4: Move utilities
  - action: move
    from: src/harness/async-queue.ts
    to: src/utils/async-queue.ts

  - action: move
    from: src/harness/backoff.ts
    to: src/utils/backoff.ts

  - action: move
    from: src/harness/dependency-resolver.ts
    to: src/utils/dependency-resolver.ts

  # Phase 5: Move recording
  - action: move
    from: src/harness/harness-recorder.ts
    to: src/recording/recorder.ts

  - action: move
    from: src/harness/replay-controller.ts
    to: src/recording/replay-controller.ts

  - action: move
    from: src/core/replay-runner.ts
    to: src/recording/replay-runner.ts

  - action: move
    from: src/core/vault.ts
    to: src/recording/vault.ts

  - action: move
    from: src/core/recording-factory.ts
    to: src/recording/factory.ts

  # Phase 6: Cleanup
  - action: delete
    path: src/dashboard/
    notes: Empty directory - dead code

  - action: update
    path: src/index.ts
    notes: Update all re-exports to use new paths

  - action: create
    path: src/events/index.ts
    notes: Create module index

  - action: create
    path: src/transports/index.ts
    notes: Create module index

  - action: create
    path: src/recording/index.ts
    notes: Create module index

  - action: create
    path: src/utils/index.ts
    notes: Create module index

# ============================================================================
# BREAKING CHANGES
# ============================================================================

breaking_changes:
  - change: Event type imports
    before: import { EventContext } from "./harness/event-context"
    after: import { EventContext } from "./events"
    mitigation: |
      Add re-exports to harness/index.ts for deprecation period.

  - change: Renderer imports
    before: import { defineRenderer } from "./harness"
    after: import { defineRenderer } from "./transports"
    mitigation: |
      Add re-exports to harness/index.ts for deprecation period.

  - change: Utility imports
    before: import { AsyncQueue } from "./harness/async-queue"
    after: import { AsyncQueue } from "./utils"
    mitigation: |
      Add re-exports to harness/index.ts for deprecation period.

# ============================================================================
# METRICS
# ============================================================================

metrics:
  current:
    harness_file_count: 26
    core_file_count: 9
    total_src_files: 67
    concerns_per_folder:
      harness: 6
      core: 3
      factory: 3

  proposed:
    harness_file_count: 10
    events_file_count: 7
    transports_file_count: 8
    recording_file_count: 5
    utils_file_count: 3
    concerns_per_folder:
      harness: 1 # runtime only
      events: 1 # event system only
      transports: 1 # rendering/output only
      recording: 1 # replay only
      utils: 1 # generic utilities

  improvement:
    harness_reduction: 62%
    new_modules_with_single_concern: 5
    files_requiring_move: 21
    estimated_import_updates: 150-200

# ============================================================================
# RECOMMENDATIONS
# ============================================================================

recommendations:
  immediate:
    - Remove empty dashboard/ directory
    - Move async-queue.ts and backoff.ts to src/utils/ (low risk)

  high_priority:
    - Consolidate event types into src/events/ (eliminates circular imports)
    - Extract rendering to src/transports/ (clear separation)

  medium_priority:
    - Extract recording to src/recording/
    - Add README.md to each new module

  low_priority:
    - Merge callbacks/ into core/
    - Evaluate merging workflow/ into harness/

  defer:
    - Renaming "transports" vs "rendering" - either works
    - Major re-export changes (deprecation period first)
