# Retrospective: 003-harness-renderer

**Date**: 2025-12-26
**Severity**: Critical
**Feature**: 003-harness-renderer

---

## Executive Summary

Implementation failed due to prototype-driven development that bypassed specification. Core feature (monologue module) completely skipped, architectural boundaries violated, and no verification gates prevented divergence.

**Key Metrics:**
- 25 paths checked: 6 correct, 11 missing, 3 wrong location
- 11 requirements: 3 compliant (27%), 8 missing (73%)
- Tests: 3 pass, 2 fail, 1 error
- Root causes: 5 identified

---

## Root Causes

### RC001: Prototype in context caused architectural divergence

Agent accessed working prototype in `listr2/examples/harness-renderer` from Dec 25 and ported its structure instead of following specification task paths.

**Evidence**:
- timeline.yaml: Prototype files created Dec 25 23:48-23:55, 5 hours before implementation
- file-audit.yaml: Renderer files in `harness/` not `renderer/`
- spec-drift.yaml: AD001 - Renderer code merged into harness instead of separate module
- plan.md:154: Explicitly states `renderer/` should be separate from `harness/`

**Severity**: Critical

---

### RC002: Monologue module completely skipped - core feature unimplemented

13+ tasks for monologue generator, decorator, prompts, and configuration were not implemented at all. Directory created but empty.

**Evidence**:
- file-audit.yaml: All monologue files missing (FA009-FA017)
- spec-drift.yaml: AD002 - Core feature (P1 user story) completely unimplemented
- timeline.yaml: Monologue directory created but ZERO files implemented

**Severity**: Critical

---

### RC003: Spec-kit /implement has no verification gates

Implementation command allowed commit despite wrong module paths, missing core features, failing tests, and unmarked tasks.

**Evidence**:
- timeline.yaml: No step to verify tasks marked complete, no test execution gate
- file-audit.yaml: 25 paths checked, only 6 correct, 11 missing, 3 wrong location
- test-results.yaml: 2 fail, 1 error - not caught by validate command

**Severity**: Critical

---

### RC004: Manual narrative emission bypassed decorator architecture

Implementation used hardcoded `TaskHarness.emitNarrative()` calls instead of `@AnthropicMonologue` decorator system.

**Evidence**:
- spec-drift.yaml: Manual narrative calls at 8+ locations in TaskHarness
- Specified approach: Agent callbacks buffered -> LLM generates narrative -> emitted automatically
- Actual approach: Hardcoded strings passed to `emitNarrative()`

**Severity**: High

---

### RC005: Tasks.md path specifications ignored

50+ tasks with explicit file paths (e.g., `packages/sdk/src/renderer/protocol.ts`) were not followed.

**Evidence**:
- file-audit.yaml: Expected `renderer/protocol.ts`, found `harness/event-protocol.ts`
- plan.md:154: Structure Decision explicitly defines module separation

**Severity**: High

---

## Responsibility Attribution

| Component | Responsibility | Evidence |
|-----------|----------------|----------|
| Implementing Agent | Made unauthorized architectural decisions, skipped core feature | Merged renderer into harness/, created empty monologue/, unmarked tasks |
| Spec-Kit /implement | No path verification, no test gate | 2 failures + 1 error not caught |
| Spec-Kit /validate | Too shallow - no path or test checks | Validate passed but tests failing |
| Context/Environment | Prototype accessible during implementation | listr2/examples/harness-renderer from 12/25 |

---

## Remediation

### Immediate Actions
- Decide: Move renderer files to `src/renderer/` OR update spec to accept current architecture
- Implement monologue module completely (types.ts, prompts.ts, generator.ts, decorator.ts, index.ts)
- Fix test failures: ParserAgent validation error, CodingAgent timeout, ReviewAgent unhandled error
- Mark completed tasks in tasks.md

### Process Improvements
- Add file path verification to /implement command
- Add test execution gate to /implement command
- Add task completion verification to /implement command
- Enhance /validate command with deeper checks
- Isolate prototypes during spec-driven development

---

## Investigation Artifacts

- Timeline: `retro/timeline.yaml`
- File Audit: `retro/file-audit.yaml`
- Test Results: `retro/test-results.yaml`
- Spec Drift: `retro/spec-drift.yaml`
- Synthesis: `retro/synthesis.yaml`

---

## Pattern Detected

**prototype-driven-divergence**: Agent had access to working prototype code from prior spike/exploration. When implementing feature per specification, agent defaulted to familiar prototype structure instead of following spec task paths.

---

**Generated by**: /oharnes.retro
**Date**: 2025-12-26T07:20:00Z
**Estimated Recovery Effort**: 37-41 hours
