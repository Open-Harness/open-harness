investigation_type: spec_drift
feature: 003-harness-renderer
spec_directory: /Users/abuusama/projects/dao/dao-spec-kit/specs/003-harness-renderer
timestamp: 2025-12-26T07:17:00Z

summary:
  total_requirements: 11
  compliant: 3
  partial: 0
  divergent: 0
  missing: 8
  compliance_rate: 27%

architectural_drifts:
  - id: AD001
    title: Renderer Module Location
    severity: critical
    specified:
      source: plan.md:154
      text: "Provider-agnostic code (harness/, renderer/, core/) separate from provider-specific code"
    actual: Renderer code merged into src/harness/ directory
    evidence:
      - Found: src/harness/console-renderer.ts
      - Found: src/harness/base-renderer.ts
      - Found: src/harness/renderer-interface.ts
      - Missing: src/renderer/ module entirely
    impact: Violates modular architecture pattern from plan.md:85-91

  - id: AD002
    title: Monologue System Missing
    severity: critical
    specified:
      source: plan.md:102-113
      text: Complete monologue module with generator, decorator, prompts, types
    actual: No monologue directory exists
    evidence:
      - No @AnthropicMonologue decorator found
      - No AnthropicMonologueGenerator class found
      - Only found template file: src/providers/anthropic/agents/monologue.prompt.md
    impact: Core feature (P1 user story) completely unimplemented

  - id: AD003
    title: Subpath Exports Missing
    severity: high
    specified:
      source: plan.md:209
      text: Subpath exports for ./anthropic, ./renderer, ./renderer/listr2
    actual: package.json shows only default "." export
    evidence:
      - No exports field with subpaths in package.json
    impact: Cannot tree-shake unused code, defeats modular import pattern

  - id: AD004
    title: Listr2 Renderer Missing
    severity: medium
    specified:
      source: plan.md:91
      text: Listr2HarnessRenderer with peer dependency
    actual: No listr2 renderer, no listr2 peer dependency
    evidence:
      - No Listr2HarnessRenderer class
      - No listr2 in peerDependencies
    impact: Optional integration feature not available

functional_requirements:
  compliant:
    - id: FR-002
      description: Task narrative events include agent name, task ID, timestamp, text
      evidence: packages/sdk/src/harness/event-protocol.ts:152-157

    - id: FR-003
      description: Supports sync/async renderer implementations
      evidence: IHarnessRenderer.initialize() and finalize() return void | Promise<void>

    - id: FR-004
      description: Provides default renderer out-of-box
      evidence: ConsoleRenderer at packages/sdk/src/harness/console-renderer.ts

  missing:
    - id: FR-001
      description: Convert onMonologue callbacks to task:narrative events
      reason: No @AnthropicMonologue decorator exists
      note: Narratives are hardcoded in TaskHarness, not decorator-driven

    - id: FR-005
      description: Renderer selection at initialization
      reason: TaskHarness.setRenderer() exists but not in constructor/config
      note: plan.md:197 specifies adding to TaskHarnessConfig

    - id: FR-006
      description: Propagate monologue config
      reason: No decorator/generator system

    - id: FR-007
      description: Maintain narrative history
      reason: Data structure exists but no generator

    - id: FR-008
      description: Handle wait signal
      reason: No buffering system

    - id: FR-009
      description: Final flush on completion
      reason: No buffer

    - id: FR-010
      description: Live/replay mode
      reason: Infrastructure exists but not integrated

    - id: FR-011
      description: Custom system prompts
      reason: No generator

implementation_approach_divergence:
  specified:
    description: Decorator-driven monologue system
    mechanism: "@AnthropicMonologue intercepts agent callbacks, buffers events, calls LLM to generate narratives, emits task:narrative events"

  actual:
    description: Manual narrative emission
    mechanism: "TaskHarness.emitNarrative() called with hardcoded strings throughout task execution"
    locations:
      - packages/sdk/src/harness/task-harness.ts:195
      - packages/sdk/src/harness/task-harness.ts:215
      - packages/sdk/src/harness/task-harness.ts:240
      - packages/sdk/src/harness/task-harness.ts:263
      - packages/sdk/src/harness/task-harness.ts:405
      - packages/sdk/src/harness/task-harness.ts:525
      - packages/sdk/src/harness/task-harness.ts:583
      - packages/sdk/src/harness/task-harness.ts:588
      - packages/sdk/src/harness/task-harness.ts:878-903

  example:
    actual_code: 'this.emitNarrative("Coder", `Working on ${task.id}: ${task.description.substring(0, 50)}...`, task.id, callbacks);'
    specified_approach: "Agent callbacks buffered → LLM generates narrative → emitted automatically"
