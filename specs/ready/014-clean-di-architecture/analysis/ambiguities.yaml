agent: ambiguity-checker
timestamp: "2025-12-29T12:00:00Z"
feature_dir: specs/ready/014-clean-di-architecture
summary: "489 items checked. 8 ambiguities found (0 critical, 5 medium, 3 low)."
statistics:
  items_checked: 489
  vague_terms: 4
  placeholders: 0
  unmeasurable: 4
  total_findings: 8
  severity_breakdown:
    critical: 0
    medium: 5
    low: 3

findings:
  - id: A001
    type: unmeasurable
    location: spec.md:L54
    text: "behaves identically to preset agents (identical behaviors: uses AgentBuilder.build(), emits events via IUnifiedEventBus, accepts same ExecuteOptions, returns same ExecutableAgent interface)"
    issue: "While specific behaviors are listed, 'identically' is difficult to verify in practice - no explicit test strategy mentioned"
    recommendation: "Add explicit verification: 'T028-T031 verify custom agents pass the same integration test suite as preset agents (PlannerAgent, CodingAgent, ReviewAgent). Tests must verify: (1) Builder construction path identical, (2) Event emission pattern matches, (3) ExecuteOptions handling identical, (4) Return type structure matches.'"
    severity: medium

  - id: A002
    type: unmeasurable
    location: spec.md:L135
    text: "Clear separation between agent definition (data) and agent execution (service) - verified by: definition contains zero methods (only data fields), is JSON-serializable (see plan.md 'Pattern Index')"
    issue: "'Clear' is subjective even with verification criteria - what about edge cases with getters/setters or computed properties?"
    recommendation: "Strengthen verification: 'Agent definition types must: (1) Contain zero methods or functions (TypeScript error on method properties), (2) Pass JSON.stringify() without data loss (round-trip test), (3) Have no getters/setters (plain object properties only), (4) Generate .d.ts with only data properties.'"
    severity: medium

  - id: A003
    type: vague_term
    location: plan.md:L209
    text: "IntelliSense Surface: Main API objects expose <10 methods to users"
    issue: "What qualifies as 'main API objects' is ambiguous - does this count all exported types or just entry points?"
    recommendation: "Define scope explicitly: 'Main API objects = executeAgent function, streamAgent function, Harness class instance, and preset agent definition objects (PlannerAgent, CodingAgent, ReviewAgent). Verification: Count publicly accessible methods in generated .d.ts for these symbols only. Internal types (AgentBuilder, Container) excluded.'"
    severity: medium

  - id: A004
    type: unmeasurable
    location: plan.md:L217
    text: "IDE autocomplete shows only relevant user-facing methods"
    issue: "'Only relevant' and 'user-facing' require subjective judgment - no objective verification method"
    recommendation: "Replace with measurable criterion aligned with FR-016: 'Generated .d.ts files for package exports (index.ts) contain zero DI-related types in public signatures (no Container, injectable decorator, or Token types visible to autocomplete). Verify using: tsc --declaration && grep -E \"Container|injectable|Token\" dist/*.d.ts (expect zero matches).'"
    severity: medium

  - id: A005
    type: unmeasurable
    location: tasks.md:L10
    text: "Tests are NOT requested in this feature specification. All testing happens through existing test suites."
    issue: "Contradicts Phase 6 (T032-T043) which creates 12+ new test files for DI compliance, builder unit tests, and verification"
    recommendation: "Clarify statement: 'No new test INFRASTRUCTURE is required (existing bun:test framework sufficient). Phase 6 adds new test CASES and test FILES for DI compliance verification, but uses existing tooling. See T032-T043 for specific test files to create.'"
    severity: medium

  - id: A006
    type: unmeasurable
    location: tasks.md:L117
    text: "T017 [US1] Verify executeAgent() works with PlannerAgent definition in manual test"
    issue: "'Works' has no acceptance criteria - successful execution? Correct output? Type safety?"
    recommendation: "Define verification steps explicitly: 'Manual test must verify: (1) Import succeeds: `import { PlannerAgent, executeAgent } from \"@openharness/anthropic\"`, (2) Execution completes: `const result = await executeAgent(PlannerAgent, { prd: \"test\" })`, (3) Typed output received: result has expected shape/type, (4) No DI concepts required: user code contains zero references to Container/tokens/builder.'"
    severity: low

  - id: A007
    type: unmeasurable
    location: tasks.md:L118
    text: "T018 [US1] Verify streamAgent() works with preset agents in manual test"
    issue: "Same as A006 - 'works' is not objectively defined"
    recommendation: "Define verification steps: '(1) Call streamAgent with preset: `const handle = streamAgent(CodingAgent, input)`, (2) Iterate chunks: `for await (const chunk of handle) { ... }`, (3) Assert stream completes without errors, (4) Verify cancellation works: `handle.cancel()`.'"
    severity: low

  - id: A008
    type: vague_term
    location: plan.md:L30
    text: "Simplicity Scales: Solution uses plain objects (simplest possible) + standard builder pattern"
    issue: "'Simplest possible' is subjective without comparison to alternatives"
    recommendation: "Add objective verification from plan.md:L118-120: 'Agent definitions require zero runtime dependencies beyond Zod schemas. Verification: Analyze import statements in definition type files - must import only from \"zod\" and internal type-only imports (no runtime dependencies on SDK or DI framework).'"
    severity: low

resolved_by_recent_fixes:
  - id: FIXED-001
    finding: "spec.md:L14 - 'rapid prototyping' time measurement ambiguous"
    resolution: "Now explicitly defined as '<5 minutes from npm install to first successful agent execution, excluding documentation reading time, measured wall-clock time'"
    location: "spec.md:L14"
    status: "RESOLVED"

  - id: FIXED-002
    finding: "spec.md:L14 - 'simple use cases' LOC counting unclear"
    resolution: "Now precisely defined as '<100 lines of code for single-agent workflows, counting only application code excluding imports, type definitions, and comments'"
    location: "spec.md:L14"
    status: "RESOLVED"

  - id: FIXED-003
    finding: "spec.md:L22 - 'real-time agent progress events' latency undefined"
    resolution: "Now cross-references plan.md 'Real-Time Event Delivery' with concrete definition: asynchronous/non-blocking delivery with <100ms p95 latency"
    location: "spec.md:L22, plan.md:L156-164"
    status: "RESOLVED"

  - id: FIXED-004
    finding: "spec.md:L22 - 'clear Zod validation error' subjective"
    resolution: "Now cross-references plan.md 'Error Message Clarity' with 3-part structure: field name + expected type + actual value"
    location: "spec.md:L22, plan.md:L83-93"
    status: "RESOLVED"

  - id: FIXED-005
    finding: "spec.md:L52 - 'TypeScript enforces type safety' mechanism unclear"
    resolution: "Now references plan.md:L124-143 'Type Safety Enforcement' with compile-time verification method using tsc --noEmit and T052 negative tests"
    location: "spec.md:L52 (cross-ref added), plan.md:L124-143"
    status: "RESOLVED"

  - id: FIXED-006
    finding: "spec.md:L128 - 'Documentation clearly explains' too vague"
    resolution: "Now includes verification checklist with 5 objective items: API boundary diagram, exported types docs, before/after samples, decision guide, migration examples (see plan.md L183-200)"
    location: "spec.md:L128, plan.md:L183-200"
    status: "RESOLVED"

  - id: FIXED-007
    finding: "plan.md:L20 - 'cold start' performance measurement unclear"
    resolution: "Now precisely defined: 'First container creation after process start, before any require/import caching. Measurement protocol: Create container in fresh process (new bun test invocation), measure time from new Container() to first .get() call'"
    location: "plan.md:L76-78"
    status: "RESOLVED"

  - id: FIXED-008
    finding: "plan.md:L158 - 'real-time' could imply hard real-time guarantees"
    resolution: "Clarified with explicit note: 'Real-time refers to asynchronous streaming without blocking the agent execution thread, not hard real-time guarantees. <100ms p95 latency target.'"
    location: "plan.md:L156-164"
    status: "RESOLVED"

recommendations:
  priority_fixes:
    - issue: A005
      action: "Clarify testing statement in tasks.md:L10 - specify 'new test CASES, not new test INFRASTRUCTURE' to eliminate contradiction with Phase 6"
      effort: "5 minutes"
      impact: "high - eliminates major confusion about testing scope"
      file: "tasks.md"

    - issue: A006_A007
      action: "Add explicit acceptance criteria to T017 and T018 manual verification tasks"
      effort: "10 minutes"
      impact: "medium - makes verification reproducible and objective"
      file: "tasks.md"

  optional_improvements:
    - issue: A003_A004
      action: "Define 'main API objects' scope and convert IntelliSense/autocomplete criteria to measurable .d.ts analysis aligned with FR-016"
      effort: "15 minutes"
      impact: "medium - strengthens developer experience verification"
      file: "plan.md"

    - issue: A001
      action: "Add explicit test verification strategy to spec.md:L54 - reference T028-T031 and specify that custom agents must pass same integration test suite"
      effort: "10 minutes"
      impact: "low - improves traceability but behavior already well-specified"
      file: "spec.md"

    - issue: A002
      action: "Strengthen 'clear separation' verification with additional constraints: no getters/setters, TypeScript errors on method properties"
      effort: "10 minutes"
      impact: "low - current verification already strong, this adds defense-in-depth"
      file: "spec.md"

quality_assessment:
  overall_score: 92
  strengths:
    - "Zero critical ambiguities - all blocking requirements are well-defined"
    - "Zero placeholders (TODO, TBD) - specification is complete"
    - "Excellent measurement protocols for performance metrics (p95, wall-clock, cold start definitions)"
    - "Strong cross-referencing between spec.md and plan.md for complex terms"
    - "All technical requirements have objective verification methods (grep patterns, test tasks, metrics)"
    - "Recent fixes successfully resolved 8 previously identified ambiguities"

  weaknesses:
    - "Some verification tasks (T017, T018) lack explicit acceptance criteria"
    - "Developer experience metrics (IntelliSense, autocomplete) need more precise definitions"
    - "Minor contradictions between high-level statements (tasks.md:L10) and detailed tasks (Phase 6)"
    - "A few subjective quality terms ('clear', 'simplest') could use stronger objective verification"

  implementation_readiness: "READY"
  reasoning: "All P1 user stories (1 and 2) have unambiguous requirements with clear verification methods. P2 stories (3 and 4) have minor ambiguities but they are low-severity clarifications, not blockers. The 8 remaining findings are improvements to verification methodology, not gaps in core requirements."

notes:
  - "SIGNIFICANT IMPROVEMENT from previous analysis: 8 major ambiguities resolved through cross-referencing and concrete thresholds"
  - "All performance requirements now have precise measurement protocols (wall-clock time, p95 latency, cold start definition)"
  - "Quality attributes ('clear', 'simple', 'real-time') now cross-reference plan.md definitions with verification checklists"
  - "LOC counting and time measurements now precisely specify what to include/exclude"
  - "Medium-severity findings are primarily about test verification steps and DX metrics - important for quality but not blocking"
  - "The plan.md Verification Methods section (L44-L242) provides excellent objective criteria that resolve most spec.md vagueness"
  - "Pattern Index (plan.md:L227-241) clarifies intentional near-duplicates, preventing false duplicate detection"
  - "Constitution Check (plan.md:L24-42) provides clear pass/fail criteria for architectural principles"
