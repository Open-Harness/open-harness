# Implementation Plan: Harness Renderer Integration

**Branch**: `003-harness-renderer` | **Date**: 2025-12-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-harness-renderer/spec.md`

## Summary

Integrate the SDK's monologue generation system with a pluggable harness renderer architecture. The implementation adds:

1. **Monologue module** (`src/monologue/`) - `@AnthropicMonologue` decorator that generates human-readable narratives from agent events
2. **Renderer module** (`src/renderer/`) - `IHarnessRenderer` interface and built-in implementations (SimpleConsoleRenderer, Listr2HarnessRenderer)
3. **TaskHarness integration** - Accept renderer config, translate callbacks to renderer events
4. **Documentation** - Architecture guide, renderer guide for v0.1.0 readiness

See [research.md](./research.md) for architectural decisions.

---

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Primary Dependencies**: @anthropic-ai/claude-agent-sdk, @needle-di/core, zod, listr2 (optional peer)
**Storage**: N/A (state in memory, recordings to filesystem)
**Testing**: bun test
**Target Platform**: Node.js 20+
**Project Type**: Single package (monorepo structure: `packages/sdk/`)
**Performance Goals**: Narrative generation <200ms, rendering <16ms frame budget
**Constraints**: Must not break existing SDK users, listr2 optional
**Scale/Scope**: SDK v0.1.0 with renderer extensibility

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| **I. Type Safety First** | ✅ PASS | All contracts use explicit types, discriminated unions for events, Zod schemas |
| **II. Verified by Reality** | ✅ PASS | Will capture golden recordings for monologue output, live integration tests planned |
| **III. DI Discipline** | ✅ PASS | Follows @Record decorator pattern, uses IMonologueGeneratorToken, factories hide DI |

**No violations requiring justification.**

---

## Project Structure

### Documentation (this feature)

```text
specs/003-harness-renderer/
├── plan.md              # This file
├── research.md          # Architectural decisions
├── data-model.md        # Type definitions
├── quickstart.md        # User guide
├── contracts/           # Interface contracts
│   ├── renderer-interface.ts
│   ├── event-protocol.ts
│   └── monologue-config.ts
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
packages/sdk/src/
├── core/                            # Infrastructure (provider-agnostic)
│   ├── container.ts                # DI container
│   ├── tokens.ts                   # DI tokens
│   ├── decorators.ts               # Base decorator utilities
│   └── index.ts
│
├── harness/                         # Orchestration (provider-agnostic)
│   ├── base-harness.ts
│   ├── task-harness.ts             # + renderer config
│   ├── task-harness-types.ts       # + renderer?: IHarnessRenderer
│   ├── task-state.ts
│   ├── harness-recorder.ts
│   ├── state.ts
│   ├── dependency-resolver.ts
│   ├── types.ts
│   └── index.ts
│
├── renderer/                        # NEW - Visualization (provider-agnostic)
│   ├── protocol.ts                 # HarnessEvent types
│   ├── interface.ts                # IHarnessRenderer
│   ├── base-renderer.ts            # BaseHarnessRenderer
│   ├── simple.ts                   # SimpleConsoleRenderer
│   ├── listr2.ts                   # Listr2HarnessRenderer
│   └── index.ts
│
├── providers/                       # ALL PROVIDER-SPECIFIC CODE
│   ├── anthropic/                  # @openharness/sdk/anthropic
│   │   ├── agents/                 # MOVED from src/agents/
│   │   │   ├── base-agent.ts       # BaseAnthropicAgent
│   │   │   ├── coding-agent.ts
│   │   │   ├── parser-agent.ts
│   │   │   ├── review-agent.ts
│   │   │   ├── validation-review-agent.ts
│   │   │   └── index.ts
│   │   ├── monologue/              # NEW
│   │   │   ├── generator.ts        # AnthropicMonologueGenerator
│   │   │   ├── prompts.ts          # DEFAULT, TERSE, VERBOSE
│   │   │   ├── decorator.ts        # @AnthropicMonologue
│   │   │   ├── types.ts
│   │   │   └── index.ts
│   │   ├── runner/                 # MOVED from src/runner/
│   │   │   ├── runner.ts           # AnthropicRunner
│   │   │   ├── replay-runner.ts
│   │   │   ├── event-mapper.ts
│   │   │   └── index.ts
│   │   └── index.ts                # Re-exports all anthropic
│   │
│   └── openai/                     # FUTURE - @openharness/sdk/openai
│       └── index.ts                # Placeholder
│
├── callbacks/                       # Cross-cutting types
│   ├── types.ts                    # IAgentCallbacks
│   └── index.ts
│
├── factory/                         # User-facing factories
│   ├── harness-factory.ts          # createTaskHarness
│   ├── agent-factory.ts            # createAgent
│   └── index.ts
│
├── workflow/                        # Task orchestration
│   ├── task-list.ts
│   ├── orchestrator.ts
│   └── index.ts
│
└── index.ts                         # Main entry (re-exports)

tests/
├── unit/
│   ├── providers/anthropic/
│   │   ├── monologue/
│   │   │   ├── generator.test.ts
│   │   │   └── decorator.test.ts
│   │   └── agents/
│   └── renderer/
│       ├── simple.test.ts
│       └── protocol.test.ts
├── integration/
│   └── harness-renderer.test.ts
└── recordings/golden/
    └── monologue/                   # Golden recordings for narratives

docs/
├── architecture.md                  # NEW - System design
└── renderer-guide.md                # NEW - Renderer usage/extension
```

**Structure Decision**: Single package with provider namespaces. Provider-agnostic code (`harness/`, `renderer/`, `core/`) is separate from provider-specific code (`providers/anthropic/`, `providers/openai/`). Subpath exports enable tree-shaking and explicit provider selection.

---

## Implementation Phases

### Phase 0: Restructure (Provider Namespaces)

Move existing code to provider namespaces structure.

| Task | Files | Description |
|------|-------|-------------|
| 0.1 | `src/providers/anthropic/` | Create directory structure |
| 0.2 | `src/agents/` → `src/providers/anthropic/agents/` | Move all agent files |
| 0.3 | `src/runner/` → `src/providers/anthropic/runner/` | Move runner files |
| 0.4 | Update all imports | Fix import paths across codebase |
| 0.5 | `src/providers/anthropic/index.ts` | Create provider barrel export |
| 0.6 | Fix orphaned exports | Remove `withMonologue` from index.ts |
| 0.7 | `bun test` | Verify no regressions |

### Phase 1: Foundation (No Dependencies)

Create base infrastructure without modifying existing code.

| Task | Files | Description |
|------|-------|-------------|
| 1.1 | `src/renderer/protocol.ts` | Port HarnessEvent types from spike |
| 1.2 | `src/renderer/interface.ts` | IHarnessRenderer interface |
| 1.3 | `src/renderer/base-renderer.ts` | BaseHarnessRenderer with state tracking |
| 1.4 | `src/providers/anthropic/monologue/types.ts` | MonologueConfig, MonologueMetadata |
| 1.5 | `src/providers/anthropic/monologue/prompts.ts` | Default, terse, verbose prompts |

### Phase 2: Core Implementation

Implement monologue generation and TaskHarness integration.

| Task | Files | Description |
|------|-------|-------------|
| 2.1 | `src/core/tokens.ts` | Add IMonologueGeneratorToken |
| 2.2 | `src/providers/anthropic/monologue/generator.ts` | AnthropicMonologueGenerator service |
| 2.3 | `src/providers/anthropic/monologue/decorator.ts` | @AnthropicMonologue decorator |
| 2.4 | `src/core/container.ts` | Register generator in DI container |
| 2.5 | `src/harness/task-harness-types.ts` | Add renderer to TaskHarnessConfig |
| 2.6 | `src/harness/task-harness.ts` | Emit events to renderer, handle callbacks |
| 2.7 | `src/providers/anthropic/monologue/index.ts` | Export monologue module |

### Phase 3: Renderers & Exports

Port renderers and setup subpath exports.

| Task | Files | Description |
|------|-------|-------------|
| 3.1 | `src/renderer/simple.ts` | SimpleConsoleRenderer |
| 3.2 | `src/renderer/listr2.ts` | Listr2HarnessRenderer (peer dep) |
| 3.3 | `src/renderer/index.ts` | Public exports |
| 3.4 | `package.json` | Subpath exports: `./anthropic`, `./renderer`, `./renderer/listr2` |
| 3.5 | `src/index.ts` | Re-export default provider (Anthropic) for convenience |

### Phase 4: Testing

Unit and integration tests with golden recordings.

| Task | Files | Description |
|------|-------|-------------|
| 4.1 | `tests/unit/providers/anthropic/monologue/generator.test.ts` | Unit test generator |
| 4.2 | `tests/unit/providers/anthropic/monologue/decorator.test.ts` | Unit test decorator |
| 4.3 | `tests/unit/renderer/simple.test.ts` | Unit test simple renderer |
| 4.4 | `tests/integration/harness-renderer.test.ts` | E2E with real LLM |
| 4.5 | `tests/recordings/golden/monologue/` | Golden recordings |

### Phase 5: Documentation

Write docs for v0.1.0 readiness.

| Task | Files | Description |
|------|-------|-------------|
| 5.1 | `docs/architecture.md` | System design, layer boundaries, provider namespaces |
| 5.2 | `docs/renderer-guide.md` | Usage and extension guide |
| 5.3 | `packages/sdk/README.md` | Update with renderer examples, import patterns |
| 5.4 | TSDoc comments | All public APIs |

### Phase 6: Cleanup & Verification

Final cleanup and verification.

| Task | Files | Description |
|------|-------|-------------|
| 6.1 | Verify subpath imports | Test all import patterns work |
| 6.2 | Build verification | `bun build`, type check |
| 6.3 | Test verification | `bun test` full suite |
| 6.4 | Tree-shaking verification | Verify unused providers not bundled |

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking existing TaskHarness users | Renderer is optional; existing callback-only usage unchanged |
| listr2 bundling bloat | Separate subpath export, peer dependency |
| Monologue latency | Use haiku by default, async generation |
| Test flakiness | Golden recordings, mock LLM for unit tests |

---

## Success Metrics

| Metric | Target |
|--------|--------|
| All constitution gates | ✅ Pass |
| Test coverage | >80% for new code |
| Build size impact | <50KB uncompressed for renderer core |
| Breaking changes | Zero |
| Documentation | 2 guides complete |

---

## Dependencies

```text
Phase 0 ─────────────────────► Phase 1 ─────────────────────► Phase 2
(Restructure)                  (Foundation)                   (Core)
                                                                  │
                                                                  ▼
                                                              Phase 3
                                                          (Renderers & Exports)
                                                                  │
                                                                  ▼
                                                              Phase 4
                                                              (Testing)
                                                                  │
                                                                  ▼
                                                              Phase 5
                                                             (Documentation)
                                                                  │
                                                                  ▼
                                                              Phase 6
                                                          (Cleanup & Verification)
```

---

## Artifacts Generated

| Artifact | Purpose |
|----------|---------|
| [research.md](./research.md) | Architectural decisions |
| [data-model.md](./data-model.md) | Type definitions |
| [quickstart.md](./quickstart.md) | User guide |
| [contracts/](./contracts/) | Interface contracts |
