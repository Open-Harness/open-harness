packages:
  - name: "kernel"
    path: "packages/kernel"
    purpose: "Core runtime substrate providing Hub, Agent, Flow execution, and Channel primitives"
    main_exports:
      - name: "defineHarness"
        type: "function"
        file: "src/engine/harness.ts"
        description: "Factory function to create harness instances with agents, state, and run function"
      - name: "HarnessInstance"
        type: "interface"
        file: "src/protocol/harness.ts"
        description: "Main user-facing interface for executing workflows with state management"
      - name: "Hub / HubImpl"
        type: "class+interface"
        file: "src/protocol/hub.ts, src/engine/hub.ts"
        description: "Unified event bus (events out, commands in, context propagation)"
      - name: "createHub"
        type: "function"
        file: "src/engine/hub.ts"
        description: "Creates standalone Hub instance for event management"
      - name: "AgentDefinition"
        type: "interface"
        file: "src/protocol/agent.ts"
        description: "Contract for executable agents that process input and return output"
      - name: "ExecutableAgent"
        type: "interface"
        file: "src/protocol/agent.ts"
        description: "Simplified agent interface used within harness execution context"
      - name: "ChannelDefinition"
        type: "interface"
        file: "src/protocol/channel.ts"
        description: "Bidirectional adapter contract for console/websocket/voice channels"
      - name: "executeFlow"
        type: "function"
        file: "src/flow/executor.ts"
        description: "Executes a FlowYaml DAG with registry and execution context"
      - name: "compileFlow"
        type: "function"
        file: "src/flow/compiler.ts"
        description: "Validates DAG and performs topological sort for execution order"
      - name: "NodeRegistry"
        type: "class"
        file: "src/flow/registry.ts"
        description: "Registry for NodeType definitions with schema validation"
      - name: "parseFlowYaml"
        type: "function"
        file: "src/flow/parser.ts"
        description: "Parses YAML string into FlowYaml structure"
      - name: "validateFlowYaml"
        type: "function"
        file: "src/flow/validator.ts"
        description: "Validates FlowYaml structure with Zod schemas"
      - name: "resolveBindings"
        type: "function"
        file: "src/flow/bindings.ts"
        description: "A3 binding resolver for flow.input and node outputs"
      - name: "evaluateWhen"
        type: "function"
        file: "src/flow/when.ts"
        description: "Evaluates WhenExpr conditions for conditional node execution"
      - name: "createAnthropicTextAgent"
        type: "function"
        file: "src/providers/anthropic.ts"
        description: "Creates Anthropic agent using Claude Code SDK with optional replay"
    public_interfaces:
      - name: "HarnessFactory<TInput, TState, TResult>"
        purpose: "Create harness instances with input transformation"
        file: "src/protocol/harness.ts"
      - name: "ExecuteContext<TAgentDefs, TState>"
        purpose: "Context provided to harness run function with agents, state, hub, phase/task helpers"
        file: "src/protocol/harness.ts"
      - name: "SessionContext"
        purpose: "Interactive session support with user prompts and message handling"
        file: "src/protocol/harness.ts"
      - name: "FlowYaml"
        purpose: "Complete flow specification with flow metadata, nodes, and edges"
        file: "src/protocol/flow.ts"
      - name: "NodeSpec"
        purpose: "Individual node specification with id, type, input, when, policy, config"
        file: "src/protocol/flow.ts"
      - name: "NodeTypeDefinition<TIn, TOut>"
        purpose: "Contract for implementing custom flow nodes with schemas and capabilities"
        file: "src/protocol/flow.ts"
      - name: "EventContext"
        purpose: "Hierarchical context (sessionId, phase, task, agent) propagated via AsyncLocalStorage"
        file: "src/protocol/events.ts"
      - name: "BaseEvent"
        purpose: "Union type of all supported events (workflow, agent, session, narrative)"
        file: "src/protocol/events.ts"
      - name: "EnrichedEvent<T>"
        purpose: "Event envelope with id, timestamp, context, and typed event payload"
        file: "src/protocol/events.ts"

  - name: "rtv-channel"
    path: "packages/rtv-channel"
    purpose: "Real-time voice channel implementation using OpenAI Realtime API"
    main_exports:
      - name: "createRealtimeVoiceChannel"
        type: "function"
        file: "src/channel/RealtimeVoiceChannel.ts"
        description: "Creates voice channel attachment for Hub with OpenAI integration"
      - name: "createConsoleVoiceChannel"
        type: "function"
        file: "src/channel/ConsoleVoiceChannel.ts"
        description: "Console-based voice channel for terminal interaction"
      - name: "createRealtimeConsoleConnector"
        type: "function"
        file: "src/connectors/console.ts"
        description: "CLI connector combining voice service with console UI"
      - name: "RealtimeService"
        type: "class"
        file: "src/core/RealtimeService.ts"
        description: "Core service managing OpenAI Realtime WebSocket connection"
      - name: "Tui"
        type: "class"
        file: "src/ui/Tui.ts"
        description: "Terminal UI using blessed for voice interaction visualization"
    public_interfaces:
      - name: "Hub (from kernel)"
        purpose: "Imported from kernel/types for channel attachment"
        file: "src/channel/types.ts"
      - name: "ChannelDefinition<TState>"
        purpose: "Imported from kernel for channel implementation"
        file: "src/channel/types.ts"
      - name: "Attachment"
        purpose: "Channel attachment function type (hub) => Cleanup"
        file: "src/channel/types.ts"
      - name: "RealtimeVoiceChannelConfig"
        purpose: "Configuration for voice channel (apiKey, model, voice, hardware options)"
        file: "src/channel/RealtimeVoiceChannel.ts"

  - name: "github-channel"
    path: "packages/github-channel"
    purpose: "GitHub channel specification (not yet implemented)"
    main_exports: []
    public_interfaces:
      - name: "Specification only"
        purpose: "Contains README.md and spec/ directory with design documents"

  - name: "config"
    path: "packages/config"
    purpose: "Shared configuration (minimal package, appears to be placeholder)"
    main_exports: []
    public_interfaces: []

entry_points:
  - description: "defineHarness() - Primary entry point for creating workflows"
    pattern: "Import from kernel, define agents/state/run, call create(input), attach channels, call run()"
    example: "const factory = defineHarness({ name, agents, state, run }); const instance = factory.create(input).attach(channel); await instance.run();"
  
  - description: "executeFlow() - Direct DAG execution for flow-based workflows"
    pattern: "Parse YAML, create NodeRegistry, register node types, execute with context"
    example: "const flow = parseFlowYaml(yaml); const registry = new NodeRegistry(); registry.register(nodeTypes); await executeFlow(flow, registry, ctx);"
  
  - description: "createHub() - Standalone event bus for custom integration"
    pattern: "Create hub, subscribe to events, emit events, use scoped context"
    example: "const hub = createHub(); hub.subscribe('*', handler); hub.emit({ type: 'custom' });"
  
  - description: "Voice Channel - Voice interaction via OpenAI Realtime API"
    pattern: "Create voice channel config, attach to hub, emit voice:* commands"
    example: "const channel = createRealtimeVoiceChannel(config); hub.attach(channel);"

architecture_notes:
  - "Dual runtime model: Harness-based (imperative, code-first) and Flow-based (declarative, YAML DAG)"
  - "Hub is the central abstraction - bidirectional event bus with AsyncLocalStorage context propagation"
  - "Protocol/implementation split: src/protocol/* defines interfaces, src/engine/* and src/flow/* provide implementations"
  - "No persistence layer - all state is in-memory, recordings saved to filesystem for testing"
  - "Event-driven architecture with typed events (WorkflowEvents, AgentEvents, SessionEvents, etc.)"
  - "Agent execution uses inbox pattern for bidirectional communication during execution"
  - "Channels are attachments that observe events and inject commands (console, voice, etc.)"
  - "Flow system uses A3 binding syntax (flow.input.x, nodeId.output.y) for data flow between nodes"
  - "Conditional execution via WhenExpr (equals, and, or, not) evaluated against binding context"
  - "Uses Bun runtime (not Node) - Bun.serve, bun:sqlite, bun:test, etc."
  - "TypeScript 5.x strict mode throughout with Zod for runtime validation"
  - "Testing strategy: unit tests, replay tests (with fixtures), and live integration tests"
  - "Anthropic integration via @anthropic-ai/claude-agent-sdk with subscription auth (no API key needed)"

surprising_findings:
  - "No npm/yarn - everything uses Bun (bun test, bun run, etc.)"
  - "Kernel exports both protocol types AND implementations in single package (not split)"
  - "Voice channel is a separate package but imports Hub types from kernel"
  - "GitHub channel is spec-only (no code yet) - appears to be planned"
  - "Session context is optional - harness can run with or without interactive session"
  - "AsyncLocalStorage used for automatic context propagation (no manual threading)"
  - "Node types use Zod schemas but protocol file uses placeholder 'ZodSchema<T> = unknown'"
  - "Provider package only has Anthropic - suggests more providers planned"
  - "Built-in node types are minimal: constant, echo, condition.equals (extensible via registry)"
  - "HarnessResult includes full event log, state snapshot, duration, and status"
