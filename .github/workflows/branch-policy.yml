name: Branch Policy

on:
  pull_request:
    branches:
      - master
      - dev

jobs:
  validate-branch-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch policy
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          HEAD_BRANCH="${{ github.head_ref }}"
          
          echo "PR: ${HEAD_BRANCH} → ${BASE_BRANCH}"
          
          if [ "${BASE_BRANCH}" = "master" ]; then
            # Only dev or changeset-release branches can merge to master
            if [ "${HEAD_BRANCH}" = "dev" ]; then
              echo "✅ Valid: dev → master"
            elif [[ "${HEAD_BRANCH}" == changeset-release/* ]]; then
              echo "✅ Valid: ${HEAD_BRANCH} → master (automated release)"
            else
              echo "❌ ERROR: PRs to master must come from dev branch only."
              echo ""
              echo "Current: ${HEAD_BRANCH} → master"
              echo "Required: dev → master"
              echo ""
              echo "Please:"
              echo "1. Merge your changes to dev first"
              echo "2. Create a PR from dev to master"
              exit 1
            fi
          elif [ "${BASE_BRANCH}" = "dev" ]; then
            # Feature branches go to dev (not master or dev itself)
            if [ "${HEAD_BRANCH}" = "master" ]; then
              echo "❌ ERROR: Cannot merge master back into dev."
              exit 1
            fi
            echo "✅ Valid: ${HEAD_BRANCH} → dev"
          fi
