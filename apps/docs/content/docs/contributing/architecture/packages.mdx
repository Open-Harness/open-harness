---
title: Package Structure
description: Understanding the Open Harness package organization
---

# Package Structure

Open Harness is organized as a monorepo with multiple packages. Each package has a specific purpose and clear boundaries.

## Package Overview

### @open-harness/kernel

The core runtime. Contains all essential functionality:

```
packages/kernel/
├── src/
│   ├── protocol/     # Interfaces
│   ├── engine/       # Implementations
│   ├── flow/         # Flow runtime
│   └── providers/    # AI integrations
├── docs/             # Internal specs
└── tests/
```

**Exports**:
- `createHub`, `executeFlow`, `parseFlowYaml`, `compileFlow`
- `NodeRegistry`, `resolveBindings`, `evaluateWhen`
- `createClaudeAgent`

## Package Dependencies

```
                    ┌─────────────────┐
                    │     kernel      │
                    └─────────────────┘
                             │ depends on
                             ▼
               ┌─────────────────────────────┐
               │  External Dependencies       │
               │  - @anthropic-ai/claude-sdk  │
               │  - @needle-di/core           │
               │  - zod                       │
               └─────────────────────────────┘
```

### Dependency Rules

1. **Kernel has no internal dependencies**
   - Only external packages
   - Self-contained core

2. **Future channels will depend on kernel**
   - Import types and utilities
   - Implement ChannelDefinition

3. **No circular dependencies**
   - Enforce with tooling
   - Clear hierarchy

## Adding a New Package

### When to Create a Package

Create a new package when:
- Adding a new I/O channel (e.g., WebSocket, SMS)
- Adding a substantial feature set
- Sharing code between multiple packages

Don't create a package for:
- Small utilities (add to kernel)
- Single-use features

### Setup Steps

1. **Create directory**

```bash
mkdir -p packages/my-channel
cd packages/my-channel
```

2. **Initialize package.json**

```json
{
  "name": "@open-harness/my-channel",
  "version": "0.1.0",
  "type": "module",
  "main": "src/index.ts",
  "types": "src/index.ts",
  "dependencies": {
    "@open-harness/kernel": "workspace:*"
  },
  "devDependencies": {
    "typescript": "^5.0.0"
  }
}
```

3. **Create tsconfig.json**

```json
{
  "extends": "../config/tsconfig.base.json",
  "compilerOptions": {
    "rootDir": "src",
    "outDir": "dist"
  },
  "include": ["src"]
}
```

4. **Create source files**

```typescript
// src/index.ts
import type { ChannelDefinition } from "@open-harness/kernel";

export const myChannel: ChannelDefinition = {
  name: "my-channel",
  on: {
    // handlers
  }
};
```

5. **Add to workspace**

Update root `package.json`:

```json
{
  "workspaces": [
    "packages/*"
  ]
}
```

6. **Install dependencies**

```bash
cd ../..
bun install
```

### Package Conventions

**Naming**:
- Scope: `@open-harness/`
- Channels: `*-channel` suffix
- Clear, descriptive names

**Structure**:
```
packages/my-channel/
├── src/
│   ├── index.ts          # Public exports
│   └── internal/         # Internal modules
├── tests/
│   └── index.test.ts
├── package.json
├── tsconfig.json
└── README.md
```

**Exports**:
- Export from `src/index.ts`
- Use named exports (not default)
- Type exports with `export type`

## Package-Specific Details

### Kernel Internals

The kernel is organized by concern:

| Directory | Concern |
|-----------|---------|
| `protocol/` | Type contracts |
| `engine/` | Runtime implementations |
| `flow/` | Flow execution |
| `providers/` | AI integrations |

### Channel Packages

Channel packages follow a consistent pattern:

```typescript
// src/index.ts
import type { ChannelDefinition } from "@open-harness/kernel";

interface ChannelState {
  // Channel-specific state
}

export const myChannel: ChannelDefinition<ChannelState> = {
  name: "my-channel",
  state: () => ({ /* initial state */ }),
  onStart: (ctx) => { /* setup */ },
  onComplete: (ctx) => { /* cleanup */ },
  on: {
    "event:type": (ctx) => { /* handle */ }
  }
};
```

## Version Management

All packages share a version:
- Major: Breaking changes to any package
- Minor: New features
- Patch: Bug fixes

See [Versioning](/docs/contributing/releasing/versioning) for details.

## Next Steps

- [Protocol vs Engine](/docs/contributing/architecture/protocol-vs-engine) - The split pattern
- [New Channel Guide](/docs/contributing/extending/new-channel) - Build a channel
- [Directory Layout](/docs/contributing/architecture/directory-layout) - Detailed structure
