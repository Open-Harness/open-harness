---
title: EventContext
description: Hierarchical context propagated with events via AsyncLocalStorage
---

# EventContext

The hierarchical context automatically propagated with all events. Uses AsyncLocalStorage for implicit propagation.

## Definition

```typescript
interface EventContext {
  sessionId: string;
  phase?: { name: string; number?: number };
  task?: { id: string };
  agent?: { name: string; type?: string };
}
```

## Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `sessionId` | `string` | Yes | Unique session identifier |
| `phase` | `object` | No | Current execution phase |
| `phase.name` | `string` | - | Phase name |
| `phase.number` | `number` | - | Phase sequence number |
| `task` | `object` | No | Current task |
| `task.id` | `string` | - | Task identifier |
| `agent` | `object` | No | Current agent |
| `agent.name` | `string` | - | Agent name |
| `agent.type` | `string` | - | Agent type identifier |

## Context Hierarchy

Context is hierarchical, flowing from session to phase to task to agent:

```
Session: "workflow-123"
  └── Phase: "Processing"
        └── Task: "step-1"
              └── Agent: "writer"
```

All events emitted at any level include the full context chain.

## Automatic Propagation

Context propagates automatically via AsyncLocalStorage:

```typescript
// In harness run function
await ctx.phase("Analysis", async () => {
  // All events here have phase: { name: "Analysis" }

  await ctx.task("research", async () => {
    // Events have phase AND task context

    await ctx.agents.researcher.execute({ topic: "AI" });
    // Agent events have phase, task, AND agent context
  });
});
```

## Manual Context Access

Access current context via Hub:

```typescript
const currentContext = hub.current();
console.log(currentContext.sessionId);   // "workflow-123"
console.log(currentContext.phase?.name); // "Analysis"
console.log(currentContext.task?.id);    // "research"
```

## Scoped Context

Add context for a code block:

```typescript
await hub.scoped({ phase: { name: "Validation" } }, async () => {
  // Events emitted here include phase context
  hub.emit({ type: "narrative", text: "Validating..." });

  await hub.scoped({ task: { id: "check-1" } }, async () => {
    // Events have both phase AND task
    hub.emit({ type: "narrative", text: "Checking..." });
  });
});
```

## Context in Events

Every EnrichedEvent includes full context:

```typescript
hub.subscribe("*", (event) => {
  console.log("Session:", event.context.sessionId);
  console.log("Phase:", event.context.phase?.name);
  console.log("Task:", event.context.task?.id);
  console.log("Agent:", event.context.agent?.name);
});
```

## Context Override

Override context when emitting:

```typescript
hub.emit(
  { type: "narrative", text: "Custom context" },
  { task: { id: "override-task" } }
);
```

## Example: Logging with Context

```typescript
const loggingChannel = {
  name: "logger",
  on: {
    "*": (ctx) => {
      const { sessionId, phase, task, agent } = ctx.event.context;
      const parts = [sessionId];
      if (phase) parts.push(phase.name);
      if (task) parts.push(task.id);
      if (agent) parts.push(agent.name);

      console.log(`[${parts.join(" > ")}] ${ctx.event.event.type}`);
    },
  },
};

// Output:
// [workflow-123] harness:start
// [workflow-123 > Analysis] phase:start
// [workflow-123 > Analysis > research] task:start
// [workflow-123 > Analysis > research > researcher] agent:start
```

## Context Filtering

Filter events by context:

```typescript
hub.subscribe("*", (event) => {
  // Only process events from specific phase
  if (event.context.phase?.name === "Critical") {
    handleCriticalEvent(event);
  }
});
```

## See Also

- [Hub](/reference/api/hub) - Event bus with scoped context
- [EnrichedEvent](/reference/types/enriched-event) - Event envelope
- [Events Spec](/reference/kernel-spec/spec/events) - Specification
