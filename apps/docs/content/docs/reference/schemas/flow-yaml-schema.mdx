---
title: FlowYamlSchema
description: Zod schema for validating complete flow definitions
---

# FlowYamlSchema

Zod schema for validating the complete FlowYaml structure including flow metadata, nodes, and edges.

## Schema Definition

```typescript
import { z } from "zod";

export const FlowYamlSchema = z
  .object({
    flow: FlowSpecSchema,
    nodes: z.array(NodeSpecSchema),
    edges: z.array(EdgeSchema),
  })
  .superRefine((value, ctx) => {
    // Validate unique node IDs
    const ids = value.nodes.map((node) => node.id);
    const unique = new Set(ids);
    if (unique.size !== ids.length) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: "Node IDs must be unique",
        path: ["nodes"],
      });
    }

    // Validate edge references
    for (const edge of value.edges) {
      if (!unique.has(edge.from)) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: `Edge from "${edge.from}" does not reference a node`,
          path: ["edges"],
        });
      }
      if (!unique.has(edge.to)) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: `Edge to "${edge.to}" does not reference a node`,
          path: ["edges"],
        });
      }
    }
  });
```

## Nested Schemas

### FlowSpecSchema

```typescript
export const FlowSpecSchema = z.object({
  name: z.string(),
  version: z.number().optional().default(1),
  description: z.string().optional(),
  input: z.record(z.string(), z.unknown()).optional(),
  policy: FlowPolicySchema.optional().default({ failFast: true }),
});

export const FlowPolicySchema = z
  .object({
    failFast: z.boolean().optional().default(true),
  })
  .default({ failFast: true });
```

### EdgeSchema

```typescript
export const EdgeSchema = z.object({
  from: NodeIdSchema,
  to: NodeIdSchema,
});

export const NodeIdSchema = z
  .string()
  .regex(/^[A-Za-z_][A-Za-z0-9_]*$/, "NodeId must match ^[A-Za-z_][A-Za-z0-9_]*$");
```

## Usage

### Basic Validation

```typescript
import { FlowYamlSchema } from "@open-harness/kernel";

const input = {
  flow: {
    name: "my-flow",
    version: 1,
  },
  nodes: [
    { id: "step1", type: "echo", input: { message: "hello" } },
    { id: "step2", type: "log", input: { text: "{{step1.output}}" } },
  ],
  edges: [
    { from: "step1", to: "step2" },
  ],
};

const validated = FlowYamlSchema.parse(input);
```

### Safe Parse

```typescript
const result = FlowYamlSchema.safeParse(input);

if (result.success) {
  console.log("Valid flow:", result.data.flow.name);
} else {
  console.error("Validation errors:");
  for (const issue of result.error.issues) {
    console.error(`  ${issue.path.join(".")}: ${issue.message}`);
  }
}
```

### Partial Validation

```typescript
// Validate just the flow metadata
const flowMeta = FlowSpecSchema.parse({
  name: "test",
  version: 2,
});

// Validate a single node
const node = NodeSpecSchema.parse({
  id: "myNode",
  type: "transform",
  input: { data: "{{flow.input.data}}" },
});
```

## Validation Rules

### Node ID Uniqueness

```typescript
// Invalid: duplicate IDs
const invalid = {
  flow: { name: "test" },
  nodes: [
    { id: "step1", type: "a", input: {} },
    { id: "step1", type: "b", input: {} }, // Duplicate!
  ],
  edges: [],
};

FlowYamlSchema.parse(invalid);
// ZodError: Node IDs must be unique
```

### Edge Reference Validity

```typescript
// Invalid: edge references non-existent node
const invalid = {
  flow: { name: "test" },
  nodes: [
    { id: "step1", type: "a", input: {} },
  ],
  edges: [
    { from: "step1", to: "missing" }, // "missing" doesn't exist
  ],
};

FlowYamlSchema.parse(invalid);
// ZodError: Edge to "missing" does not reference a node
```

### Node ID Format

```typescript
// Invalid: starts with number
const invalid = {
  flow: { name: "test" },
  nodes: [
    { id: "1step", type: "a", input: {} }, // Invalid format
  ],
  edges: [],
};

FlowYamlSchema.parse(invalid);
// ZodError: NodeId must match ^[A-Za-z_][A-Za-z0-9_]*$
```

## Default Values

The schema applies these defaults:

| Field | Default |
|-------|---------|
| `flow.version` | `1` |
| `flow.policy.failFast` | `true` |

```typescript
const minimal = FlowYamlSchema.parse({
  flow: { name: "test" },
  nodes: [],
  edges: [],
});

console.log(minimal.flow.version); // 1
console.log(minimal.flow.policy); // { failFast: true }
```

## TypeScript Types

```typescript
import { z } from "zod";

export type FlowYamlValidated = z.infer<typeof FlowYamlSchema>;
export type FlowSpecValidated = z.infer<typeof FlowSpecSchema>;
```

## See Also

- [NodeSpecSchema](/docs/reference/schemas/node-spec-schema) - Node validation
- [WhenExprSchema](/docs/reference/schemas/when-expr-schema) - Condition validation
- [FlowYaml](/docs/reference/types/flow-yaml) - Type definition
