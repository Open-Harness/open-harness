---
title: "Channel Protocol"
description: "Channels are bidirectional adapters/attachments that observe events and send commands. They are **interfaces to a running flow** and are **not nodes** in the FlowSpec."
---

Channels are bidirectional adapters/attachments that observe events and send commands. They are **interfaces to a running flow** and are **not nodes** in the FlowSpec.

## Attachment contract

```typescript
type Attachment = (hub: Hub) =&#62; Cleanup;

type Cleanup = void | (() =&#62; void) | (() =&#62; Promise&#60;void&#62;);
```

An attachment:
1. Receives the hub
2. Can subscribe to events
3. Can send commands (`hub.send()`, `hub.reply()`, etc.)
4. Optionally returns a cleanup function

## defineChannel helper

For convenience, channels can be defined declaratively:

```typescript
const channel = defineChannel(&#123;
  name: "ConsoleChannel",
  state: () =&#62; (&#123; tasks: 0 &#125;),
  onStart: (&#123; hub, state, emit &#125;) =&#62; &#123; /* init */ &#125;,
  on: &#123;
    "phase:start": (&#123; event &#125;) =&#62; &#123; /* render */ &#125;,
    "task:*": (&#123; state &#125;) =&#62; &#123; state.tasks++; &#125;,
    "agent:text": (&#123; event &#125;) =&#62; &#123; process.stdout.write(event.content); &#125;,
  &#125;,
  onComplete: (&#123; hub, state, emit &#125;) =&#62; &#123; /* cleanup */ &#125;,
&#125;);
```

### ChannelDefinition

```typescript
interface ChannelDefinition&#60;TState&#62; &#123;
  name: string;
  state?: () =&#62; TState;
  onStart?: (ctx: &#123; hub: Hub; state: TState; emit: (event: BaseEvent) =&#62; void &#125;) =&#62; void | Promise&#60;void&#62;;
  onComplete?: (ctx: &#123; hub: Hub; state: TState; emit: (event: BaseEvent) =&#62; void &#125;) =&#62; void | Promise&#60;void&#62;;
  on: Record&#60;string, ChannelHandler&#60;TState&#62;&#62;;
&#125;

type ChannelHandler&#60;TState&#62; = (ctx: ChannelContext&#60;TState&#62;) =&#62; void | Promise&#60;void&#62;;

interface ChannelContext&#60;TState&#62; &#123;
  hub: Hub;
  state: TState;
  event: EnrichedEvent&#60;BaseEvent&#62;;
  emit: (event: BaseEvent) =&#62; void;
&#125;
```

## Recommended patterns

### Console channel

- Subscribe to `agent:text` and write to stdout
- Subscribe to `task:*` for progress indicators
- Can call `hub.send()` to inject user input (if interactive)

### WebSocket channel

- Subscribe to all events and forward to connected clients
- Listen for `session:prompt` and forward to UI
- Receive user input from WebSocket and call `hub.reply()` or `hub.send()`

### Voice channel (e.g., ElevenLabs)

- Subscribe to `agent:text` and convert to audio
- Listen for user audio and call `hub.send()` or `hub.sendToRun(runId, ...)`
- **Note**: Realtime voice is typically a **transport** (channel), not a node

## Key invariants

1. **Channels are pure attachments** - they attach to hub, subscribe, and optionally return cleanup
2. **Channels observe events** - they never "print directly" without subscribing to hub events
3. **Channels can send commands** - via `hub.send()`, `hub.reply()`, `hub.abort()`, etc.
