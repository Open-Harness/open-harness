---
title: Custom Nodes
description: Build your own node implementations
---

# Custom Nodes

Create custom nodes that integrate with any API or service.

## Node Interface

```typescript
interface NodeTypeDefinition<TIn, TOut> {
  type: string;
  run(ctx: NodeRunContext, input: TIn): Promise<TOut>;
}

interface NodeRunContext {
  nodeId: string;
  runId: string;
  emit: (event: RuntimeEventPayload) => void;
  signal: AbortSignal;
  state: StateStore;
}
```

## Basic Node

Create a simple node that transforms input:

```typescript title="nodes.ts"
const uppercaseNode = {
  type: "uppercase" as const,
  run: async (ctx, input: { text: string }) => {
    return { text: input.text.toUpperCase() };
  },
};
```

Register it and use in a flow:

```typescript title="run.ts"
import { runFlow, parseFlowYaml } from "@open-harness/server";

const snapshot = await runFlow({
  flow: parseFlowYaml(yaml),
  registry: { [uppercaseNode.type]: uppercaseNode },
  input: { message: "hello" },
});
```

## Emitting Events

Use `ctx.emit()` to send streaming events:

```typescript title="streaming-node.ts"
const streamingNode = {
  type: "stream.text" as const,
  run: async (ctx, input: { text: string }) => {
    // Stream each word
    const words = input.text.split(" ");
    for (const word of words) {
      ctx.emit({
        type: "agent:text",
        text: word + " ",
      });
    }

    return { text: input.text };
  },
};
```

Events are broadcast to all connected clients via transports.

## Accessing State

Use `ctx.state` to read and write workflow state:

```typescript title="counter-node.ts"
const counterNode = {
  type: "counter" as const,
  run: async (ctx, input: { action: "increment" | "get" }) => {
    if (input.action === "increment") {
      const count = ctx.state.get("count") ?? 0;
      ctx.state.set("count", count + 1);
      return { count: count + 1 };
    }
    return { count: ctx.state.get("count") ?? 0 };
  },
};
```

Define initial state in your flow:

```yaml title="flow.yaml"
name: counter-flow
state:
  initial:
    count: 0
nodes:
  - id: increment
    type: counter
    input:
      action: increment
```

## Handling Cancellation

Check `ctx.signal` for cancellation:

```typescript title="long-running-node.ts"
const longRunningNode = {
  type: "long.process" as const,
  run: async (ctx, input: { items: string[] }) => {
    const results: string[] = [];

    for (const item of input.items) {
      // Check for cancellation
      if (ctx.signal.aborted) {
        return { results, cancelled: true };
      }

      const result = await processItem(item);
      results.push(result);
    }

    return { results, cancelled: false };
  },
};
```

## Calling External APIs

Nodes can call any external service:

```typescript title="api-node.ts"
const weatherNode = {
  type: "weather.fetch" as const,
  run: async (ctx, input: { city: string }) => {
    ctx.emit({ type: "node:start", nodeId: ctx.nodeId });

    const response = await fetch(
      `https://api.example.com/weather?city=${input.city}`,
      { signal: ctx.signal }
    );

    const data = await response.json();

    ctx.emit({ type: "node:complete", nodeId: ctx.nodeId });

    return { temperature: data.temp, conditions: data.conditions };
  },
};
```

## Using with DefaultNodeRegistry

For more control, use `DefaultNodeRegistry`:

```typescript title="registry.ts"
import { DefaultNodeRegistry, createRuntime } from "@open-harness/core";

const registry = new DefaultNodeRegistry();
registry.register(uppercaseNode);
registry.register(weatherNode);

const runtime = createRuntime({
  flow,
  registry,
});
```

<Callout type="stuck" title="Are you stuck?">
**Error: Node type 'mynode' not found in registry**
Make sure you pass the node in the `registry` option to `runFlow()` or `createHarness()`.

**ctx.emit is not a function**
Make sure your node's `run` function receives `ctx` as the first parameter.
</Callout>

## Next Steps

- [Claude Agent](/docs/guides/agents/claude-agent) — Configure the built-in Claude agent
- [Events API](/docs/reference/api/events) — Event types for nodes

