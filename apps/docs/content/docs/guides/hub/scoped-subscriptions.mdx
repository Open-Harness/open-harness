---
title: How to Scope Subscriptions
description: Filter subscriptions by session, task, or phase
---

# How to Scope Subscriptions

Create targeted subscriptions that only receive relevant events.

## Filter by Session

```typescript
const mySessionId = "session-123";

hub.subscribe("*", (event) => {
  if (event.context.sessionId !== mySessionId) return;

  // Handle event for this session only
  console.log(event.event.type);
});
```

## Filter by Task/Node

```typescript
hub.subscribe("narrative", (event) => {
  if (event.context.taskContext?.taskId !== "my-important-node") return;

  console.log("From my node:", event.event.text);
});
```

## Filter by Phase

```typescript
hub.subscribe("*", (event) => {
  // Only execution phase events
  if (event.context.phase !== "execution") return;

  handleExecutionEvent(event);
});
```

## Filter by Event Type Pattern

```typescript
// All task events
hub.subscribe("task:*", handler);

// All agent events
hub.subscribe("agent:*", handler);
```

## Combine Filters

```typescript
hub.subscribe("*", (event) => {
  const { sessionId, phase, taskContext } = event.context;

  // Multiple conditions
  if (sessionId !== targetSession) return;
  if (phase !== "execution") return;
  if (!taskContext?.nodeType.startsWith("llm")) return;

  // Handle LLM node events in execution phase for target session
  handleLLMEvent(event);
});
```

## Create Scoped Subscription Helper

```typescript
function subscribeTo(
  hub: Hub,
  eventType: string,
  scope: {
    sessionId?: string;
    taskId?: string;
    phase?: string;
  },
  handler: (event: EnrichedEvent) => void
) {
  return hub.subscribe(eventType, (event) => {
    const { sessionId, phase, taskContext } = event.context;

    if (scope.sessionId && sessionId !== scope.sessionId) return;
    if (scope.taskId && taskContext?.taskId !== scope.taskId) return;
    if (scope.phase && phase !== scope.phase) return;

    handler(event);
  });
}

// Usage
const unsub = subscribeTo(hub, "agent:text", { sessionId: "sess-1" }, (event) => {
  process.stdout.write(event.event.content);
});
```

## Session-Scoped Hub Wrapper

```typescript
function createSessionHub(hub: Hub, sessionId: string) {
  return {
    subscribe: (type: string, handler: (event: EnrichedEvent) => void) => {
      return hub.subscribe(type, (event) => {
        if (event.context.sessionId === sessionId) {
          handler(event);
        }
      });
    },
    emit: (event: Event) => {
      // Emissions are already scoped by AsyncLocalStorage
      hub.emit(event);
    }
  };
}

const sessionHub = createSessionHub(hub, "session-123");
sessionHub.subscribe("*", handleSessionEvent);
```

## Per-Task Output Collection

```typescript
function collectTaskOutput(hub: Hub, taskId: string): Promise<string[]> {
  return new Promise((resolve) => {
    const chunks: string[] = [];

    const unsub = hub.subscribe("agent:text", (event) => {
      if (event.context.taskContext?.taskId === taskId) {
        chunks.push(event.event.content);
      }
    });

    hub.subscribe("task:complete", (event) => {
      if (event.context.taskContext?.taskId === taskId) {
        unsub();
        resolve(chunks);
      }
    });
  });
}
```

## Related

- [Subscribe Events](/docs/guides/hub/subscribe-events) - Basic subscriptions
- [Event Context](/docs/guides/hub/event-context) - Context structure
- [Hub Events Tutorial](/docs/learn/hub-events) - Full tutorial
