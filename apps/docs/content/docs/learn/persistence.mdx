---
title: Persistence
description: Add SQLite persistence for state and replay
---

# Persistence

Add persistent storage so flows can be paused, resumed, and replayed.

## Why Persistence?

- **Pause/Resume**: Stop a flow and continue later
- **Replay Testing**: Record events and replay deterministically
- **Audit Trail**: Full history of all events

## Configure SQLite Store

```typescript
import { createHarness, parseFlowYaml } from "@open-harness/server";
import { SqliteRunStore } from "@open-harness/run-store-sqlite";
import { readFileSync } from "node:fs";

// Create persistent store
const store = new SqliteRunStore({ filename: "./runs.db" });

// Create harness with store
const harness = createHarness({
  flow: parseFlowYaml(readFileSync("flow.yaml", "utf-8")),
  store,
});

// Execute flow - events are persisted
const snapshot = await harness.run({ question: "Hello" });

// Later: retrieve the events
const events = store.loadEvents(snapshot.runId);
```

## Run Store Interface

```typescript
interface RunStore {
  // Save an event
  saveEvent(runId: string, event: RuntimeEvent): Promise<void>;

  // Load all events for a run
  loadEvents(runId: string): RuntimeEvent[];

  // Save a snapshot
  saveSnapshot(runId: string, snapshot: RunSnapshot): void;

  // Load a snapshot
  loadSnapshot(runId: string): RunSnapshot | null;
}
```

## Built-in Stores

| Store | Package | Use Case |
|-------|---------|----------|
| `InMemoryRunStore` | `@open-harness/core` | Testing, ephemeral sessions |
| `SqliteRunStore` | `@open-harness/run-store-sqlite` | Production, persistence |

## Resume a Flow

```typescript
// Load previous run state
const events = store.loadEvents(runId);
const snapshot = store.loadSnapshot(runId);

// Create runtime with previous state
const runtime = createRuntime({
  flow,
  store,
  initialState: snapshot?.state,
});

// Resume execution
await runtime.resume("continue");
```

<Callout type="stuck" title="Are you stuck?">
**TypeError: SqliteRunStore is not a constructor**
Use the correct constructor: `new SqliteRunStore({ filename: "./runs.db" })`

**Cannot find module '@open-harness/run-store-sqlite'**
Install the package: `bun add @open-harness/run-store-sqlite`
</Callout>

## Next Steps

- [Production Deployment](/docs/guides/deployment/production) — Deploy with persistence
- [RunStore API](/docs/reference/api/run-store) — Full RunStore interface

