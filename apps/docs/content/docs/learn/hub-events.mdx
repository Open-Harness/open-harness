---
title: Hub Events
description: Subscribe to and handle events from the Hub
---

# Hub Events

The Hub is the communication backbone of Open Harness. Everything that happens in a flow emits events. In this tutorial, we'll learn to observe and react to these events.

## What You'll Learn

- What the Hub is
- How to subscribe to events
- Event types and structure
- Practical patterns for event handling

## Understanding the Hub

The Hub is a central event bus:

```
┌─────────────────────────────────────────────────────────────────┐
│                           Hub                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Events Out ───▶  ┌──────────────┐  ◀─── Commands In          │
│   (agent:text)     │              │       (send, reply)         │
│   (task:complete)  │    Event     │                             │
│   (narrative)      │     Bus      │                             │
│                    │              │                             │
│                    └──────────────┘                             │
│                           │                                      │
│           ┌───────────────┼───────────────┐                     │
│           ▼               ▼               ▼                     │
│       Logger          Metrics         UI Channel                │
│     (subscriber)    (subscriber)     (subscriber)               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Step 1: Create a Hub

```typescript
import { createHub } from "@open-harness/kernel";

const hub = createHub();
```

The hub is now ready to publish and receive events.

## Step 2: Subscribe to All Events

```typescript
hub.subscribe("*", (event) => {
  console.log("Event:", event.event.type);
  console.log("Context:", event.context);
  console.log("Time:", new Date(event.timestamp));
  console.log("---");
});
```

The `"*"` filter matches all events. Each event has:
- `event`: The actual event payload
- `context`: Execution context (sessionId, runId, etc.)
- `timestamp`: When it occurred

## Step 3: Run a Flow and Observe

```typescript
import { parseFlowYaml, executeFlow, NodeRegistry, createHub } from "@open-harness/kernel";

const hub = createHub();

// Log everything
hub.subscribe("*", (event) => {
  console.log(`[${event.event.type}]`);
});

// Execute a flow
const result = await executeFlow(flow, {
  input: { name: "Alice" },
  registry,
  hub
});
```

You'll see events like:
```
[task:start]
[narrative]
[agent:text]
[task:complete]
```

## Step 4: Filter by Event Type

Subscribe only to specific events:

```typescript
// Only agent text output
hub.subscribe("agent:text", (event) => {
  console.log("Agent said:", event.event.content);
});

// Only task events
hub.subscribe("task:*", (event) => {
  console.log("Task event:", event.event.type);
});

// Only errors
hub.subscribe("task:failed", (event) => {
  console.error("Task failed:", event.event.error);
});
```

Pattern matching:
- `"agent:text"` - Exact match
- `"agent:*"` - All agent events
- `"*"` - Everything

## Step 5: Use Event Context

Every event includes context:

```typescript
hub.subscribe("*", (event) => {
  const { sessionId, runId, agentName, nodeId } = event.context;

  console.log(`Session: ${sessionId}`);
  console.log(`Run: ${runId}`);
  console.log(`Agent: ${agentName ?? "none"}`);
  console.log(`Node: ${nodeId ?? "none"}`);
});
```

Context is automatically propagated through execution:

```typescript
// In a scoped execution
hub.scoped({ agentName: "researcher" }, async () => {
  // All events emitted here have agentName: "researcher"
  hub.emit({ type: "narrative", text: "Searching..." });
});
```

## Step 6: Build an Event Logger

Let's build a structured logger:

```typescript
interface LogEntry {
  time: string;
  type: string;
  agent?: string;
  message?: string;
}

const logs: LogEntry[] = [];

function createLogger(hub: Hub) {
  hub.subscribe("*", (event) => {
    const entry: LogEntry = {
      time: new Date(event.timestamp).toISOString(),
      type: event.event.type
    };

    if (event.context.agentName) {
      entry.agent = event.context.agentName;
    }

    // Extract message based on event type
    switch (event.event.type) {
      case "agent:text":
        entry.message = event.event.content;
        break;
      case "narrative":
        entry.message = event.event.text;
        break;
      case "task:failed":
        entry.message = event.event.error?.message;
        break;
    }

    logs.push(entry);
    console.log(JSON.stringify(entry));
  });

  return logs;
}

// Usage
const hub = createHub();
const logs = createLogger(hub);

await executeFlow(flow, { input, registry, hub });

console.log(`Total events: ${logs.length}`);
```

## Common Patterns

### Progress Tracking

```typescript
let completed = 0;
let total = 0;

hub.subscribe("task:start", () => total++);
hub.subscribe("task:complete", () => {
  completed++;
  console.log(`Progress: ${completed}/${total}`);
});
```

### Error Monitoring

```typescript
hub.subscribe("task:failed", (event) => {
  const { taskId, error } = event.event;

  // Log error details
  console.error(`Task ${taskId} failed:`, error);

  // Could also: send to error tracking service
  // errorTracker.capture(error, { taskId, context: event.context });
});
```

### Metrics Collection

```typescript
const metrics = {
  events: 0,
  errors: 0,
  startTime: Date.now()
};

hub.subscribe("*", () => metrics.events++);
hub.subscribe("task:failed", () => metrics.errors++);

// At end
const duration = Date.now() - metrics.startTime;
console.log(`Duration: ${duration}ms, Events: ${metrics.events}, Errors: ${metrics.errors}`);
```

### Async Iteration

The hub is async-iterable:

```typescript
async function processEvents(hub: Hub) {
  for await (const event of hub) {
    console.log(event.event.type);

    if (event.event.type === "session:complete") {
      break;
    }
  }
}
```

## Cleanup

Subscriptions return cleanup functions:

```typescript
const unsubscribe = hub.subscribe("agent:text", handler);

// Later, when done
unsubscribe();
```

## Next Steps

- **[Channels](/docs/learn/channels)** - Build I/O adapters with the Hub
- **[Hub Concept](/docs/concepts/hub/event-bus)** - Deeper understanding
- **[Hub API](/docs/reference/api/hub)** - Complete reference
