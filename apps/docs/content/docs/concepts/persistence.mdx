---
title: Persistence
description: Understanding event persistence and replay
---

# Persistence

Open Harness persists all events, enabling replay and recovery.

## Event Sourcing

The system uses event sourcing principles:

> State is derived from a sequence of events.

Instead of storing current state, we store every event that occurred. This enables:

- **Replay**: Reconstruct any point in time
- **Audit**: Complete history of actions
- **Debug**: See exactly what happened
- **Recovery**: Resume interrupted flows

## RunStore Interface

All persistence goes through the RunStore:

```typescript
interface RunStore {
  saveEvent(runId: string, event: RuntimeEvent): Promise<void>;
  getEvents(runId: string): Promise<RuntimeEvent[]>;
  getRun(runId: string): Promise<RunMetadata | null>;
  listRuns(options?: ListOptions): Promise<RunMetadata[]>;
}
```

## Built-in Stores

### MemoryRunStore

In-memory storage for development:

```typescript
import { InMemoryRunStore } from "@open-harness/core";

const store = new InMemoryRunStore();
```

- Fast, no setup
- Data lost on restart
- Good for testing

### SqliteRunStore

File-based persistence:

```typescript
import { SqliteRunStore } from "@open-harness/run-store-sqlite";

const store = new SqliteRunStore({ filename: "./data/runs.db" });
```

- Single file
- No external dependencies
- Production-ready for single-process

## Event Replay

Reconstruct state from events:

```typescript
const events = await store.getEvents(runId);

for (const event of events) {
  switch (event.type) {
    case "node:complete":
      state.nodeOutputs[event.nodeId] = event.output;
      break;
    case "flow:complete":
      state.result = event.output;
      break;
  }
}
```

## Run Metadata

Track run lifecycle:

```typescript
interface RunMetadata {
  id: string;
  flowId: string;
  status: "running" | "completed" | "failed";
  startedAt: Date;
  completedAt?: Date;
  input?: unknown;
  output?: unknown;
}
```

## Querying Runs

```typescript
// Get specific run
const run = await store.getRun("run-abc123");

// List recent runs
const runs = await store.listRuns({
  flowId: "my-flow",
  status: "completed",
  limit: 10,
});
```

## Custom Stores

Implement RunStore for other backends:

```typescript
class PostgresRunStore implements RunStore {
  async saveEvent(runId: string, event: RuntimeEvent) {
    await this.pool.query(
      "INSERT INTO events (run_id, data) VALUES ($1, $2)",
      [runId, JSON.stringify(event)]
    );
  }

  // ... other methods
}
```

## Next Steps

- [Persistence Guide](/docs/guides/deployment/persistence) — Configuration
- [RunStore API](/docs/reference/api/run-store) — Interface reference
