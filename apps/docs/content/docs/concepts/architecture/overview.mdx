---
title: Architecture Overview
description: Understand the Hub, Flow, and Channel model that powers Open Harness
---

# Architecture Overview

Open Harness is an event-driven workflow execution system. This page explains the mental model you need to build multi-agent systems.

## The Core Idea

```
YAML Flow Definition
       ↓
   [Parse + Validate]
       ↓
   [Compile to DAG]
       ↓
   [Execute Nodes in Order]
       ↓
   [Events flow through Hub]
       ↓
   [Channels observe & interact]
```

That's it. Everything else is details.

## The Three Layers

### Layer 1: Hub (The Event Bus)

The **Hub** is a message bus that all events flow through.

**What it does:**
- `emit(event)` - Publish an event
- `subscribe(filter, listener)` - Listen for events
- `scoped(context, fn)` - Run code with context attached to all events
- `sendToRun(runId, message)` - Inject messages to running agents

**Why it matters:** Everything goes through the Hub. No side channels. This gives you:
- Full observability (subscribe to `*` and see everything)
- Context propagation (events know which task/phase/agent they came from)
- Command injection (external systems can send messages to running agents)

```typescript
// Subscribe to all events
hub.subscribe("*", (event) => {
  console.log(`[${event.context.task?.id}] ${event.event.type}`);
});

// Run code with context
await hub.scoped({ phase: { name: "Execute" } }, async () => {
  hub.emit({ type: "custom:event" }); // Has phase context attached
});
```

### Layer 2: Flow (The Workflow Engine)

The **Flow** layer is a DAG execution engine that runs YAML-defined workflows.

```
YAML String → parser → FlowYaml → validator → compiler → executor → Events
```

**Key concepts:**

1. **Nodes**: Executable units with input/output
   ```yaml
   - id: ask_user
     type: claude.agent
     input:
       prompt: "What is your name?"
   ```

2. **Edges**: Explicit dependencies between nodes
   ```yaml
   edges:
     - from: ask_user
       to: greet_user
   ```

3. **Bindings**: Data threading via JSONata expressions
   ```yaml
   - id: greet_user
     type: echo
     input:
       text: "Hello, {{ ask_user.text }}!"
   ```

4. **When expressions**: Conditional execution with JSONata
   ```yaml
   - id: conditional_node
     when: "score > 80"
   ```

### Layer 3: Channels (External Interfaces)

**Channels** are adapters that connect external systems to the Hub.

What a channel does:
1. Subscribes to hub events (observe)
2. Sends commands to hub (interact)
3. Maintains its own state (connection info, etc.)

```typescript
hub.registerChannel({
  name: "logger",
  on: {
    "node:*": ({ event }) => {
      console.log(`[${event.event.type}] ${event.event.nodeId}`);
    },
  },
});
```

## How Execution Works

Let's trace what happens when you run this flow:

```yaml
flow:
  name: "Simple Flow"

nodes:
  - id: ask
    type: claude.agent
    input:
      prompt: "Say hello"

  - id: log
    type: echo
    input:
      text: "Agent said: {{ ask.text }}"

edges:
  - from: ask
    to: log
```

1. **Parse & Validate** - YAML is parsed and checked against Zod schemas
2. **Compile** - Nodes are topologically sorted (ask before log)
3. **Execute `ask`** - Claude is called, returns `{ text: "Hello!" }`
4. **Store output** - `outputs["ask"] = { text: "Hello!" }`
5. **Resolve bindings** - `{{ ask.text }}` becomes `"Hello!"`
6. **Execute `log`** - Echoes `"Agent said: Hello!"`

Each step emits events (`node:start`, `node:complete`) that channels can observe.

## The Canonical Interface

```typescript
import {
  createHub,
  executeFlow,
  parseFlowYaml,
  NodeRegistry,
  claudeNode
} from "@open-harness/kernel";

// 1. Create hub
const hub = createHub("my-session");

// 2. Register channels FIRST
hub.registerChannel({
  name: "logger",
  on: {
    "node:*": ({ event }) => console.log(event.event.type),
  },
});

// 3. Register node types
const registry = new NodeRegistry();
registry.register(claudeNode);

// 4. Parse and execute
const flow = parseFlowYaml(yamlString);
await hub.start();
const result = await executeFlow(flow, registry, hub);
await hub.stop();
```

## Design Principles

| Principle | Benefit |
|-----------|---------|
| **Event-driven** | Full observability, replay testing |
| **Declarative YAML** | Visual editing, easy modification |
| **Hub-centric** | Single source of truth for all events |
| **Channel adapters** | Clean I/O separation |

## What's Next

- [Data Bindings with JSONata](/docs/guides/expressions/bindings) - Learn the expression language
- [Hub Events](/docs/concepts/hub/event-bus) - Deep dive into event types
- [Custom Agents](/docs/guides/agents/custom-agents) - Build your own agents
