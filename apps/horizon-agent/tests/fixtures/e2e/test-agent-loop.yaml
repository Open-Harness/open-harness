# Test version of agent-loop.yaml
# Same structure but without schema file references (uses fixture responses directly)

name: test-agent-loop
version: 1

state:
  initial:
    tasks: []
    currentTaskIndex: 0
    currentIteration: 0
    reviewFeedback: null
    completedTasks: []
    status: "idle"

nodes:
  - id: planner
    type: claude.agent
    input:
      prompt: |
        # Feature Implementation Planning

        ## Feature Request
        {{ flow.input.feature }}

        Return a JSON object with a "tasks" array.

  - id: coder
    type: claude.agent
    input:
      prompt: |
        # Implementation Task

        ## Current Task
        **ID:** {{ task.id }}
        **Title:** {{ task.title }}
        **Description:** {{ task.description }}

        Implement this task.

  - id: reviewer
    type: claude.agent
    input:
      prompt: |
        # Code Review

        ## Implementation to Review
        {{ coder.text }}

        Review and return { "passed": boolean, "feedback": string }

edges:
  # Planner -> Coder (with forEach for task iteration)
  - from: planner
    to: coder
    forEach:
      in: "{{ planner.structuredOutput.tasks }}"
      as: task

  # Coder -> Reviewer
  - from: coder
    to: reviewer

  # Loop: Reviewer -> Coder on failure
  - from: reviewer
    to: coder
    when: "$not(reviewer.structuredOutput.passed = true)"
    maxIterations: 5
