# Horizon Agent Flow (Kernel)
# Multi-agent implementation system: planner → forEach(task) → coder ↔ reviewer loop
#
# Syntax:
# - {{ expr }} for JSONata interpolation (bindings.ts)
# - when: "jsonata-expr" for edge conditions (when.ts)
# - NO {% %} Jinja control flow - use JSONata ternary instead

name: horizon-agent
version: 1

state:
  initial:
    tasks: []
    reviewFeedback: null
    completedTasks: []
    status: "idle"

nodes:
  # Phase 1: Planning
  # Analyzes feature request and creates structured task list
  - id: planner
    type: claude.agent
    input:
      prompt: |
        # Feature Implementation Planning

        ## Feature Request
        {{ flow.input.feature }}

        ## Your Role
        You are a senior software architect. Analyze this feature request and create a detailed implementation plan.

        ## Instructions
        1. Break down the feature into atomic, implementable tasks
        2. Order tasks by dependencies (dependent tasks come after their dependencies)
        3. Each task should be completable in a single focused coding session
        4. Include clear success criteria for each task

        ## Output Format
        Return a JSON object with a "tasks" array. Each task must have:
        - id: Unique identifier like "task-1", "task-2"
        - title: Short descriptive title
        - description: Detailed description of what to implement
        - dependencies: Array of task IDs this depends on (empty array if none)

        Keep the plan focused and achievable. Aim for 3-7 tasks for typical features.
      options:
        outputSchemaFile: apps/horizon-agent/schemas/planner.json

  # Phase 2: Implementation
  # Processes each task, handles both initial and revision iterations
  - id: coder
    type: claude.agent
    input:
      prompt: |
        # Implementation Task

        ## Current Task
        **ID:** {{ task.id }}
        **Title:** {{ task.title }}
        **Description:** {{ task.description }}

        ## Previous Review Feedback
        {{ $exists(state.reviewFeedback) ? '**Status:** ' & (state.reviewFeedback.passed ? 'Passed' : 'Needs Revision') & '\n**Feedback:** ' & state.reviewFeedback.feedback & '\n**Issues:**\n- ' & $join(state.reviewFeedback.issues, '\n- ') : 'This is the first iteration. No previous feedback.' }}

        ## Instructions
        1. Implement this task completely
        2. If there is previous feedback, address ALL issues mentioned
        3. Provide production-ready, working code
        4. Include any necessary imports, type definitions, and error handling
        5. Follow best practices for the language/framework being used

        ## Output
        Provide the complete implementation with clear file paths and code blocks.

  # Phase 3: Review
  # Reviews implementation and provides structured feedback
  - id: reviewer
    type: claude.agent
    input:
      prompt: |
        # Code Review

        ## Task Being Reviewed
        **ID:** {{ task.id }}
        **Title:** {{ task.title }}
        **Description:** {{ task.description }}

        ## Implementation to Review
        {{ coder.text }}

        ## Review Criteria
        1. **Correctness:** Does the implementation fully satisfy the task requirements?
        2. **Code Quality:** Is the code clean, readable, and maintainable?
        3. **Edge Cases:** Are error conditions and edge cases handled appropriately?
        4. **Best Practices:** Does it follow language/framework conventions?
        5. **Completeness:** Is anything missing that the task description requires?

        ## Instructions
        - Be thorough but fair in your review
        - Only fail the implementation if there are genuine issues
        - Provide specific, actionable feedback for any issues found
        - If the code is production-ready, approve it
      options:
        outputSchemaFile: apps/horizon-agent/schemas/reviewer.json

edges:
  # Planner -> Coder: fan out over tasks
  - from: planner
    to: coder
    forEach:
      in: "{{ planner.structuredOutput.tasks }}"
      as: task

  # Coder -> Reviewer: sequential review
  - from: coder
    to: reviewer

  # Reviewer -> Coder: loop on failure (max 5 iterations)
  - from: reviewer
    to: coder
    when: "reviewer.structuredOutput.passed = false"
    maxIterations: 5
