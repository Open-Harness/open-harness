# Horizon Agent Flow (Kernel V3)
# Multi-agent implementation system: planner → forEach(task) → coder ↔ reviewer loop
#
# This flow demonstrates:
# - State management for plan persistence
# - forEach edges for task iteration
# - Loop edges for coder/reviewer cycles
# - External prompt files and Zod schemas for structured output

name: horizon-agent
version: 1

state:
  initial:
    tasks: []
    planCreatedAt: null
    currentTaskIndex: 0
    currentIteration: 0
    reviewFeedback: null
    completedTasks: []
    startedAt: null
    completedAt: null
    status: "idle"

nodes:
  # Phase 1: Planning
  # The planner analyzes the feature request and creates a structured task list.
  - id: planner
    type: claude.agent
    input:
      promptFile: ./prompts/planner.md
      outputSchemaFile: ./schemas/planner.ts

  # Phase 2: Task Implementation
  # The coder implements each task from the plan.
  - id: coder
    type: claude.agent
    input:
      promptFile: ./prompts/coder.md
      outputSchemaFile: ./schemas/coder.ts

  # Phase 3: Code Review
  # The reviewer evaluates the implementation and provides feedback.
  - id: reviewer
    type: claude.agent
    input:
      promptFile: ./prompts/reviewer.md
      outputSchemaFile: ./schemas/reviewer.ts

edges:
  # Planner -> Coder (with forEach for task iteration)
  - from: planner
    to: coder
    forEach:
      in: "{{ planner.structuredOutput.tasks }}"
      as: task

  # Coder -> Reviewer (sequential within each task)
  - from: coder
    to: reviewer

  # Loop: Reviewer -> Coder on failure
  # This creates a controlled cycle for iterative improvement
  - from: reviewer
    to: coder
    when:
      not:
        equals:
          var: reviewer.structuredOutput.passed
          value: true
    maxIterations: 5
