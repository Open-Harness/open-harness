# Golden Recording Capture - Task List
# Generated: 2026-01-19
# PRD: .ralphy/PRD.md
# Constitution: .ralphy/constitution.md

metadata:
  name: "Golden Recording Capture"
  branch: "feat/handler-pattern-dx-cli"
  prd: ".ralphy/PRD.md"
  total_tasks: 6

# =============================================================================
# Phase 1: Verify Infrastructure
# =============================================================================

phases:
  - name: "Phase 1: Verify Infrastructure"
    tasks:
      - id: "1.1"
        name: "Verify CLI works end-to-end with real Claude API"
        status: pending
        description: |
          Run the CLI in live mode to verify it calls the REAL Claude API
          and executes a workflow successfully.

          CONTEXT: The CLI was built in the previous cycle but never tested
          against the real Claude API. This task proves the infrastructure works.

          REQUIRED: Actual Claude API responses must be observed.

        steps:
          - "cd packages/prd-workflow"
          - "bun run prd:live ../../examples/hello-world.prd.md"
          - "Observe: Claude API is called (check logs for API requests)"
          - "Observe: Workflow progresses through planning/execution phases"
          - "Verify: Generated code appears in .sandbox/"

        verify:
          - command: "ls -la .sandbox/"
            expect: "Generated files from Claude exist"
          - command: "cat .open-harness/logs/harness.log | grep -i 'claude\\|api\\|request' | tail -20"
            expect: "Log entries showing real API calls"

        acceptance:
          - "CLI completes with no errors"
          - "Real Claude API responses received"
          - "Generated code exists in .sandbox/"

# =============================================================================
# Phase 2: Capture Golden Recording
# =============================================================================

  - name: "Phase 2: Capture Golden Recording"
    tasks:
      - id: "2.1"
        name: "Run prd:record to capture real Claude signals"
        status: pending
        description: |
          Execute prd:record to capture a REAL recording from the Claude API.
          This recording becomes the golden fixture for all future replay tests.

          REQUIRED: Recording contains REAL Claude responses from live API call.

        steps:
          - "cd packages/prd-workflow"
          - "bun run prd:record ../../examples/hello-world.prd.md --name 'hello-world-golden' --tags 'golden,ci'"
          - "Note the recording ID returned (format: rec_XXXXXXXX)"
          - "Verify recording saved to SQLite database"

        verify:
          - command: "sqlite3 .sandbox/recordings.db 'SELECT id, name, signal_count FROM recordings WHERE name LIKE \"%golden%\"'"
            expect: "Recording with signal_count > 0"

        acceptance:
          - "Recording ID returned in format rec_XXXXXXXX"
          - "Recording saved to SQLite with signal_count > 0"
          - "Recording contains actual Claude responses"

      - id: "2.2"
        name: "Verify recording persistence"
        status: pending
        description: |
          Verify the recording persists in SQLite and survives process restarts.

        steps:
          - "Query SQLite directly to confirm recording exists"
          - "Restart the process and query again"
          - "Verify all signals preserved"

        verify:
          - command: "sqlite3 .sandbox/recordings.db 'SELECT COUNT(*) FROM signals WHERE recording_id IN (SELECT id FROM recordings WHERE name LIKE \"%golden%\")'"
            expect: "Signal count > 0"

        acceptance:
          - "Recording persists after process restart"
          - "All signals preserved in database"

# =============================================================================
# Phase 3: Verify Replay
# =============================================================================

  - name: "Phase 3: Verify Replay"
    tasks:
      - id: "3.1"
        name: "Run prd:replay and verify identical renderer output"
        status: pending
        description: |
          Run replay with the golden recording and verify it produces
          IDENTICAL renderer output to the original run.

          The replay injects signals from the recording, so renderers see
          exactly the same data as the original live run. No network calls occur.

        steps:
          - "cd packages/prd-workflow"
          - "bun run prd:replay --recording <RECORDING_ID>"
          - "Observe: Same renderer output as original recording"
          - "Verify: ZERO Claude API calls (check network/logs)"

        verify:
          - command: "cat .open-harness/logs/harness.log | grep -i 'replay' | tail -10"
            expect: "Replay mode indicators, no API call logs"

        acceptance:
          - "Replay completes successfully"
          - "Renderer output matches original recording"
          - "Zero Claude API calls during replay"
          - "Replay is fast (signals injected from recording)"

# =============================================================================
# Phase 4: Fixture Factory
# =============================================================================

  - name: "Phase 4: Fixture Factory"
    tasks:
      - id: "4.1"
        name: "Create loadFixtureHarness factory"
        status: pending
        description: |
          Create a factory function that loads fixtures from REAL recordings.

          The factory:
          1. Loads recording by name from SQLite (or exported JSON)
          2. Creates a harness that injects recorded signals
          3. Provides same interface as live harness

          All tests will use this factory to load real recorded data.

        steps:
          - "Create packages/prd-workflow/src/test-utils/fixture-factory.ts"
          - "Implement loadFixtureHarness(recordingName: string)"
          - "Factory loads from SqliteSignalStore"
          - "Returns harness that replays recorded signals"
          - "Export from package"

        verify:
          - command: "grep -r 'loadFixtureHarness' packages/prd-workflow/src/"
            expect: "Factory function defined"

        acceptance:
          - "Factory function exists at src/test-utils/fixture-factory.ts"
          - "Loads from real recordings"
          - "Exported from package"

      - id: "4.2"
        name: "Remove legacy test utilities"
        status: pending
        description: |
          Remove the legacy test utility functions that do not use real recordings.

          Search for and delete any test helpers that generate synthetic data
          instead of loading from recordings.

        steps:
          - "Search for legacy test utility functions in test files"
          - "Delete the functions and their definitions"
          - "Update all tests to use the new factory"

        verify:
          - command: "bun run typecheck"
            expect: "No errors (all references updated)"

        acceptance:
          - "Legacy utilities removed"
          - "No synthetic data generators remain"

      - id: "4.3"
        name: "Update tests to use fixture factory"
        status: pending
        description: |
          Update all tests to use loadFixtureHarness to load real recordings.

        steps:
          - "Find all tests using legacy utilities"
          - "Replace with loadFixtureHarness('hello-world-golden')"
          - "Ensure tests pass with real fixtures"

        verify:
          - command: "bun test packages/prd-workflow/"
            expect: "All tests pass"

        acceptance:
          - "All tests use factory pattern"
          - "All tests pass with real fixtures"

# =============================================================================
# Phase 5: Documentation
# =============================================================================

  - name: "Phase 5: Documentation"
    tasks:
      - id: "5.1"
        name: "Document recording/replay workflow in README"
        status: pending
        description: |
          Update the prd-workflow README with clear instructions for
          the recording/replay workflow.

        steps:
          - "Add 'Recording & Replay' section to README"
          - "Document prd:live, prd:record, prd:replay commands"
          - "Explain value proposition (record once, replay forever)"
          - "Document database location and management"

        verify:
          - command: "grep -A5 'Recording' packages/prd-workflow/README.md"
            expect: "Recording section exists"

        acceptance:
          - "README contains recording/replay section"
          - "Commands documented with examples"

# =============================================================================
# Phase 6: Final Verification
# =============================================================================

  - name: "Phase 6: Final Verification"
    tasks:
      - id: "6.1"
        name: "Run full quality suite"
        status: pending
        description: |
          Run all quality gates to ensure everything passes.

        verify:
          - command: "bun run typecheck"
            expect: "ZERO errors"
          - command: "bun run lint"
            expect: "ZERO warnings"
          - command: "bun run test"
            expect: "ALL tests pass"

        acceptance:
          - "Typecheck passes with zero errors"
          - "Lint passes with zero warnings"
          - "All tests pass"

      - id: "6.2"
        name: "Verify Definition of Done"
        status: pending
        description: |
          Final check against DEFINITION_OF_DONE.md criteria.

        checklist:
          - "Golden recording captured from REAL Claude API"
          - "prd:replay shows identical renderer output"
          - "All legacy test utilities removed"
          - "All quality gates pass"
          - "Factory pattern for all fixtures"

        verify:
          - command: "grep -r 'loadFixtureHarness' packages/prd-workflow/src/"
            expect: "Factory exists"

        acceptance:
          - "All DOD criteria met"
          - "Ready to merge"
