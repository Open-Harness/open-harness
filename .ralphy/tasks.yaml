# Ralphy Task List
# Source: specs/001-effect-refactor/tasks.md
# Generated: 2026-01-21
#
# IMPORTANT: This is a greenfield package at packages/core-v2/
# No existing code to modify - building from scratch.
#
# Reference: specs/001-effect-refactor/ for contracts and design docs

metadata:
  name: "Effect Workflow System (core-v2)"
  total_tasks: 117
  total_phases: 10
  reference:
    spec: "specs/001-effect-refactor/spec.md"
    plan: "specs/001-effect-refactor/plan.md"
    contracts: "specs/001-effect-refactor/contracts/"

tasks:
  # ═══════════════════════════════════════════════════════════════
  # Phase 1: Setup (Shared Infrastructure)
  # ═══════════════════════════════════════════════════════════════
  - title: "1.1: Create packages/core-v2/ directory structure (T001)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      Per plan.md, this is a standalone greenfield package.
      Directory structure follows Effect-TS conventions.

      STEPS:
      1. Create packages/core-v2/ directory
      2. Create src/ subdirectories: event, handler, agent, workflow, tape, store, renderer, provider, message, internal
      3. Create tests/ directory with integration/ subdirectory
      4. Verify structure matches plan.md "Source Code" section

      VERIFY:
      ```bash
      test -d packages/core-v2/src/event
      test -d packages/core-v2/src/tape
      test -d packages/core-v2/src/internal
      test -d packages/core-v2/tests/integration
      ```
    verify:
      - command: "test -d packages/core-v2/src && echo 'src exists'"
        expect: "src exists"
      - command: "test -d packages/core-v2/tests && echo 'tests exists'"
        expect: "tests exists"
    acceptance:
      - "All directories created per plan.md"
      - "Structure ready for module implementation"

  - title: "1.2: Initialize package.json with dependencies (T002)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      Per plan.md Technical Context section.
      Dependencies: effect, @effect/schema, @effect/platform, @anthropic-ai/claude-agent-sdk, zod, zod-to-json-schema

      STEPS:
      1. Create packages/core-v2/package.json
      2. Set name: "@open-harness/core-v2"
      3. Add dependencies from plan.md
      4. Add devDependencies: @effect/vitest, typescript
      5. Configure exports for main and react subpath
      6. Run bun install

      VERIFY:
      ```bash
      test -f packages/core-v2/package.json
      grep -q "effect" packages/core-v2/package.json
      grep -q "@effect/schema" packages/core-v2/package.json
      cd packages/core-v2 && bun install
      ```
    verify:
      - command: "test -f packages/core-v2/package.json && echo 'exists'"
        expect: "exists"
      - command: "grep 'effect' packages/core-v2/package.json"
        expect: "effect dependency found"
    acceptance:
      - "package.json created with all dependencies"
      - "bun install succeeds"

  - title: "1.3: Configure tsconfig.json with strict mode (T003)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      TypeScript 5.x strict mode per plan.md.
      Effect-compatible settings required.

      STEPS:
      1. Create packages/core-v2/tsconfig.json
      2. Enable strict: true
      3. Set target: ES2022, module: NodeNext
      4. Configure paths for internal imports
      5. Extend from root tsconfig if applicable

      VERIFY:
      ```bash
      test -f packages/core-v2/tsconfig.json
      grep -q '"strict": true' packages/core-v2/tsconfig.json
      cd packages/core-v2 && bun run tsc --noEmit
      ```
    verify:
      - command: "grep 'strict' packages/core-v2/tsconfig.json"
        expect: "strict mode configured"
    acceptance:
      - "tsconfig.json created with strict mode"
      - "TypeScript compiles without errors"

  - title: "1.4: Configure vitest with @effect/vitest (T004)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      @effect/vitest enables Effect-native testing.
      Per plan.md Testing section.

      STEPS:
      1. Create packages/core-v2/vitest.config.ts
      2. Configure @effect/vitest plugin
      3. Set test patterns for src/**/*.test.ts and tests/**/*.test.ts

      VERIFY:
      ```bash
      test -f packages/core-v2/vitest.config.ts
      grep -q "@effect/vitest" packages/core-v2/vitest.config.ts
      ```
    verify:
      - command: "test -f packages/core-v2/vitest.config.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "vitest configured for Effect-native testing"

  - title: "1.5: Create src/index.ts with public API exports (T005)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      Per spec FR-062: Zero Effect types in public API.
      This is the main entry point consumers import from.

      STEPS:
      1. Create packages/core-v2/src/index.ts
      2. Add placeholder exports (will be filled in later phases)
      3. Add comment: "Public API - NO Effect types here"

      VERIFY:
      ```bash
      test -f packages/core-v2/src/index.ts
      ! grep -q "from 'effect'" packages/core-v2/src/index.ts || echo "No Effect imports"
      ```
    verify:
      - command: "test -f packages/core-v2/src/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "index.ts created as Effect-free entry point"

  - title: "1.6: Create src/react.ts subpath export stub (T006)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      Per plan.md, React integration via subpath export @core-v2/react.

      STEPS:
      1. Create packages/core-v2/src/react.ts
      2. Add placeholder for useWorkflow hook
      3. Add placeholder for WorkflowProvider

      VERIFY:
      ```bash
      test -f packages/core-v2/src/react.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/react.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "React subpath export stub created"

  - title: "1.7: Create src/internal/boundary.ts with Effect→Promise utilities (T007)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      Per plan.md, ManagedRuntime at boundary hides Effect from public API.
      This file contains utilities for converting Effect → Promise.

      STEPS:
      1. Create packages/core-v2/src/internal/boundary.ts
      2. Implement runPromise wrapper using ManagedRuntime
      3. Implement Exit.match for error conversion
      4. Implement Cause.pretty for error messages
      5. Export as internal-only (not from index.ts)

      VERIFY:
      ```bash
      test -f packages/core-v2/src/internal/boundary.ts
      grep -q "ManagedRuntime" packages/core-v2/src/internal/boundary.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/internal/boundary.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Effect→Promise boundary utilities implemented"
      - "TypeScript compiles"

  - title: "1.8: Create src/internal/schema.ts with Zod→JSON Schema conversion (T008)"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      CONTEXT:
      Per plan.md Schema Strategy: Zod for public API, converted to JSON Schema for SDK.
      Uses zod-to-json-schema library.

      STEPS:
      1. Create packages/core-v2/src/internal/schema.ts
      2. Import zod-to-json-schema
      3. Create zodToJsonSchema utility function
      4. Handle edge cases (recursive schemas, refs)

      VERIFY:
      ```bash
      test -f packages/core-v2/src/internal/schema.ts
      grep -q "zod-to-json-schema" packages/core-v2/src/internal/schema.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/internal/schema.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Zod→JSON Schema conversion utility implemented"

  - title: "1.G: Phase 1 Gate - Setup Verification"
    completed: false
    parallel_group: 1
    phase: "Phase 1: Setup"
    details: |
      GATE CHECK:
      All Phase 1 tasks must pass before Phase 2.

      VERIFY:
      ```bash
      bun run typecheck
      test -d packages/core-v2/src
      test -f packages/core-v2/package.json
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "test -d packages/core-v2/src && echo 'Ready'"
        expect: "Ready"
    acceptance:
      - "Phase 1 complete"
      - "Package structure ready for implementation"

  # ═══════════════════════════════════════════════════════════════
  # Phase 2: Foundational (BLOCKS all user stories)
  # ═══════════════════════════════════════════════════════════════
  - title: "2.1: Create src/event/Event.ts with EventId and EventSchema (T009)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per spec FR-005/FR-006: Events MUST be immutable with id, name, payload, timestamp.
      Per contracts/event.ts for type definitions.

      STEPS:
      1. Create packages/core-v2/src/event/Event.ts
      2. Define EventId as branded string type
      3. Define Event interface per contracts/event.ts
      4. Create EventSchema using @effect/schema
      5. Add createEvent factory function

      VERIFY:
      ```bash
      test -f packages/core-v2/src/event/Event.ts
      grep -q "EventId" packages/core-v2/src/event/Event.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/event/Event.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Event type defined per spec FR-005/FR-006"
      - "EventId branded type for type safety"

  - title: "2.2: Create src/event/index.ts with public exports (T010)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Module index file for event primitives.

      STEPS:
      1. Create packages/core-v2/src/event/index.ts
      2. Re-export Event, EventId, createEvent
      3. Do NOT export @effect/schema internals

      VERIFY:
      ```bash
      test -f packages/core-v2/src/event/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/event/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Event module exports defined"

  - title: "2.3: Create src/handler/Handler.ts with Handler type (T011)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per spec FR-009/FR-010/FR-011: Handlers are pure functions.
      Per contracts/handler.ts for type definitions.

      STEPS:
      1. Create packages/core-v2/src/handler/Handler.ts
      2. Define Handler type: (event, state) => { state, events[] }
      3. Define HandlerResult interface
      4. Define HandlerDefinition interface

      VERIFY:
      ```bash
      test -f packages/core-v2/src/handler/Handler.ts
      grep -q "HandlerResult" packages/core-v2/src/handler/Handler.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/handler/Handler.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Handler type defined per spec FR-009"
      - "Pure function signature enforced"

  - title: "2.4: Create src/handler/index.ts with public exports (T012)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      STEPS:
      1. Create packages/core-v2/src/handler/index.ts
      2. Re-export Handler, HandlerResult, HandlerDefinition

      VERIFY:
      ```bash
      test -f packages/core-v2/src/handler/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/handler/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Handler module exports defined"

  - title: "2.5: Create src/agent/Agent.ts with Agent interface (T013)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per spec FR-012 to FR-017: Agent definition with required outputSchema.
      Per contracts/agent.ts for type definitions.

      STEPS:
      1. Create packages/core-v2/src/agent/Agent.ts
      2. Define Agent interface with name, activatesOn, emits
      3. Define prompt(state, event) function signature
      4. Make outputSchema REQUIRED (not optional)
      5. Add optional when(state) guard
      6. Add optional onOutput(output, event) transformer

      VERIFY:
      ```bash
      test -f packages/core-v2/src/agent/Agent.ts
      grep -q "outputSchema" packages/core-v2/src/agent/Agent.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/agent/Agent.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Agent interface defined per spec FR-012 to FR-017"
      - "outputSchema is REQUIRED"

  - title: "2.6: Create src/agent/index.ts with public exports (T014)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      STEPS:
      1. Create packages/core-v2/src/agent/index.ts
      2. Re-export Agent, AgentOptions

      VERIFY:
      ```bash
      test -f packages/core-v2/src/agent/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/agent/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Agent module exports defined"

  - title: "2.7: Create src/store/Store.ts with Store Service Tag (T015)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per plan.md Effect Layer Architecture: Store is an Effect Service.
      Per contracts/store.ts for interface.
      Per spec FR-022 to FR-026: Store persistence interface.

      STEPS:
      1. Create packages/core-v2/src/store/Store.ts
      2. Define StoreService interface with append, events, sessions, clear
      3. Create Store Context.Tag("@core-v2/Store")
      4. Add optional snapshot method

      VERIFY:
      ```bash
      test -f packages/core-v2/src/store/Store.ts
      grep -q "Context.Tag" packages/core-v2/src/store/Store.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/store/Store.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Store Effect Service Tag defined"
      - "StoreService interface per spec FR-022 to FR-026"

  - title: "2.8: Create src/provider/Provider.ts with LLMProvider Service Tag (T016)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per plan.md: LLMProvider is an Effect Service for AI providers.
      Per contracts/provider.ts for interface.

      STEPS:
      1. Create packages/core-v2/src/provider/Provider.ts
      2. Define LLMProviderService interface with query, stream methods
      3. Create LLMProvider Context.Tag("@core-v2/LLMProvider")
      4. Define ProviderConfig type

      VERIFY:
      ```bash
      test -f packages/core-v2/src/provider/Provider.ts
      grep -q "Context.Tag" packages/core-v2/src/provider/Provider.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/provider/Provider.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "LLMProvider Effect Service Tag defined"

  - title: "2.9: Create src/event/EventBus.ts with EventBus Service Tag (T017)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per plan.md: EventBus for event emission/subscription.

      STEPS:
      1. Create packages/core-v2/src/event/EventBus.ts
      2. Define EventBusService interface with emit, subscribe, unsubscribe
      3. Create EventBus Context.Tag("@core-v2/EventBus")

      VERIFY:
      ```bash
      test -f packages/core-v2/src/event/EventBus.ts
      grep -q "Context.Tag" packages/core-v2/src/event/EventBus.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/event/EventBus.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "EventBus Effect Service Tag defined"

  - title: "2.10: Create src/handler/HandlerRegistry.ts with Service Tag (T018)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per plan.md: HandlerRegistry maps event names to handlers.

      STEPS:
      1. Create packages/core-v2/src/handler/HandlerRegistry.ts
      2. Define HandlerRegistryService interface with register, get, has
      3. Create HandlerRegistry Context.Tag("@core-v2/HandlerRegistry")

      VERIFY:
      ```bash
      test -f packages/core-v2/src/handler/HandlerRegistry.ts
      grep -q "Context.Tag" packages/core-v2/src/handler/HandlerRegistry.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/handler/HandlerRegistry.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "HandlerRegistry Effect Service Tag defined"

  - title: "2.11: Create src/agent/AgentService.ts with AgentRegistry Service Tag (T019)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per plan.md: AgentRegistry maps agent names to definitions.

      STEPS:
      1. Create packages/core-v2/src/agent/AgentService.ts
      2. Define AgentRegistryService interface with register, get, findMatching
      3. Create AgentRegistry Context.Tag("@core-v2/AgentRegistry")

      VERIFY:
      ```bash
      test -f packages/core-v2/src/agent/AgentService.ts
      grep -q "Context.Tag" packages/core-v2/src/agent/AgentService.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/agent/AgentService.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "AgentRegistry Effect Service Tag defined"

  - title: "2.12: Add UserInputEvent, TextDeltaEvent, TextCompleteEvent schemas (T020)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per contracts/event.ts: Built-in event types for common patterns.

      STEPS:
      1. Add to packages/core-v2/src/event/Event.ts
      2. Define UserInputEvent with content payload
      3. Define TextDeltaEvent with delta payload (streaming)
      4. Define TextCompleteEvent with text payload (final)

      VERIFY:
      ```bash
      grep -q "UserInputEvent" packages/core-v2/src/event/Event.ts
      grep -q "TextDeltaEvent" packages/core-v2/src/event/Event.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'UserInputEvent' packages/core-v2/src/event/Event.ts"
        expect: "UserInputEvent defined"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Built-in event schemas defined"

  - title: "2.13: Add AgentStartedEvent, AgentCompletedEvent schemas (T021)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per contracts/event.ts: Agent lifecycle events.

      STEPS:
      1. Add to packages/core-v2/src/event/Event.ts
      2. Define AgentStartedEvent with agentName payload
      3. Define AgentCompletedEvent with agentName, output payload

      VERIFY:
      ```bash
      grep -q "AgentStartedEvent" packages/core-v2/src/event/Event.ts
      grep -q "AgentCompletedEvent" packages/core-v2/src/event/Event.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'AgentStartedEvent' packages/core-v2/src/event/Event.ts"
        expect: "AgentStartedEvent defined"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Agent lifecycle event schemas defined"

  - title: "2.14: Add ToolCalledEvent, ToolResultEvent schemas (T022)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per contracts/event.ts: Tool execution events.

      STEPS:
      1. Add to packages/core-v2/src/event/Event.ts
      2. Define ToolCalledEvent with toolName, args payload
      3. Define ToolResultEvent with toolName, result payload

      VERIFY:
      ```bash
      grep -q "ToolCalledEvent" packages/core-v2/src/event/Event.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'ToolCalledEvent' packages/core-v2/src/event/Event.ts"
        expect: "ToolCalledEvent defined"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Tool event schemas defined"

  - title: "2.15: Add ErrorOccurredEvent schema (T023)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Per contracts/event.ts: Error handling event.

      STEPS:
      1. Add to packages/core-v2/src/event/Event.ts
      2. Define ErrorOccurredEvent with error, context payload

      VERIFY:
      ```bash
      grep -q "ErrorOccurredEvent" packages/core-v2/src/event/Event.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'ErrorOccurredEvent' packages/core-v2/src/event/Event.ts"
        expect: "ErrorOccurredEvent defined"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Error event schema defined"

  - title: "2.16: Create src/event/EventLog.ts with append-only event log (T024)"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      CONTEXT:
      Internal append-only event log for workflow execution.

      STEPS:
      1. Create packages/core-v2/src/event/EventLog.ts
      2. Implement append-only log using Effect Ref
      3. Provide snapshot and replay capabilities
      4. Export as internal only

      VERIFY:
      ```bash
      test -f packages/core-v2/src/event/EventLog.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/event/EventLog.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Append-only EventLog implemented"

  - title: "2.G: Phase 2 Gate - Foundation Verification"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Foundational"
    details: |
      GATE CHECK:
      All Phase 2 tasks must pass. This BLOCKS all user story implementation.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      test -f packages/core-v2/src/event/Event.ts
      test -f packages/core-v2/src/handler/Handler.ts
      test -f packages/core-v2/src/agent/Agent.ts
      test -f packages/core-v2/src/store/Store.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun run lint"
        expect: "Zero lint errors"
    acceptance:
      - "Phase 2 complete"
      - "All Effect Services defined"
      - "All built-in events defined"
      - "Foundation ready for user stories"

  # ═══════════════════════════════════════════════════════════════
  # Phase 3: User Story 1 - Time-Travel Debugging (P1) - MVP
  # ═══════════════════════════════════════════════════════════════
  - title: "3.1: Create src/tape/Tape.ts with Tape interface (T025) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-027 to FR-038: Tape is THE key feature.
      Per contracts/tape.ts for interface definition.

      STEPS:
      1. Create packages/core-v2/src/tape/Tape.ts
      2. Define Tape interface with position, length, current, state, events
      3. Define TapeStatus type: "idle" | "playing" | "paused" | "recording"
      4. Add isRecording, isReplaying computed flags

      VERIFY:
      ```bash
      test -f packages/core-v2/src/tape/Tape.ts
      grep -q "interface Tape" packages/core-v2/src/tape/Tape.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/tape/Tape.ts && echo 'exists'"
        expect: "exists"
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Tape interface defined per contracts/tape.ts"
      - "Position, length, current, state, events exposed"

  - title: "3.2: Implement rewind() method in Tape (T026) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-028: Tape MUST provide rewind() to return to position 0.

      STEPS:
      1. Implement rewind() in Tape.ts
      2. Set position to 0
      3. Recompute state to initial state
      4. Update current to first event (or undefined if empty)

      VERIFY:
      ```bash
      grep -q "rewind" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts
      ```
    verify:
      - command: "grep 'rewind' packages/core-v2/src/tape/Tape.ts"
        expect: "rewind method found"
    acceptance:
      - "rewind() returns to position 0 with initial state"

  - title: "3.3: Implement step() method in Tape (T027) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-029: Tape MUST provide step() to advance one event forward.

      STEPS:
      1. Implement step() in Tape.ts
      2. Increment position by 1
      3. Clamp at end (do not exceed length - 1)
      4. Recompute state to new position

      VERIFY:
      ```bash
      grep -q "step\(\)" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts
      ```
    verify:
      - command: "grep 'step' packages/core-v2/src/tape/Tape.ts"
        expect: "step method found"
    acceptance:
      - "step() advances one event forward"
      - "Clamps at end"

  - title: "3.4: Implement stepBack() method in Tape - THE KEY FEATURE (T028) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-030: Tape MUST provide stepBack() - THE key feature.
      This is what makes Open Harness fundamentally better than console.log debugging.

      STEPS:
      1. Implement stepBack() in Tape.ts
      2. Decrement position by 1
      3. Clamp at 0 (do not go negative)
      4. Recompute state to new position
      5. Handle edge case: stepBack at position 0 stays at 0

      VERIFY:
      ```bash
      grep -q "stepBack" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "stepBack"
      ```
    verify:
      - command: "grep 'stepBack' packages/core-v2/src/tape/Tape.ts"
        expect: "stepBack method found"
    acceptance:
      - "stepBack() goes backward one event"
      - "Clamps at position 0"
      - "State correctly reverts to previous position"

  - title: "3.5: Implement stepTo(n) method in Tape (T029) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-031: Tape MUST provide stepTo(n) to jump to any position.

      STEPS:
      1. Implement stepTo(n) in Tape.ts
      2. Set position to n
      3. Clamp to valid range [0, length - 1]
      4. Recompute state to new position

      VERIFY:
      ```bash
      grep -q "stepTo" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "stepTo"
      ```
    verify:
      - command: "grep 'stepTo' packages/core-v2/src/tape/Tape.ts"
        expect: "stepTo method found"
    acceptance:
      - "stepTo(n) jumps to any position"
      - "Clamps to valid range"

  - title: "3.6: Implement stateAt(n) method in Tape (T030) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Helper method to compute state at any position without changing current.

      STEPS:
      1. Implement stateAt(n) in Tape.ts
      2. Compute state at position n
      3. Do NOT change tape.position or tape.state
      4. Return computed state

      VERIFY:
      ```bash
      grep -q "stateAt" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "stateAt"
      ```
    verify:
      - command: "grep 'stateAt' packages/core-v2/src/tape/Tape.ts"
        expect: "stateAt method found"
    acceptance:
      - "stateAt(n) computes state without changing position"

  - title: "3.7: Implement computeState utility for state recomputation (T031) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-038: Tape MUST recompute state by replaying handlers.
      This is the core of time-travel debugging.

      STEPS:
      1. Create computeState(events, handlers, initialState, toPosition) in Tape.ts
      2. Start with initialState
      3. For each event from 0 to toPosition:
         - Find matching handler
         - Apply handler: newState = handler(event, currentState).state
      4. Return final computed state

      VERIFY:
      ```bash
      grep -q "computeState" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "computeState"
      ```
    verify:
      - command: "grep 'computeState' packages/core-v2/src/tape/Tape.ts"
        expect: "computeState utility found"
    acceptance:
      - "State recomputation by handler replay works"
      - "Deterministic: same events = same state"

  - title: "3.8: Add TapeStatus and isRecording/isReplaying flags (T032-T033) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per spec FR-037: Tape MUST expose isRecording and isReplaying status flags.

      STEPS:
      1. Add TapeStatus type to Tape.ts
      2. Add status property to Tape
      3. Compute isRecording = status === "recording"
      4. Compute isReplaying = status === "playing"

      VERIFY:
      ```bash
      grep -q "TapeStatus" packages/core-v2/src/tape/Tape.ts
      grep -q "isRecording" packages/core-v2/src/tape/Tape.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'TapeStatus' packages/core-v2/src/tape/Tape.ts"
        expect: "TapeStatus found"
    acceptance:
      - "TapeStatus type defined"
      - "isRecording/isReplaying flags work"

  - title: "3.9: Create src/tape/TapeControls.ts with subset for React (T034) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      CONTEXT:
      Per contracts/tape.ts: TapeControls subset for React hook.

      STEPS:
      1. Create packages/core-v2/src/tape/TapeControls.ts
      2. Define TapeControls interface with control methods only
      3. Exclude internal implementation details

      VERIFY:
      ```bash
      test -f packages/core-v2/src/tape/TapeControls.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/tape/TapeControls.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "TapeControls subset for React defined"

  - title: "3.10: Create src/tape/index.ts with public exports (T035) [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      STEPS:
      1. Create packages/core-v2/src/tape/index.ts
      2. Export Tape, TapeControls, TapeStatus

      VERIFY:
      ```bash
      test -f packages/core-v2/src/tape/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/tape/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Tape module exports defined"

  - title: "3.G: Phase 3 Gate - Time-Travel Verification [US1]"
    completed: false
    parallel_group: 3
    phase: "Phase 3: US1 Time-Travel"
    details: |
      GATE CHECK:
      User Story 1 complete. Time-travel debugging works.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      bun test packages/core-v2/tests/tape.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun test packages/core-v2/tests/tape.test.ts"
        expect: "All tape tests pass"
    acceptance:
      - "US1 complete"
      - "stepBack() works correctly"
      - "State recomputation is deterministic"

  # ═══════════════════════════════════════════════════════════════
  # Phase 4: User Story 2 - Event-Driven Workflow (P2)
  # ═══════════════════════════════════════════════════════════════
  - title: "4.1: Create src/workflow/WorkflowRuntime.ts with Service Tag (T036) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per plan.md: WorkflowRuntime orchestrates the event loop.
      Depends on all other services.

      STEPS:
      1. Create packages/core-v2/src/workflow/WorkflowRuntime.ts
      2. Define WorkflowRuntimeService interface
      3. Create WorkflowRuntime Context.Tag("@core-v2/WorkflowRuntime")

      VERIFY:
      ```bash
      test -f packages/core-v2/src/workflow/WorkflowRuntime.ts
      grep -q "Context.Tag" packages/core-v2/src/workflow/WorkflowRuntime.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/workflow/WorkflowRuntime.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "WorkflowRuntime Service Tag defined"

  - title: "4.2: Implement event loop in WorkflowRuntime (T037) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-001: Event → Handler → (State + Events) → Next Event.

      STEPS:
      1. Implement event loop in WorkflowRuntime
      2. Dequeue event from pending queue
      3. Find matching handler via HandlerRegistry
      4. Execute handler: result = handler(event, state)
      5. Update state and emit result.events
      6. Repeat until queue empty or until() returns true

      VERIFY:
      ```bash
      grep -q "event loop" packages/core-v2/src/workflow/WorkflowRuntime.ts
      bun test packages/core-v2/tests/workflow.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Event loop implemented per spec FR-001"

  - title: "4.3: Implement event routing to handlers (T038) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-002: Route events to registered handlers by event name.

      STEPS:
      1. In event loop, call HandlerRegistry.get(event.name)
      2. If handler found, execute it
      3. If no handler, continue (event may be for renderers only)

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "routing"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Events route to correct handlers"

  - title: "4.4: Implement sequential event processing (T039) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-003: Process events sequentially.

      STEPS:
      1. Ensure one event is fully processed before the next
      2. Handler must complete before processing emitted events
      3. Use Effect.forEach with concurrency: 1

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "sequential"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Events processed one at a time"

  - title: "4.5: Implement agent activation (T040) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-012/FR-015: Agents activate on matching events.

      STEPS:
      1. After handler execution, check AgentRegistry for matching agents
      2. Match on event.name in agent.activatesOn
      3. If agent.when exists, call when(state) to check guard
      4. If activated, execute agent via LLMProvider

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "agent"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Agents activate on matching events"
      - "when() guard respected"

  - title: "4.6: Implement termination condition check (T041) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-040: Workflow terminates when until(state) is true.

      STEPS:
      1. After each event processed, call until(state)
      2. If returns true, stop event loop
      3. Return final state and event log

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "until"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Workflow terminates when until() returns true"

  - title: "4.7: Create src/workflow/Workflow.ts with WorkflowDefinition (T042) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-039/contracts/workflow.ts: Workflow definition interface.

      STEPS:
      1. Create packages/core-v2/src/workflow/Workflow.ts
      2. Define WorkflowDefinition interface with state, handlers, agents, until, store
      3. Define WorkflowResult type

      VERIFY:
      ```bash
      test -f packages/core-v2/src/workflow/Workflow.ts
      grep -q "WorkflowDefinition" packages/core-v2/src/workflow/Workflow.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/workflow/Workflow.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "WorkflowDefinition interface defined"

  - title: "4.8: Implement createWorkflow() factory function (T043) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-039: createWorkflow factory.

      STEPS:
      1. Implement createWorkflow(definition) in Workflow.ts
      2. Return Workflow class instance
      3. Workflow class wraps ManagedRuntime internally

      VERIFY:
      ```bash
      grep -q "createWorkflow" packages/core-v2/src/workflow/Workflow.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'createWorkflow' packages/core-v2/src/workflow/Workflow.ts"
        expect: "createWorkflow found"
    acceptance:
      - "createWorkflow() factory implemented"

  - title: "4.9: Implement Workflow.run() method (T044) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-041: workflow.run() executes via Effect internally, returns Promise.

      STEPS:
      1. Implement run(options: RunOptions) method
      2. Use ManagedRuntime.runPromise internally
      3. Convert Effect result to Promise<WorkflowResult>
      4. Handle errors via Cause → Error conversion

      VERIFY:
      ```bash
      grep -q "run(" packages/core-v2/src/workflow/Workflow.ts
      bun test packages/core-v2/tests/workflow.test.ts --grep "run"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Workflow.run() returns Promise"
      - "Effect internals hidden"

  - title: "4.10: Create EventBusLive Layer implementation (T045) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per plan.md: EventBusLive Layer provides EventBus service.

      STEPS:
      1. Add EventBusLive to src/event/EventBus.ts
      2. Implement using Effect.Ref for subscriber storage
      3. Implement emit, subscribe, unsubscribe

      VERIFY:
      ```bash
      grep -q "EventBusLive" packages/core-v2/src/event/EventBus.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'EventBusLive' packages/core-v2/src/event/EventBus.ts"
        expect: "EventBusLive found"
    acceptance:
      - "EventBusLive Layer implemented"

  - title: "4.11: Create HandlerRegistryLive Layer implementation (T046) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per plan.md: HandlerRegistryLive Layer.

      STEPS:
      1. Add HandlerRegistryLive to src/handler/HandlerRegistry.ts
      2. Implement using Map for handler storage
      3. Implement register, get, has

      VERIFY:
      ```bash
      grep -q "HandlerRegistryLive" packages/core-v2/src/handler/HandlerRegistry.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'HandlerRegistryLive' packages/core-v2/src/handler/HandlerRegistry.ts"
        expect: "HandlerRegistryLive found"
    acceptance:
      - "HandlerRegistryLive Layer implemented"

  - title: "4.12: Create AgentRegistryLive Layer implementation (T047) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per plan.md: AgentRegistryLive Layer.

      STEPS:
      1. Add AgentRegistryLive to src/agent/AgentService.ts
      2. Implement using Map for agent storage
      3. Implement register, get, findMatching

      VERIFY:
      ```bash
      grep -q "AgentRegistryLive" packages/core-v2/src/agent/AgentService.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'AgentRegistryLive' packages/core-v2/src/agent/AgentService.ts"
        expect: "AgentRegistryLive found"
    acceptance:
      - "AgentRegistryLive Layer implemented"

  - title: "4.13: Implement WorkflowRuntimeLive Layer with dependencies (T048) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per plan.md: WorkflowRuntimeLive depends on all other services.

      STEPS:
      1. Add WorkflowRuntimeLive to WorkflowRuntime.ts
      2. Use Effect.gen to yield all dependencies
      3. Implement the event loop using all services

      VERIFY:
      ```bash
      grep -q "WorkflowRuntimeLive" packages/core-v2/src/workflow/WorkflowRuntime.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'WorkflowRuntimeLive' packages/core-v2/src/workflow/WorkflowRuntime.ts"
        expect: "WorkflowRuntimeLive found"
    acceptance:
      - "WorkflowRuntimeLive Layer implemented with all dependencies"

  - title: "4.14: Implement ManagedRuntime composition in Workflow (T049) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per plan.md: ManagedRuntime at boundary hides Effect.

      STEPS:
      1. In Workflow constructor, compose all Layers
      2. Create ManagedRuntime from composed Layer
      3. Use runtime.runPromise for public methods

      VERIFY:
      ```bash
      grep -q "ManagedRuntime" packages/core-v2/src/workflow/Workflow.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'ManagedRuntime' packages/core-v2/src/workflow/Workflow.ts"
        expect: "ManagedRuntime found"
    acceptance:
      - "ManagedRuntime composition hides Effect"

  - title: "4.15: Implement defineEvent() factory (T050) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-043: defineEvent(name, zodSchema) for type-safe events.

      STEPS:
      1. Add defineEvent to src/event/Event.ts
      2. Accept event name and Zod schema
      3. Return EventDefinition with create() and is() methods

      VERIFY:
      ```bash
      grep -q "defineEvent" packages/core-v2/src/event/Event.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'defineEvent' packages/core-v2/src/event/Event.ts"
        expect: "defineEvent found"
    acceptance:
      - "defineEvent() factory per spec FR-043"

  - title: "4.16: Implement defineHandler() factory (T051) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-044: defineHandler(eventDef, handlerFn).

      STEPS:
      1. Add defineHandler to src/handler/Handler.ts
      2. Accept EventDefinition and handler function
      3. Return HandlerDefinition

      VERIFY:
      ```bash
      grep -q "defineHandler" packages/core-v2/src/handler/Handler.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'defineHandler' packages/core-v2/src/handler/Handler.ts"
        expect: "defineHandler found"
    acceptance:
      - "defineHandler() factory per spec FR-044"

  - title: "4.17: Implement agent() factory with required outputSchema (T052) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      CONTEXT:
      Per spec FR-045: agent() factory with REQUIRED outputSchema.

      STEPS:
      1. Add agent() factory to src/agent/Agent.ts
      2. Make outputSchema REQUIRED (throw if missing)
      3. Accept name, activatesOn, emits, prompt, outputSchema, when?, onOutput?

      VERIFY:
      ```bash
      grep -q "export function agent" packages/core-v2/src/agent/Agent.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'agent' packages/core-v2/src/agent/Agent.ts"
        expect: "agent factory found"
    acceptance:
      - "agent() factory with required outputSchema"

  - title: "4.18: Create src/workflow/index.ts with public exports (T053) [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      STEPS:
      1. Create packages/core-v2/src/workflow/index.ts
      2. Export Workflow, WorkflowDefinition, createWorkflow, etc.

      VERIFY:
      ```bash
      test -f packages/core-v2/src/workflow/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/workflow/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Workflow module exports defined"

  - title: "4.G: Phase 4 Gate - Event-Driven Workflow Verification [US2]"
    completed: false
    parallel_group: 4
    phase: "Phase 4: US2 Event-Driven Workflow"
    details: |
      GATE CHECK:
      User Story 2 complete. Event-driven workflow works.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      bun test packages/core-v2/tests/workflow.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun test packages/core-v2/tests/workflow.test.ts"
        expect: "All workflow tests pass"
    acceptance:
      - "US2 complete"
      - "Event loop works"
      - "Handlers and agents execute correctly"

  # ═══════════════════════════════════════════════════════════════
  # Phase 5: User Story 3 - Recording & Replay (P3)
  # ═══════════════════════════════════════════════════════════════
  - title: "5.1: Create src/store/MemoryStore.ts with MemoryStoreLive (T054) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per plan.md: MemoryStoreLive is the default in-memory store.

      STEPS:
      1. Create packages/core-v2/src/store/MemoryStore.ts
      2. Implement MemoryStoreLive Layer
      3. Use Map<sessionId, Event[]> for storage

      VERIFY:
      ```bash
      test -f packages/core-v2/src/store/MemoryStore.ts
      grep -q "MemoryStoreLive" packages/core-v2/src/store/MemoryStore.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/store/MemoryStore.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "MemoryStoreLive implemented"

  - title: "5.2: Create src/store/SqliteStore.ts with SqliteStoreLive (T055) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per plan.md: SqliteStoreLive for production persistence.

      STEPS:
      1. Create packages/core-v2/src/store/SqliteStore.ts
      2. Implement SqliteStoreLive Layer
      3. Use better-sqlite3 or @effect/sql

      VERIFY:
      ```bash
      test -f packages/core-v2/src/store/SqliteStore.ts
      grep -q "SqliteStoreLive" packages/core-v2/src/store/SqliteStore.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/store/SqliteStore.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "SqliteStoreLive implemented"

  - title: "5.3: Implement Store.append(sessionId, event) (T056) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-022: append persists events.

      STEPS:
      1. Implement append in both MemoryStore and SqliteStore
      2. Append event to session's event list
      3. Create session if not exists

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/store.test.ts --grep "append"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Store.append works in both stores"

  - title: "5.4: Implement Store.events(sessionId) (T057) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-023: events retrieves all events for a session.

      STEPS:
      1. Implement events in both stores
      2. Return events in order
      3. Return empty array if session not found

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/store.test.ts --grep "events"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Store.events works in both stores"

  - title: "5.5: Implement Store.sessions() (T058) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-024: sessions lists all recorded sessions.

      STEPS:
      1. Implement sessions in both stores
      2. Return session metadata (id, eventCount, timestamps)

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/store.test.ts --grep "sessions"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Store.sessions works in both stores"

  - title: "5.6: Implement Store.clear(sessionId) (T059) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-025: clear deletes a session's events.

      STEPS:
      1. Implement clear in both stores
      2. Remove session and all its events

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/store.test.ts --grep "clear"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Store.clear works in both stores"

  - title: "5.7: Add record option to Workflow.run() (T060) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-042: record: true persists all events.

      STEPS:
      1. Add record?: boolean to RunOptions
      2. Add sessionId?: string to RunOptions

      VERIFY:
      ```bash
      grep -q "record:" packages/core-v2/src/workflow/Workflow.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'record' packages/core-v2/src/workflow/Workflow.ts"
        expect: "record option found"
    acceptance:
      - "record option added to RunOptions"

  - title: "5.8: Implement recording logic in WorkflowRuntime (T061) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-042: Persist events to Store when recording.

      STEPS:
      1. In event loop, if recording enabled:
      2. Call Store.append(sessionId, event) for each event
      3. Ensure events are persisted before continuing

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "recording"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Events persist to Store when record: true"

  - title: "5.9: Generate sessionId if not provided (T062) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec assumptions: Sessions identified by string IDs.

      STEPS:
      1. If record: true and no sessionId provided
      2. Generate UUID v4 as sessionId
      3. Return sessionId in WorkflowResult

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "sessionId"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "sessionId auto-generated when needed"

  - title: "5.10: Implement Workflow.load(sessionId) returning Tape (T063) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-027: workflow.load returns a Tape.

      STEPS:
      1. Implement load(sessionId) in Workflow class
      2. Fetch events from Store
      3. Create Tape with events and handlers
      4. Return Tape instance

      VERIFY:
      ```bash
      grep -q "load(" packages/core-v2/src/workflow/Workflow.ts
      bun test packages/core-v2/tests/workflow.test.ts --grep "load"
      ```
    verify:
      - command: "grep 'load' packages/core-v2/src/workflow/Workflow.ts"
        expect: "load method found"
    acceptance:
      - "Workflow.load() returns Tape with recorded events"

  - title: "5.11: Implement play() method in Tape (T064) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-032: play from current position to end.

      STEPS:
      1. Implement play() in Tape
      2. Iterate from current position to end
      3. Process each event with delay (configurable)
      4. Update status to "playing"

      VERIFY:
      ```bash
      grep -q "play(" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "play"
      ```
    verify:
      - command: "grep 'play' packages/core-v2/src/tape/Tape.ts"
        expect: "play method found"
    acceptance:
      - "play() replays from current to end"

  - title: "5.12: Implement playTo(n) method in Tape (T065) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-033: playTo plays to specific position.

      STEPS:
      1. Implement playTo(n) in Tape
      2. Play from current position to n
      3. Stop at position n

      VERIFY:
      ```bash
      grep -q "playTo" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "playTo"
      ```
    verify:
      - command: "grep 'playTo' packages/core-v2/src/tape/Tape.ts"
        expect: "playTo method found"
    acceptance:
      - "playTo(n) plays to specific position"

  - title: "5.13: Implement pause() method in Tape (T066) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec FR-034: pause stops playback.

      STEPS:
      1. Implement pause() in Tape
      2. Stop playback
      3. Set status to "paused"

      VERIFY:
      ```bash
      grep -q "pause" packages/core-v2/src/tape/Tape.ts
      bun test packages/core-v2/tests/tape.test.ts --grep "pause"
      ```
    verify:
      - command: "grep 'pause' packages/core-v2/src/tape/Tape.ts"
        expect: "pause method found"
    acceptance:
      - "pause() stops playback"

  - title: "5.14: Ensure replay makes NO LLM calls (T067) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      CONTEXT:
      Per spec: Replay uses recorded events, not live API.

      STEPS:
      1. In replay mode, events come from recording
      2. Do NOT call LLMProvider
      3. Agents should not execute (their events are recorded)

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/integration/replay.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Replay makes zero network calls"

  - title: "5.15: Create src/store/index.ts with exports (T068) [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      STEPS:
      1. Create packages/core-v2/src/store/index.ts
      2. Export Store, MemoryStore, SqliteStore

      VERIFY:
      ```bash
      test -f packages/core-v2/src/store/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/store/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Store module exports defined"

  - title: "5.G: Phase 5 Gate - Recording & Replay Verification [US3]"
    completed: false
    parallel_group: 5
    phase: "Phase 5: US3 Recording & Replay"
    details: |
      GATE CHECK:
      User Story 3 complete. Recording and replay works.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      bun test packages/core-v2/tests/store.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun test packages/core-v2/tests/store.test.ts"
        expect: "All store tests pass"
    acceptance:
      - "US3 complete"
      - "Recording persists events"
      - "Replay loads and plays back"

  # ═══════════════════════════════════════════════════════════════
  # Phase 6: User Story 4 - Event Rendering (P4)
  # ═══════════════════════════════════════════════════════════════
  - title: "6.1: Create src/renderer/Renderer.ts with interface (T069) [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      CONTEXT:
      Per spec FR-018 to FR-021: Renderers are pure observers.
      Per contracts/renderer.ts for interface.

      STEPS:
      1. Create packages/core-v2/src/renderer/Renderer.ts
      2. Define Renderer interface with name, patterns, render
      3. Ensure renderers CANNOT modify events or state

      VERIFY:
      ```bash
      test -f packages/core-v2/src/renderer/Renderer.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/renderer/Renderer.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Renderer interface per spec FR-018 to FR-021"

  - title: "6.2: Implement pattern matching for event names (T070) [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      CONTEXT:
      Per spec FR-020: Pattern matching for event names.

      STEPS:
      1. Implement pattern matching in Renderer
      2. Support exact: "text:delta"
      3. Support wildcard: "error:*", "*:completed", "*"

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/renderer.test.ts --grep "pattern"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Pattern matching works for renderers"

  - title: "6.3: Implement createRenderer() factory (T071) [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      CONTEXT:
      Per spec FR-046: createRenderer factory.

      STEPS:
      1. Implement createRenderer() in Renderer.ts
      2. Accept name and pattern-specific render functions

      VERIFY:
      ```bash
      grep -q "createRenderer" packages/core-v2/src/renderer/Renderer.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'createRenderer' packages/core-v2/src/renderer/Renderer.ts"
        expect: "createRenderer found"
    acceptance:
      - "createRenderer() factory per spec FR-046"

  - title: "6.4: Integrate renderers into WorkflowRuntime (T072) [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      CONTEXT:
      Per spec FR-004: Send events to renderers in parallel with handler.

      STEPS:
      1. In WorkflowRuntime, call renderers for each event
      2. Run in parallel with handler processing
      3. Use Effect.fork for concurrent execution

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "renderer"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Renderers receive events in parallel with handlers"

  - title: "6.5: Ensure renderers are pure observers (T073) [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      CONTEXT:
      Per spec FR-018/FR-019: Renderers cannot modify events or emit new events.

      STEPS:
      1. Renderer.render returns void (no new events)
      2. Events passed to renderers are readonly
      3. Add type safety to prevent mutation

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/renderer.test.ts --grep "pure"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Renderers are pure observers"

  - title: "6.6: Create src/renderer/index.ts with exports (T074) [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      STEPS:
      1. Create packages/core-v2/src/renderer/index.ts
      2. Export Renderer, createRenderer, EventPattern

      VERIFY:
      ```bash
      test -f packages/core-v2/src/renderer/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/renderer/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Renderer module exports defined"

  - title: "6.G: Phase 6 Gate - Renderer Verification [US4]"
    completed: false
    parallel_group: 6
    phase: "Phase 6: US4 Renderers"
    details: |
      GATE CHECK:
      User Story 4 complete.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      bun test packages/core-v2/tests/renderer.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "US4 complete"
      - "Renderers work as pure observers"

  # ═══════════════════════════════════════════════════════════════
  # Phase 7: User Story 5 - Clean Public API (P5)
  # ═══════════════════════════════════════════════════════════════
  - title: "7.1: Audit src/index.ts for zero Effect leakage (T075) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec FR-062: Zero Effect types in public API.

      STEPS:
      1. Review all exports in src/index.ts
      2. Ensure NO Effect, Layer, Context, Stream, etc. exported
      3. Replace any Effect types with plain equivalents

      VERIFY:
      ```bash
      ! grep -q "from 'effect'" packages/core-v2/src/index.ts || echo "No Effect exports"
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Zero Effect types in public API"

  - title: "7.2: Implement Error conversion in boundary.ts (T076) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec FR-063: Convert Effect Cause to standard Error.

      STEPS:
      1. Update boundary.ts error handling
      2. Use Cause.pretty for error messages
      3. Return standard Error objects

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/boundary.test.ts --grep "error"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Effect Cause → Error conversion works"

  - title: "7.3: Ensure all public methods return Promise (T077) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec: Public API uses Promises, not Effect.

      STEPS:
      1. Review all public class methods
      2. Ensure return types are Promise<T>, not Effect<T>
      3. Use ManagedRuntime.runPromise internally

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "All public methods return Promise"

  - title: "7.4: Add JSDoc documentation to public types (T078) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Good DX requires clear documentation.

      STEPS:
      1. Add JSDoc to all public types in index.ts
      2. Include @example where helpful
      3. Document parameters and return types

      VERIFY:
      ```bash
      grep -q "@param" packages/core-v2/src/index.ts || grep -q "/**" packages/core-v2/src/index.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Public types have JSDoc"

  - title: "7.5: Ensure defineEvent returns consumer-friendly type (T079) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec: Consumer-friendly, no @effect/schema internals.

      STEPS:
      1. Review defineEvent return type
      2. Remove any @effect/schema internals from return
      3. Return plain EventDefinition type

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "defineEvent returns consumer-friendly type"

  - title: "7.6: Ensure defineHandler accepts plain function (T080) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec: Plain function signature for handlers.

      STEPS:
      1. Review defineHandler parameter type
      2. Accept plain (event, state) => result function
      3. Return HandlerDefinition

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "defineHandler accepts plain function"

  - title: "7.7: Ensure agent() throws clear error if outputSchema missing (T081) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec: outputSchema is REQUIRED.

      STEPS:
      1. In agent() factory, validate outputSchema present
      2. Throw clear error if missing
      3. Error message should explain why it's required

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/agent.test.ts --grep "outputSchema"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Clear error if outputSchema missing"

  - title: "7.8: Implement Workflow.dispose() for cleanup (T082) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Per spec FR-064: Resource safety.

      STEPS:
      1. Implement dispose() in Workflow class
      2. Call ManagedRuntime.dispose()
      3. Clean up all resources

      VERIFY:
      ```bash
      grep -q "dispose" packages/core-v2/src/workflow/Workflow.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'dispose' packages/core-v2/src/workflow/Workflow.ts"
        expect: "dispose method found"
    acceptance:
      - "Workflow.dispose() cleans up resources"

  - title: "7.9: Add WorkflowCallbacks to run options (T083) [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      CONTEXT:
      Callbacks for onEvent, onStateChange, onError.

      STEPS:
      1. Add WorkflowCallbacks interface
      2. Add callbacks to RunOptions
      3. Call callbacks during workflow execution

      VERIFY:
      ```bash
      grep -q "onEvent" packages/core-v2/src/workflow/Workflow.ts
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "WorkflowCallbacks implemented"

  - title: "7.G: Phase 7 Gate - Clean API Verification [US5]"
    completed: false
    parallel_group: 7
    phase: "Phase 7: US5 Clean API"
    details: |
      GATE CHECK:
      User Story 5 complete.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      ! grep -q "from 'effect'" packages/core-v2/src/index.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun run lint"
        expect: "Zero lint errors"
    acceptance:
      - "US5 complete"
      - "Zero Effect types in public API"

  # ═══════════════════════════════════════════════════════════════
  # Phase 8: User Story 6 - React Integration (P6)
  # ═══════════════════════════════════════════════════════════════
  - title: "8.1: Create src/message/Message.ts with Message type (T084) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-047 to FR-053: AI SDK-compatible Message type.
      Per contracts/message.ts for interface.

      STEPS:
      1. Create packages/core-v2/src/message/Message.ts
      2. Define Message with id, role, content, name, toolInvocations, _events

      VERIFY:
      ```bash
      test -f packages/core-v2/src/message/Message.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/message/Message.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Message type per contracts/message.ts"

  - title: "8.2: Create src/message/projection.ts with projectEventsToMessages (T085) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-047 to FR-053: Events → Messages projection.

      STEPS:
      1. Create packages/core-v2/src/message/projection.ts
      2. Implement projectEventsToMessages(events) function

      VERIFY:
      ```bash
      test -f packages/core-v2/src/message/projection.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/message/projection.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Event → Message projection implemented"

  - title: "8.3: Implement user:input → user message projection (T086) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-047: user:input → { role: "user", content }.

      STEPS:
      1. Handle user:input events in projection
      2. Create Message with role: "user"
      3. Set content from event payload

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "user:input"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "user:input projects to user message"

  - title: "8.4: Implement text:delta accumulation (T087) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-048: Accumulate text:delta into assistant message.

      STEPS:
      1. Handle text:delta events
      2. Append delta to current assistant message content
      3. Track accumulation state

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "text:delta"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "text:delta accumulates into assistant message"

  - title: "8.5: Implement text:complete finalization (T088) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-049: Finalize assistant message on text:complete.

      STEPS:
      1. Handle text:complete events
      2. Finalize current assistant message
      3. Prepare for next message

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "text:complete"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "text:complete finalizes assistant message"

  - title: "8.6: Implement agent:started → new assistant message (T089) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-052: New assistant message with agent name.

      STEPS:
      1. Handle agent:started events
      2. Create new Message with role: "assistant"
      3. Set name from agent name

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "agent:started"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "agent:started creates new assistant message"

  - title: "8.7: Implement tool:called → toolInvocations (T090) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-050: tool:called → message.toolInvocations[].

      STEPS:
      1. Handle tool:called events
      2. Add to toolInvocations array
      3. Set state: "pending"

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "tool:called"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "tool:called adds to toolInvocations"

  - title: "8.8: Implement tool:result → update toolInvocation (T091) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-051: tool:result updates toolInvocation.result.

      STEPS:
      1. Handle tool:result events
      2. Find matching toolInvocation
      3. Update result and state

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "tool:result"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "tool:result updates toolInvocation"

  - title: "8.9: Include _events array in messages (T092) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-053: Messages include _events for traceability.

      STEPS:
      1. Track source events for each message
      2. Add _events array to Message
      3. Include event IDs

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/message.test.ts --grep "_events"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Messages include _events array"

  - title: "8.10: Create useWorkflow hook signature (T093) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-054 to FR-056: useWorkflow hook.

      STEPS:
      1. Update packages/core-v2/src/react.ts
      2. Define useWorkflow hook signature
      3. Define UseWorkflowReturn interface

      VERIFY:
      ```bash
      grep -q "useWorkflow" packages/core-v2/src/react.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'useWorkflow' packages/core-v2/src/react.ts"
        expect: "useWorkflow found"
    acceptance:
      - "useWorkflow hook signature defined"

  - title: "8.11: Implement AI SDK compatible values in hook (T094) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-054: messages, input, setInput, handleSubmit, isLoading, error.

      STEPS:
      1. Implement messages via projectEventsToMessages
      2. Implement input/setInput with useState
      3. Implement handleSubmit
      4. Implement isLoading/error state

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/react.test.ts --grep "AI SDK"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "AI SDK compatible values implemented"

  - title: "8.12: Implement Open Harness unique values in hook (T095) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-055: events, state.

      STEPS:
      1. Expose events array from workflow
      2. Expose current state

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/react.test.ts --grep "events"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "events and state exposed"

  - title: "8.13: Implement tape controls in hook (T096) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-056: tape object with controls.

      STEPS:
      1. Expose tape from hook
      2. Tape controls update React state when used

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/react.test.ts --grep "tape"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Tape controls work in React"

  - title: "8.14: Implement cleanup on unmount (T097) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per React best practices: cleanup on unmount.

      STEPS:
      1. Use useEffect cleanup
      2. Call workflow.dispose() on unmount

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/react.test.ts --grep "cleanup"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Cleanup on unmount implemented"

  - title: "8.15: Implement WorkflowProvider component (T098) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-057: WorkflowProvider for React context.

      STEPS:
      1. Create WorkflowProvider component
      2. Use React.createContext
      3. Allow nested useWorkflow calls

      VERIFY:
      ```bash
      grep -q "WorkflowProvider" packages/core-v2/src/react.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'WorkflowProvider' packages/core-v2/src/react.ts"
        expect: "WorkflowProvider found"
    acceptance:
      - "WorkflowProvider component implemented"

  - title: "8.16: Implement WorkflowChat convenience component (T099) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      CONTEXT:
      Per spec FR-058: Zero-config chat UI.

      STEPS:
      1. Create WorkflowChat component
      2. Render messages list
      3. Include input and submit button

      VERIFY:
      ```bash
      grep -q "WorkflowChat" packages/core-v2/src/react.ts
      bun run typecheck
      ```
    verify:
      - command: "grep 'WorkflowChat' packages/core-v2/src/react.ts"
        expect: "WorkflowChat found"
    acceptance:
      - "WorkflowChat convenience component"

  - title: "8.17: Create src/message/index.ts with exports (T100) [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      STEPS:
      1. Create packages/core-v2/src/message/index.ts
      2. Export Message, projectEventsToMessages

      VERIFY:
      ```bash
      test -f packages/core-v2/src/message/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/message/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Message module exports defined"

  - title: "8.G: Phase 8 Gate - React Integration Verification [US6]"
    completed: false
    parallel_group: 8
    phase: "Phase 8: US6 React Integration"
    details: |
      GATE CHECK:
      User Story 6 complete.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      bun test packages/core-v2/tests/react.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "US6 complete"
      - "React hook works"
      - "AI SDK compatible"

  # ═══════════════════════════════════════════════════════════════
  # Phase 9: LLM Provider Integration
  # ═══════════════════════════════════════════════════════════════
  - title: "9.1: Create src/provider/ClaudeProvider.ts with ClaudeProviderLive (T101)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      CONTEXT:
      Per plan.md: Claude as default LLM provider.

      STEPS:
      1. Create packages/core-v2/src/provider/ClaudeProvider.ts
      2. Implement ClaudeProviderLive Layer
      3. Use @anthropic-ai/claude-agent-sdk

      VERIFY:
      ```bash
      test -f packages/core-v2/src/provider/ClaudeProvider.ts
      bun run typecheck
      ```
    verify:
      - command: "test -f packages/core-v2/src/provider/ClaudeProvider.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "ClaudeProviderLive Layer created"

  - title: "9.2: Implement Stream.fromAsyncIterable for SDK stream (T102)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      CONTEXT:
      Per plan.md: Convert SDK stream to Effect Stream.

      STEPS:
      1. Use Stream.fromAsyncIterable to wrap SDK stream
      2. Handle streaming text deltas

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "SDK stream converted to Effect Stream"

  - title: "9.3: Implement Effect.acquireRelease for cleanup (T103)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      CONTEXT:
      Per spec FR-064: Resource safety.

      STEPS:
      1. Use Effect.acquireRelease for SDK connection
      2. Ensure cleanup on abort/error

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Resource safety implemented"

  - title: "9.4: Implement structured output conversion (T104)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      CONTEXT:
      Per spec FR-067: outputFormat with JSON Schema.

      STEPS:
      1. Convert Zod outputSchema to JSON Schema
      2. Pass to SDK as outputFormat: { type: "json_schema", schema }

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Zod → JSON Schema → SDK outputFormat"

  - title: "9.5: Map SDK messages to internal Event types (T105)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      CONTEXT:
      Per contracts/event.ts: Map SDK messages to events.

      STEPS:
      1. Map SDK text delta to TextDeltaEvent
      2. Map SDK tool call to ToolCalledEvent
      3. Map SDK complete to TextCompleteEvent

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "SDK messages map to Event types"

  - title: "9.6: Implement abort handling (T106)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      CONTEXT:
      Per spec FR-068: AbortController support.

      STEPS:
      1. Pass AbortController to SDK
      2. Handle abort signal

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Abort handling implemented"

  - title: "9.7: Create src/provider/index.ts with exports (T107)"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      STEPS:
      1. Create packages/core-v2/src/provider/index.ts
      2. Export ClaudeProviderLive

      VERIFY:
      ```bash
      test -f packages/core-v2/src/provider/index.ts
      ```
    verify:
      - command: "test -f packages/core-v2/src/provider/index.ts && echo 'exists'"
        expect: "exists"
    acceptance:
      - "Provider module exports defined"

  - title: "9.G: Phase 9 Gate - Provider Verification"
    completed: false
    parallel_group: 9
    phase: "Phase 9: LLM Provider"
    details: |
      GATE CHECK:
      LLM Provider integration complete.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Phase 9 complete"
      - "Claude SDK integration works"

  # ═══════════════════════════════════════════════════════════════
  # Phase 10: Polish & Cross-Cutting Concerns
  # ═══════════════════════════════════════════════════════════════
  - title: "10.1: Handle stepBack() at position 0 (T108)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec edge cases: Remain at position 0.

      STEPS:
      1. In stepBack(), check if position === 0
      2. If so, return without changing
      3. State remains initial state

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/tape.test.ts --grep "position 0"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "stepBack at 0 handled correctly"

  - title: "10.2: Handle step() past last event (T109)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec edge cases: Stay at final position.

      STEPS:
      1. In step(), check if position >= length - 1
      2. If so, return without changing

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/tape.test.ts --grep "past end"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "step past end handled correctly"

  - title: "10.3: Handle handler exceptions (T110)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec edge cases: Emit error:occurred and continue.

      STEPS:
      1. Catch handler exceptions in event loop
      2. Emit ErrorOccurredEvent with error details
      3. Continue processing

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/workflow.test.ts --grep "exception"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Handler exceptions emit error event"

  - title: "10.4: Handle unknown event type in replay (T111)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec edge cases: Skip gracefully with warning.

      STEPS:
      1. In replay, handle unknown event types
      2. Log warning
      3. Continue to next event

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/tape.test.ts --grep "unknown"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Unknown events skipped with warning"

  - title: "10.5: Handle Store unavailable during recording (T112)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec edge cases: Fail fast with clear error.

      STEPS:
      1. Detect Store unavailable
      2. Throw clear error immediately
      3. Do not lose events silently

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/store.test.ts --grep "unavailable"
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Store unavailable fails fast"

  - title: "10.6: Implement createWorkflowHandler for server (T113)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec FR-059: Server-side execution.

      STEPS:
      1. Implement createWorkflowHandler(workflow)
      2. Return HTTP handler function
      3. Handle request/response

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Server handler implemented"

  - title: "10.7: Add api option to useWorkflow (T114)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec FR-060: Client-server connection.

      STEPS:
      1. Add api option to useWorkflow
      2. If api provided, connect to server endpoint

      VERIFY:
      ```bash
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Client-server connection via api option"

  - title: "10.8: Run quickstart examples as integration tests (T115)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec verification: All user stories work together.

      STEPS:
      1. Create integration test from quickstart.md examples
      2. Run all examples
      3. Verify they work end-to-end

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/integration/quickstart.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Quickstart examples pass as tests"

  - title: "10.9: Verify 100% Effect-free public API (T116)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec SC-002: Zero Effect types in exports.

      STEPS:
      1. Create consumer test file
      2. Import from @core-v2
      3. Verify tsc compiles without Effect

      VERIFY:
      ```bash
      ! grep -q "from 'effect'" packages/core-v2/src/index.ts
      bun run typecheck
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Zero Effect types in public API verified"

  - title: "10.10: Verify deterministic replay (T117)"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      CONTEXT:
      Per spec SC-004: Identical state 100 times.

      STEPS:
      1. Record a session
      2. Replay 100 times
      3. Verify state identical at each position

      VERIFY:
      ```bash
      bun test packages/core-v2/tests/integration/determinism.test.ts
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
    acceptance:
      - "Deterministic replay verified 100x"

  - title: "10.G: Phase 10 Final Gate - Full Verification"
    completed: false
    parallel_group: 10
    phase: "Phase 10: Polish"
    details: |
      FINAL GATE CHECK:
      All phases complete. Full verification.

      VERIFY:
      ```bash
      bun run typecheck
      bun run lint
      bun run test
      ```
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun run lint"
        expect: "Zero lint errors"
      - command: "bun run test"
        expect: "All tests pass"
    acceptance:
      - "All phases complete"
      - "All user stories verified"
      - "Feature ready for merge"
