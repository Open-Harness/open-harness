# Declarative Agent Pattern - Task List
# Generated: 2026-01-19
# PRD: .ralphy/PRD.md

metadata:
  name: "Declarative Agent Pattern with Structured Outputs"
  branch: "feat/handler-pattern-dx-cli"
  prd: ".ralphy/PRD.md"
  total_tasks: 9
  total_phases: 4

tasks:
  # ═══════════════════════════════════════════════════════════════════════════
  # Phase 1: Dependencies & Core Utility
  # ═══════════════════════════════════════════════════════════════════════════
  - title: "1.1: Verify Zod 4 native JSON Schema support"
    completed: true
    parallel_group: 1
    phase: "Phase 1: Dependencies & Core Utility"
    details: |
      UPDATED: The original task specified zod-to-json-schema, but that library
      doesn't support Zod 4.x (returns empty schema). Zod 4 has native JSON
      Schema support via z.toJSONSchema() - no additional dependency needed.

      ACTUAL STEPS:
      1. Tested zod-to-json-schema - confirmed incompatible with zod 4.x
      2. Verified z.toJSONSchema() works natively with zod 4.x
      3. Removed zod-to-json-schema dependency (not needed)

      IMPLEMENTATION NOTE FOR TASK 1.2:
      Use z.toJSONSchema(schema) instead of zodToJsonSchema(schema, options)
    verify:
      - command: "bun -e \"import { z } from 'zod'; console.log(z.toJSONSchema(z.object({x:z.string()})))\""
        expect: "Returns valid JSON Schema"
    acceptance:
      - "Zod 4 native z.toJSONSchema() verified working"
      - "No additional dependencies required"

  - title: "1.2: Create defineAgent utility"
    completed: true
    parallel_group: 1
    phase: "Phase 1: Dependencies & Core Utility"
    details: |
      Create the defineAgent() function that accepts Zod schemas and
      converts them to JSON schema for the harness.

      Location: packages/internal/core/src/api/define-agent.ts

      INTERFACE:
      - Accept AgentDefinition with optional outputSchema (Zod type)
      - Convert Zod → JSON schema using z.toJSONSchema() (Zod 4 native)
      - Return CompiledAgent with both zodSchema and jsonSchema
      - Support prompt as string OR function of ActivationContext

      EXPORTS:
      - defineAgent function
      - AgentDefinition type
      - CompiledAgent type
    verify:
      - command: "grep -l 'defineAgent' packages/internal/core/src/api/define-agent.ts"
        expect: "File exists with defineAgent"
      - command: "grep 'toJSONSchema' packages/internal/core/src/api/define-agent.ts"
        expect: "Uses z.toJSONSchema()"
    acceptance:
      - "defineAgent() accepts Zod schema in outputSchema"
      - "Converts to JSON schema using z.toJSONSchema()"
      - "Exports types for external use"

  - title: "1.3: Export defineAgent from @internal/core"
    completed: true
    parallel_group: 1
    phase: "Phase 1: Dependencies & Core Utility"
    details: |
      Add defineAgent to the public exports of @internal/core package.

      Location: packages/internal/core/src/index.ts

      STEPS:
      1. Import from ./api/define-agent.js
      2. Re-export defineAgent, AgentDefinition, CompiledAgent
    verify:
      - command: "grep 'defineAgent' packages/internal/core/src/index.ts"
        expect: "Exported from index"
    acceptance:
      - "defineAgent importable from @internal/core"

  # ═══════════════════════════════════════════════════════════════════════════
  # Phase 2: Shared Schemas
  # ═══════════════════════════════════════════════════════════════════════════
  - title: "2.1: Create plan.schema.ts with Zod schemas"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Shared Schemas"
    details: |
      Create shared Zod schemas for planning-related payloads.
      These will be used by BOTH agents AND handlers.

      Location: packages/prd-workflow/src/schemas/plan.schema.ts

      SCHEMAS TO CREATE:
      - TaskSchema (matches existing Task interface)
      - MilestoneSchema (matches existing Milestone interface)
      - PlanCreatedPayloadSchema (tasks, milestones, taskOrder)

      MUST:
      - Use .describe() for documentation
      - Export inferred types: Task, Milestone, PlanCreatedPayload
      - Match structure in types.ts exactly
    verify:
      - command: "grep -l 'PlanCreatedPayloadSchema' packages/prd-workflow/src/schemas/plan.schema.ts"
        expect: "Schema file exists"
    acceptance:
      - "All schemas defined with Zod"
      - "Types exported via z.infer"
      - "Structure matches types.ts"

  - title: "2.2: Create schemas index and update types.ts"
    completed: false
    parallel_group: 2
    phase: "Phase 2: Shared Schemas"
    details: |
      Create index file for schemas and update types.ts to use shared types.

      FILES:
      1. packages/prd-workflow/src/schemas/index.ts
         - Re-export all schemas and types from plan.schema.ts

      2. packages/prd-workflow/src/types.ts
         - Import types from schemas instead of defining locally
         - Keep backward compatibility (re-export if needed)
    verify:
      - command: "grep 'from.*schemas' packages/prd-workflow/src/types.ts"
        expect: "types.ts imports from schemas"
    acceptance:
      - "schemas/index.ts exports all schemas"
      - "types.ts uses shared types"
      - "No duplicate type definitions"

  # ═══════════════════════════════════════════════════════════════════════════
  # Phase 3: Agent & Workflow Wiring
  # ═══════════════════════════════════════════════════════════════════════════
  - title: "3.1: Create planner.agent.ts"
    completed: false
    parallel_group: 3
    phase: "Phase 3: Agent & Workflow Wiring"
    details: |
      Create the planner agent using defineAgent with Zod schema.

      Location: packages/prd-workflow/src/agents/planner.agent.ts

      MUST INCLUDE:
      - Import defineAgent from @internal/core
      - Import PlanCreatedPayloadSchema from ../schemas
      - Define prompt that instructs Claude to return structured plan
      - Set activateOn: ["workflow:start"]
      - Set emits: ["plan:created"]
      - Set outputSchema: PlanCreatedPayloadSchema
    verify:
      - command: "grep 'defineAgent' packages/prd-workflow/src/agents/planner.agent.ts"
        expect: "Uses defineAgent"
      - command: "grep 'outputSchema' packages/prd-workflow/src/agents/planner.agent.ts"
        expect: "Has outputSchema"
    acceptance:
      - "Agent defined with defineAgent()"
      - "Uses PlanCreatedPayloadSchema"
      - "Prompt instructs structured output"

  - title: "3.2: Update create-workflow.ts to wire schemas"
    completed: false
    parallel_group: 3
    phase: "Phase 3: Agent & Workflow Wiring"
    details: |
      Modify the workflow to pass JSON schema to harness and use
      structuredOutput for signal payloads.

      Location: packages/internal/core/src/api/create-workflow.ts

      CHANGES:
      1. When calling harness, pass agent.jsonSchema as input.outputSchema
      2. When emitting signals, check for result.structuredOutput
      3. If structuredOutput exists, use it as payload directly
      4. If not, fall back to { agent, output } wrapper

      FIND the signal emission code (around line 896-904):
      ```typescript
      for (const signalName of agentConfig.emits ?? []) {
        bus.emit(createSignal(signalName, { agent: name, output: result }));
      }
      ```

      CHANGE TO:
      ```typescript
      for (const signalName of agentConfig.emits ?? []) {
        const payload = result.structuredOutput ?? { agent: name, output: result.content };
        bus.emit(createSignal(signalName, payload, { agent: name }));
      }
      ```
    verify:
      - command: "grep 'structuredOutput' packages/internal/core/src/api/create-workflow.ts"
        expect: "Uses structuredOutput"
      - command: "grep 'jsonSchema\\|outputSchema' packages/internal/core/src/api/create-workflow.ts"
        expect: "Passes schema to harness"
    acceptance:
      - "JSON schema passed to harness input"
      - "structuredOutput used as signal payload"
      - "Fallback for text-only agents"

  - title: "3.3: Update CLI to use planner agent"
    completed: false
    parallel_group: 3
    phase: "Phase 3: Agent & Workflow Wiring"
    details: |
      Update the CLI to import and use the new planner agent.

      Location: packages/prd-workflow/src/cli.ts

      CHANGES:
      1. Import plannerAgent from ./agents/planner.agent.js
      2. Remove inline agent definition (lines ~237-251)
      3. Pass plannerAgent to runPRDWorkflow

      BEFORE:
      ```typescript
      const planner = agent({
        prompt: `You are analyzing...`,
        activateOn: ["workflow:start"],
        emits: ["plan:created"],
      });
      ```

      AFTER:
      ```typescript
      import { plannerAgent } from "./agents/planner.agent.js";
      // ... later ...
      agents: { planner: plannerAgent },
      ```
    verify:
      - command: "grep 'plannerAgent' packages/prd-workflow/src/cli.ts"
        expect: "Imports plannerAgent"
    acceptance:
      - "Inline agent definition removed"
      - "plannerAgent imported and used"
      - "CLI still runs"

  # ═══════════════════════════════════════════════════════════════════════════
  # Phase 4: Verification
  # ═══════════════════════════════════════════════════════════════════════════
  - title: "4.1: Run quality gates and live test"
    completed: false
    parallel_group: 4
    phase: "Phase 4: Verification"
    details: |
      Run all quality checks and verify live workflow completes.

      STEPS:
      1. bun run typecheck - Zero errors
      2. bun run lint - Zero warnings
      3. bun run test - All pass
      4. cd packages/prd-workflow && bun run prd:live ../../examples/hello-world.prd.md
         - Must call real Claude API
         - Must receive structured output
         - Handler must process without crash
         - Workflow must complete
    verify:
      - command: "bun run typecheck"
        expect: "Zero errors"
      - command: "bun run lint"
        expect: "Zero warnings"
      - command: "bun run test"
        expect: "All pass"
    acceptance:
      - "Type check passes"
      - "Lint passes"
      - "Tests pass"
      - "Live workflow completes without handler crash"
