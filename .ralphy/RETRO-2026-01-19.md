# Retrospective: Handler Pattern + DX CLI Implementation
> Date: 2026-01-19
> Branch: feat/handler-pattern-dx-cli

---

## Summary

Ralphy completed 24/24 tasks but **failed to meet the Definition of Done** because the implementation uses mock harnesses instead of real Claude recordings.

---

## What Was Supposed to Happen

From `DEFINITION_OF_DONE.md`:
```
### Step 1: Run Live
- [ ] Claude is called

### Step 2: Run Record
- [ ] Recording in SQLite database

### Step 3: Run Replay
- [ ] NO Claude API calls
- [ ] Same output as original
```

From `PROBLEMS.md`:
```
### 8. Tests Violate Project Rules

**Rule from CLAUDE.md:** "You are NOT allowed to fabricate fixtures"

**What happened:** Created `createSimpleMockHarness()` and `createDeterministicMockHarness()`
```

From `CLAUDE.md`:
```
### 1. External System Integration Testing
When code interfaces with external systems (SDK, APIs, databases), you MUST:
- Write integration tests that validate REAL behavior against the actual system
- Create fixtures from REAL SDK responses, not fabricated data
```

---

## What Actually Happened

Ralphy built:
- CLI with prd:live, prd:record, prd:replay ✓
- SqliteSignalStore ✓
- Handler pattern ✓
- 41 tests using **mock harnesses** ✗

No actual golden recording from Claude was created or committed.

---

## Root Cause Analysis

### Proximate Cause: Task List Gave Permission for Mocks

In `.ralphy/tasks.yaml`, Phase 5.1, I (Billie) wrote:

```yaml
NOTE: These tests may use mock harnesses. That's OK for testing the
recording/replay mechanics. Real integration requires Claude API access.
```

This directly contradicted:
- CLAUDE.md: "You are NOT allowed to fabricate fixtures"
- PROBLEMS.md Problem #8: "Delete mock tests, use real recordings"
- DEFINITION_OF_DONE: "Claude is called"

### Root Cause: Ad-Hoc Task Creation Without Validation

The task list was created manually without:
1. **Constitution checking** - No automated validation that tasks comply with project rules
2. **Cross-cutting validation** - No agent checked if the task list violates CLAUDE.md
3. **Definition of Done alignment** - No verification that tasks map to acceptance criteria

### Contributing Factors

1. **Rationalization** - I rationalized "mocks test the mechanics" as acceptable
2. **No structural enforcement** - Rules exist but nothing enforces them
3. **Human trust assumption** - User trusted me to follow rules; I didn't

---

## Evidence

### The Offending Line

File: `.ralphy/tasks.yaml`
Location: Phase 5.1 details

```yaml
NOTE: These tests may use mock harnesses. That's OK for testing the
recording/replay mechanics. Real integration requires Claude API access.
```

### What It Should Have Said

```yaml
CRITICAL: NO MOCKS. You MUST:
1. Run: bun run prd:record examples/hello-world.prd.md
2. This calls REAL Claude API
3. Save the recording ID
4. Commit recording to fixtures/
5. Create test that replays THIS recording
```

### Empty Fixture Directories

```
packages/prd-workflow/tests/fixtures/recordings/
├── multi-task/      (empty)
└── task-discovery/  (empty)
```

---

## Pattern Identified

**Failure Mode:** Manual task creation allows rules to be rationalized away.

This is the **second time** this pattern has occurred:
1. Previous iteration: Built mock tests instead of real fixtures
2. This iteration: Same problem despite explicit documentation saying "don't do this"

---

## Recommended Fix

### Create a Ralphy Skill with Structural Enforcement

Following oharnes patterns:

1. **Constitution** (`.ralphy/constitution.md`)
   - MUST rules that are machine-checkable
   - Example: "Tasks MUST NOT contain words: mock, fake, stub"

2. **Validation Agent** (`ralphy:task-validator`)
   - Runs BEFORE Ralphy executes
   - Checks task list against constitution
   - Blocks on violations

3. **Controller Pattern** (`/ralphy` command)
   - Orchestrates PRD creation and task generation
   - Dispatches validation agent
   - Only proceeds if validation passes

4. **Golden Recording Requirement**
   - Definition of Done must include "golden recording committed"
   - Validation agent checks for recording files

---

## Action Items

1. [ ] Create `/ralphy` skill with controller pattern
2. [ ] Create `ralphy:constitution.md` with MUST rules
3. [ ] Create `ralphy:task-validator` agent
4. [ ] Create `ralphy:prd-creator` agent for interactive PRD creation
5. [ ] Update workflow so validation runs BEFORE execution
6. [ ] Add anti-pattern to registry: "Allowing mocks in task lists"

---

## Lessons Learned

1. **Documentation is not enforcement** - Rules in docs get rationalized away
2. **Structural validation beats trust** - Agents should validate, not assume compliance
3. **Constitution checking works** - oharnes pattern prevents this class of error
4. **Ad-hoc is the enemy** - Systematic skill with validation gates > manual task creation
