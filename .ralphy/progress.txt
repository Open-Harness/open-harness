# Ralphy Progress Log
# Feature: Immer + ProcessManager State Management
# Branch: feat/immer-signals-state-management
# Started: 2026-01-18

## 2026-01-19 - Phase 0: Branch Consolidation (COMPLETE)

### Task: Consolidate branches - add Immer + ProcessManager foundation

**Context**: Commit 24106cc referenced in tasks.yaml was not found in repository.
Implemented the Immer + ProcessManager pattern from scratch.

**Changes Made**:

1. **Added Immer dependency** (`packages/internal/core/package.json`)
   - `immer@11.1.3` added to dependencies

2. **Created ProcessManager types** (`packages/internal/core/src/api/create-workflow.ts`)
   - `ProcessManager<TState>` - Function type: `(state: Readonly<TState>, signal: Signal) => Signal[]`
   - `ProcessManagers<TState>` - Map of signal patterns to process managers
   - Added comprehensive JSDoc with CQRS explanation and examples

3. **Updated ReactiveWorkflowConfig**
   - Added `processes?: ProcessManagers<TState>` field
   - Updated `reducers` documentation to reference Immer

4. **Integrated Immer into reducer execution**
   - Imported `produce` from immer
   - Wrapped reducer calls in `produce()` for clean immutable updates
   - Reducers can now use direct mutations: `state.foo = bar`

5. **Implemented process manager execution**
   - Process managers run after reducers
   - Receive read-only state, emit derived signals
   - CQRS pattern: reducers = command side, processes = query side

6. **Exported new types** (`packages/internal/core/src/api/index.ts`)
   - SignalReducer, SignalReducers, ProcessManager, ProcessManagers

### GATE: Verification Passed
- `bun run typecheck` - 14 packages, 0 errors
- `bun run lint` - 13 packages, no fixes needed
- `bun run test` - 10 suites, 179+ tests passed

## 2026-01-19 - Phase 1: PRD Workflow Refactor (IN PROGRESS)

### Task: Create processes/index.ts with orchestration logic

**Context**: The prd-workflow package was essentially empty. Created the complete package
structure from scratch following the CQRS pattern documented in Phase 0.

**Files Created**:

1. **packages/prd-workflow/package.json**
   - Package configuration for @internal/prd-workflow
   - Dependencies: @internal/core, @internal/signals, @internal/signals-core, immer, zod
   - Scripts: test, typecheck, lint

2. **packages/prd-workflow/tsconfig.json**
   - TypeScript configuration extending root config

3. **packages/prd-workflow/src/types.ts**
   - `PRDWorkflowState` - Main state interface with planning, execution, review slices
   - `Task`, `Milestone`, `DiscoveredTask` - Domain types
   - `PlanningPhase`, `ExecutionPhase`, `ReviewPhase` - State machine phases
   - `createInitialState()` - Factory function

4. **packages/prd-workflow/src/processes/index.ts**
   - Process managers implementing CQRS orchestration pattern
   - Signal handlers:
     - `plan:created` → `task:ready` (first task) or `workflow:complete` (no tasks)
     - `task:complete` → `discovery:submitted` (if discoveries exist)
     - `task:approved` → `milestone:testable` (all tasks done) or `task:ready` (next task)
     - `milestone:passed` → `workflow:complete` (all done) or `task:ready` (next)
     - `milestone:failed` → `fix:required` or `milestone:retry`
     - `discovery:reviewed` → `task:approved`
   - Helper functions for task/milestone queries

5. **packages/prd-workflow/src/index.ts**
   - Package exports: types, createInitialState, processes

6. **packages/prd-workflow/tests/processes.test.ts**
   - 12 tests covering all process managers
   - Tests for edge cases: empty tasks, skipped tasks, milestone completion

### GATE: Verification Passed
- `bun run typecheck` - 15 packages (including new prd-workflow), 0 errors
- `bun run lint` - 14 packages, no fixes needed
- `bun run test` - 11 suites, all passed (including 12 new process tests)

### Task: Refactor planning.ts reducer - remove ctx.emit, use Immer mutations

**Context**: Created the planning reducer module following CQRS command-side pattern.
Reducers handle state mutations; orchestration signals already handled by process managers.

**Files Created**:

1. **packages/prd-workflow/src/reducers/planning.ts**
   - 4 reducers using Immer Draft pattern for type-safe direct mutations
   - `planStartReducer` - Transitions to "planning" phase, optionally updates PRD
   - `planCreatedReducer` - Stores tasks, milestones, taskOrder; transitions to "plan_complete"
   - `discoverySubmittedReducer` - Stores discoveries; transitions to "discovery_review"
   - `discoveryReviewedReducer` - Adds accepted tasks to plan; clears discoveries

2. **packages/prd-workflow/src/reducers/index.ts**
   - Combined exports for all reducers
   - `reducers: SignalReducers<PRDWorkflowState>` - Main export
   - Re-exports individual reducer modules for granular testing

3. **packages/prd-workflow/tests/reducers/planning.test.ts**
   - 16 tests covering all 4 reducers
   - Uses Immer's produce() to simulate workflow engine behavior
   - Tests state mutations, phase transitions, and data storage

**Key Implementation Pattern**:
```typescript
export const myReducer: SignalReducer<PRDWorkflowState> = (state, signal) => {
  const draft = state as Draft<PRDWorkflowState>;  // Type-safe cast
  draft.planning.phase = "new_phase";  // Direct mutations via Immer
};
```

**Updated Package Exports** (`packages/prd-workflow/src/index.ts`):
- Added: `export { reducers, planningReducers } from "./reducers/index.js";`

### GATE: Verification Passed
- `bun run typecheck` - 15 packages, 0 errors
- `bun run lint` - 14 packages, no issues
- `bun run test` - 11 suites, 28 prd-workflow tests (12 process + 16 reducer)

### Task: Refactor execution.ts reducer - remove ctx.emit, use Immer mutations

**Context**: Created the execution reducer module following CQRS command-side pattern.
Reducers handle state mutations; orchestration signals already handled by process managers.

**Files Created**:

1. **packages/prd-workflow/src/reducers/execution.ts**
   - 5 reducers using Immer Draft pattern for type-safe direct mutations
   - `taskReadyReducer` - Sets currentTaskId, transitions to "executing_task", marks task "in_progress"
   - `taskCompleteReducer` - Marks task complete, records attempt history, transitions to "awaiting_review"
   - `fixRequiredReducer` - Enters "fixing" phase, resets task to "in_progress", updates attempt count
   - `milestoneTestableReducer` - Sets milestone for review, transitions to "reviewing_milestone"
   - `milestonePassedReducer` - Marks milestone passed, adds to passedMilestones, clears currentMilestone

2. **packages/prd-workflow/tests/reducers/execution.test.ts**
   - 25 tests covering all 5 reducers
   - Tests for state mutations, phase transitions, attempt tracking
   - Edge cases: missing tasks, multiple milestone passes, outcome types

**Updated Files**:

1. **packages/prd-workflow/src/reducers/index.ts**
   - Added import: `import { executionReducers } from "./execution.js";`
   - Added spread: `...executionReducers` to combined reducers
   - Added re-export: `export { executionReducers } from "./execution.js";`

**Key Implementation Patterns**:

1. **AttemptRecord tracking** - Task completions record full history with:
   - Attempt number, timestamp, outcome (success/failure/partial)
   - Files changed, checkpoint hash for rollback support

2. **Phase state machine** - ExecutionPhase transitions:
   - idle → executing_task (task:ready)
   - executing_task → awaiting_review (task:complete)
   - idle/awaiting_review → fixing (fix:required)
   - * → idle (milestone:testable - no active task during review)

### GATE: Verification Passed
- `bun run typecheck` - Passes, 0 errors
- `bun run lint` - Passes, no issues (fixed 8 noNonNullAssertion warnings)
- `bun run test` - 53 prd-workflow tests (12 process + 16 planning + 25 execution)

### Task: Refactor review.ts reducer - remove ctx.emit, use Immer mutations

**Context**: Created the review reducer module following CQRS command-side pattern.
Reducers handle state mutations; orchestration signals already handled by process managers.

**Files Created**:

1. **packages/prd-workflow/src/reducers/review.ts**
   - 4 reducers using Immer Draft pattern for type-safe direct mutations
   - `taskApprovedReducer` - Clears currentTaskId, transitions execution and review phases to "idle"
   - `milestoneFailedReducer` - Sets currentMilestoneId, resets failing task to "pending"
   - `milestoneRetryReducer` - Sets milestone for retry, resets all tasks in milestone to "pending"
   - `workflowCompleteReducer` - Transitions review phase to "complete", clears state

2. **packages/prd-workflow/tests/reducers/review.test.ts**
   - 23 tests covering all 4 reducers
   - Tests for state mutations, phase transitions, edge cases
   - Handles: null taskId, nonexistent tasks/milestones, various completion reasons

**Updated Files**:

1. **packages/prd-workflow/src/reducers/index.ts**
   - Added import: `import { reviewReducers } from "./review.js";`
   - Added spread: `...reviewReducers` to combined reducers
   - Added re-export: `export { reviewReducers } from "./review.js";`

**Key Implementation Patterns**:

1. **Review state management**:
   - `task:approved` → Clears execution state, ready for next task
   - `milestone:failed` → Preserves milestone context for debugging
   - `milestone:retry` → Full reset of all tasks in milestone for re-execution
   - `workflow:complete` → Final cleanup, marks workflow as done

2. **Phase state machine** - ReviewPhase transitions:
   - idle ↔ reviewing_task (task review cycle)
   - idle ↔ reviewing_milestone (milestone test cycle)
   - * → complete (workflow:complete terminal state)

### GATE: Verification Passed
- `bun run typecheck` - Passes, 0 errors
- `bun run lint` - Passes, no issues
- `bun run test` - 76 prd-workflow tests (12 process + 16 planning + 25 execution + 23 review)

### Task: Update reducers/index.ts - remove ReducerContext from type signature

**Context**: Verified that this task was already complete. The reducers were created with the
correct signature from the start - no ReducerContext parameter exists anywhere in the codebase.

**Verification**:
- `grep ReducerContext packages/prd-workflow` - No matches
- `grep ctx.emit packages/prd-workflow` - No matches
- SignalReducer type in @internal/core already defines: `(state: TState, signal: Signal) => void`

### Task: Update workflow.ts - pass both reducers and processes to runReactive

**Context**: Created workflow.ts to provide a pre-configured workflow runner combining the
CQRS reducers (command side) and process managers (query side).

**Files Created**:

1. **packages/prd-workflow/src/workflow.ts**
   - `createPRDWorkflow()` - Factory function returning typed `agent()` and `runReactive()`
   - `runPRDWorkflow(config)` - Convenience wrapper that:
     - Creates initial state from PRD string via `createInitialState()`
     - Attaches all reducers (planning, execution, review)
     - Attaches all process managers for orchestration
     - Runs the reactive workflow
   - `PRDWorkflowConfig` interface for configuration

2. **packages/prd-workflow/tests/workflow.test.ts**
   - 10 tests covering factory and runner
   - Tests for: factory creation, typed agent state access, initial state from PRD
   - Tests for: workflow signal history (start/end), reducer exports, process exports
   - Uses mock harness for testing without network calls

**Updated Package Exports** (`packages/prd-workflow/src/index.ts`):
- Added: `export { createPRDWorkflow, runPRDWorkflow } from "./workflow.js";`
- Added: `export type { PRDWorkflowConfig } from "./workflow.js";`

### Task: Export processes from prd-workflow index

**Context**: Already complete - processes were exported in earlier task. Added workflow exports.

## 2026-01-19 - Phase 1: PRD Workflow Refactor (COMPLETE)

### GATE: Phase 1 Verification Passed
- `bun run typecheck` - 15 packages, 0 errors
- `bun run lint` - 14 packages, no issues
- `bun run test` - 86 prd-workflow tests, all passing
  - 12 process manager tests
  - 16 planning reducer tests
  - 25 execution reducer tests
  - 23 review reducer tests
  - 10 workflow runner tests

**Phase 1 Summary**:
Created complete PRD workflow package implementing CQRS pattern:
- **Process Managers** (query side): 6 orchestration handlers emitting derived signals
- **Reducers** (command side): 13 state mutation handlers using Immer Draft pattern
- **Workflow Runner**: Convenience API combining reducers + processes
- **Total**: 86 comprehensive tests covering all functionality

## 2026-01-19 - Phase 2: DX Integration Test (COMPLETE)

### Task: Create dx-integration.test.ts with record/replay test

**Context**: Created comprehensive DX integration tests to verify the recording
and replay functionality for PRD workflows.

**Files Created**:

1. **packages/prd-workflow/tests/dx-integration.test.ts**
   - 10 comprehensive tests covering record/replay functionality
   - Tests organized in two describe blocks:
     - "DX Integration - Record/Replay" (8 tests)
     - "DX Integration - Recording Metadata" (2 tests)

**Test Coverage**:

1. **Record Mode Tests**:
   - `records signals and returns a recordingId` - Verifies recordingId format and storage
   - `replays recording with identical final state` - State comparison between record/replay
   - `replays harness signals identically` - Signal-by-signal comparison
   - `replay is instant (no network delay)` - Performance test (<100ms, low variance)
   - `replay works without a harness` - Verifies signals are injected from recording
   - `validates recording exists before replay` - Error handling for missing recording
   - `requires store for record mode` - Error handling for missing store
   - `requires recordingId for replay mode` - Error handling for missing recordingId

2. **Recording Metadata Tests**:
   - `stores recording with metadata for querying` - Verifies name, tags, signalCount, durationMs
   - `can delete recordings from store` - Verifies exists/delete/exists flow

**Key Implementation Details**:

1. **Mock Harness Pattern**: Two helper functions created:
   - `createDeterministicMockHarness(plannerOutput)` - For predictable structured output
   - `createSimpleMockHarness()` - For simple completion tests

2. **Recording API Usage**:
   - Record mode: `recording: { mode: "record", store, name, tags }`
   - Replay mode: `recording: { mode: "replay", store, recordingId }`
   - No harness required for replay (signals injected from recording)

3. **Assertions Pattern**:
   - State comparison: Compare `planning.prd`, `planning.phase`, etc.
   - Signal comparison: Filter harness signals, compare names and payloads
   - Performance: `performance.now()` timing with threshold checks

**Recording Structure Discovery**:
- `Recording` has nested `metadata` field (not flat properties)
- Access via `recording.metadata.name`, `recording.metadata.tags`
- `finalized` is internal state, not exposed on `Recording` interface
- `durationMs` is set on finalization, can be used to verify finalization

### GATE: Phase 2 Verification Passed
- `bun run typecheck` - 15 packages, 0 errors
- `bun run lint` - 14 packages, 21 warnings (all noNonNullAssertion in tests)
- `bun run test` - 96 prd-workflow tests, all passing
  - 12 process manager tests
  - 16 planning reducer tests
  - 25 execution reducer tests
  - 23 review reducer tests
  - 10 workflow runner tests
  - 10 dx-integration tests

**Phase 2 Summary**:
Added comprehensive DX integration tests for record/replay functionality:
- **10 new tests** covering all record/replay scenarios
- **Deterministic mocks** for predictable test behavior
- **Performance validation** ensuring replay is instant
- **Error handling** for missing store/recordingId
- **Metadata verification** for query-based recording management

## 2026-01-19 - Phase 0: Cleanup (COMPLETE)

### Task: Phase 0.1 - Fix existing TypeScript and lint errors

**Context**: The tasks.yaml mentioned TypeScript errors in execution.ts at lines 73 and 77,
but these were already fixed in earlier work. The remaining issues were lint warnings.

**Issues Found**:
1. 15 `noNonNullAssertion` lint warnings in `packages/prd-workflow/tests/dx-integration.test.ts`
2. 1 `noUnusedImports` warning for unused imports

**Changes Made**:

1. **packages/prd-workflow/tests/dx-integration.test.ts**
   - Replaced non-null assertions (`!`) with explicit type guards
   - Pattern: Added `if (!value) throw new Error("...")` after `expect(...).toBeDefined()`
   - This makes tests fail immediately if a value is unexpectedly undefined
   - Removed unused imports: `createInitialState`, `PRDWorkflowState`, `processes`, `reducers`

**Files Modified**:
- `packages/prd-workflow/tests/dx-integration.test.ts`

**Verification**:
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 96 tests passed across 6 files

**Why this approach**: Using type guards (`if (!value) throw`) instead of optional chaining (`?.`)
provides better test failure messages and maintains type safety. The explicit throw ensures
the test fails at the exact point of the null check rather than silently propagating undefined.

### Task: Phase 0.2 - GATE - Verify clean baseline

**Context**: Verification gate to confirm the codebase is in a clean state before proceeding
with Handler pattern implementation.

**Verification Results**:

1. **Typecheck**: `bun run typecheck`
   - Result: 15 successful, 15 total
   - Status: ✓ ZERO errors

2. **Lint**: `bun run lint`
   - Result: 14 successful, 14 total
   - Status: ✓ ZERO warnings

3. **Tests**: `bun run test`
   - Result: 11 successful, 11 total (all cached from previous runs)
   - Status: ✓ ALL pass

**Gate Criteria**: ALL PASSED
- Typecheck: ZERO errors ✓
- Lint: ZERO warnings ✓
- Tests: ALL pass ✓

**Conclusion**: Codebase is in clean state. Ready to proceed with Phase 1 (SDK Core - Handler Type).

## 2026-01-19 - Phase 1: SDK Core - Handler Type (IN PROGRESS)

### Task: Phase 1.1 - Design SignalHandler type in @internal/core

**Context**: The SDK has two separate concepts - SignalReducer (mutations only) and
ProcessManager (emissions only). The Handler pattern unifies these into a single
SignalHandler type that can both mutate state and return signals to emit.

**Files Modified**:

1. **packages/internal/core/src/api/create-workflow.ts**
   - Added `SignalHandler<TState>` type: `(state: TState, signal: Signal) => Signal[] | void`
   - Added `SignalHandlers<TState>` type: `Record<string, SignalHandler<TState>>`
   - Added `handlers` option to `ReactiveWorkflowConfig`
   - Implemented handler subscription in `runReactive`:
     - Handlers run AFTER reducers but BEFORE process managers
     - Handlers execute within Immer's `produce()` for immutable state updates
     - Handlers can return `Signal[]` to emit follow-up signals

2. **packages/internal/core/src/api/index.ts**
   - Added exports: `SignalHandler`, `SignalHandlers`

3. **packages/internal/core/tests/api/signal-handler.test.ts** (NEW)
   - 11 tests covering:
     - Type-level tests for SignalHandler signature
     - State mutation via handlers
     - Signal emission via handlers
     - Execution order (reducers → handlers → processes)
     - Chained signal emission

**Key Implementation Pattern**:
```typescript
// Unified handler - mutates state AND emits signals
const handler: SignalHandler<MyState> = (state, signal) => {
  // MUTATION (Immer handles immutability)
  state.tasks[signal.payload.taskId].status = "complete";

  // EMISSION (return signals to emit)
  return [{ name: "review:start", payload: { taskId: signal.payload.taskId } }];
};

// Usage in runReactive
await runReactive({
  agents: { myAgent },
  state: initialState,
  handlers: {
    "task:complete": handler,
  },
});
```

**Execution Order**: reducers → handlers → processes
- Reducers mutate state (no emissions)
- Handlers mutate state AND emit signals
- Process managers emit signals (no mutations)

### GATE: Phase 1.1 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 11 suites, ALL passed (including 11 new SignalHandler tests)

### Task: Phase 1.2 - Export SignalHandler from public packages

**Context**: The `SignalHandler` type from Phase 1.1 needs to be available from the public
`@open-harness/core` package. However, there was a naming collision: `@internal/signals` already
exports a `SignalHandler` type (for bus subscription callbacks) with a different signature.

**Issue Discovered**:
- `@internal/core`: `SignalHandler<TState> = (state: TState, signal: Signal) => Signal[] | void`
- `@internal/signals`: `SignalHandler<T> = (signal: Signal<T>) => void`

The public package uses `export * from "@internal/core"` followed by explicit re-exports from
`@internal/signals`. TypeScript's explicit exports take precedence over wildcard exports, which
would have caused the bus callback type to override the unified handler type.

**Solution**:
Renamed the `@internal/signals` SignalHandler to `BusSignalHandler` in the public export to
avoid collision. This allows:
- `SignalHandler<TState>` - The unified handler pattern (state + signal → signals)
- `BusSignalHandler<T>` - The bus subscription callback (signal → void)

**Files Modified**:

1. **packages/open-harness/core/src/index.ts**
   - Added v0.3.2 comment explaining the rename
   - Changed `type SignalHandler` to `type SignalHandler as BusSignalHandler`
   - Preserved backward compatibility for bus callback users via the new name

**Verification**:
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 11 suites, ALL passed

**Exports now available from @open-harness/core**:
- `SignalHandler<TState>` - Unified handler pattern (from @internal/core)
- `SignalHandlers<TState>` - Map of patterns to handlers (from @internal/core)
- `BusSignalHandler<T>` - Bus subscription callback (renamed from @internal/signals)

### Task: Phase 1.3 - GATE - Verify SDK Handler type works

**Context**: Verification gate to confirm the Handler type is properly integrated and all quality checks pass.

**Verification Results**:

1. **Typecheck**: `bun run typecheck`
   - Result: 15 successful, 15 total (all cached)
   - Status: ✓ ZERO errors

2. **Lint**: `bun run lint`
   - Result: 14 successful, 14 total (all cached)
   - Status: ✓ ZERO warnings

3. **Tests**: `bun run test`
   - Result: 11 successful, 11 total (all cached)
   - Status: ✓ ALL pass

**Export Verification**:
- `SignalHandler` and `SignalHandlers` exported from `@internal/core/src/api/index.ts` (lines 89-90)
- Available from `@open-harness/core` via wildcard export from `@internal/core`
- `BusSignalHandler` renamed to avoid collision (documented in v0.3.2 comment)

**Gate Criteria**: ALL PASSED
- All quality checks pass ✓
- Handler type is exported and usable ✓

**Conclusion**: Phase 1 (SDK Core - Handler Type) complete. Ready to proceed with Phase 2 (SQLite Signal Store).

## 2026-01-19 - Phase 2: SQLite Signal Store (IN PROGRESS)

### Task: Phase 2.1 - Create SqliteSignalStore implementation

**Context**: The codebase only had MemorySignalStore (ephemeral, in-memory). We needed
SqliteSignalStore for persistent recordings that survive process restarts.

**Decision: Bun's Native SQLite vs better-sqlite3**:
The tasks.yaml suggested using better-sqlite3, but this is a Bun project (bun@1.3.3).
Bun has built-in SQLite support via `bun:sqlite` which provides:
- Zero external dependencies
- Native Bun integration
- Better performance
- Same synchronous API as better-sqlite3

**Files Created**:

1. **packages/open-harness/stores/src/sqlite-store.ts**
   - Implements full `SignalStore` interface from `@internal/signals`
   - Uses Bun's native `bun:sqlite` module
   - 12 methods: create, append, appendBatch, checkpoint, getCheckpoints,
     finalize, load, loadSignals, list, delete, exists, close
   - SQLite schema with 3 tables: recordings, signals, checkpoints
   - Pattern matching for signal filtering (using regex in memory)
   - Transaction support for atomic batch operations

2. **packages/open-harness/stores/tests/sqlite-store.test.ts**
   - 33 comprehensive tests covering all 12 interface methods
   - Tests for edge cases: nonexistent recordings, finalized recordings
   - Persistence test verifying data survives across store instances
   - Uses temp database files with cleanup in afterEach

**Key Implementation Details**:

1. **ID Generation**: `rec_${crypto.randomUUID().slice(0, 8)}`

2. **Schema Tables**:
   - `recordings`: metadata (id, name, tags, harness_type, created_at, etc.)
   - `signals`: signal data (recording_id, signal_index, signal_id, name, payload, timestamp, source)
   - `checkpoints`: checkpoint markers (recording_id, name, signal_index, timestamp)

3. **Signal Serialization**:
   - `payload` stored as JSON string
   - `source` (SignalSource object) stored as JSON string
   - Full Signal interface preserved: id, name, payload, timestamp, source

4. **Bun SQLite Quirks Discovered**:
   - `stmt.get()` returns `null` (not `undefined`) when no row found
   - `OFFSET` requires `LIMIT` in SQLite (use `LIMIT -1` for unlimited)

**Updated Package Exports** (`packages/open-harness/stores/src/index.ts`):
- Added: `export { SqliteSignalStore } from "./sqlite-store.js";`

### Task: Phase 2.2 - Add SqliteSignalStore unit tests

**Context**: Tests were written as part of Phase 2.1 implementation.

**Test Coverage** (33 tests):
- Constructor: database and table creation
- create(): unique ID generation, metadata storage
- append(): signal storage, error handling for missing/finalized recordings
- appendBatch(): atomic multi-signal insert
- checkpoint(): checkpoint creation at signal index
- getCheckpoints(): ordered checkpoint retrieval
- finalize(): metadata update with duration
- load(): complete recording retrieval with all signals
- loadSignals(): fromIndex, toIndex, pattern filters
- list(): harnessType filter, tags filter, limit, offset, newest-first ordering
- delete(): cascade deletion of recording + signals + checkpoints
- exists(): boolean existence check
- persistence: data survives across store instances

### GATE: Phase 2.1 & 2.2 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 12 test tasks, ALL passed
  - 33 new SqliteSignalStore tests, ALL passed

### Task: Phase 2.3 - GATE - Verify SqliteSignalStore works

**Context**: Verification gate to confirm SqliteSignalStore is working.

**Verification Results**:

1. **Typecheck**: `bun run typecheck`
   - Result: 15 successful, 15 total
   - Status: ✓ ZERO errors

2. **Lint**: `bun run lint`
   - Result: 14 successful, 14 total
   - Status: ✓ ZERO warnings

3. **Tests**: `bun test packages/open-harness/stores/`
   - Result: 33 pass, 0 fail
   - Status: ✓ ALL tests pass

4. **Export Verification**:
   - SqliteSignalStore class defined in `packages/open-harness/stores/src/sqlite-store.ts:45`
   - Exported from `packages/open-harness/stores/src/index.ts:20`
   - Status: ✓ Exports correctly

**Gate Criteria**: ALL PASSED
- All quality checks pass ✓
- SqliteSignalStore exports correctly ✓
- All tests pass ✓

**Conclusion**: Phase 2 (SQLite Signal Store) complete. Ready to proceed with Phase 3 (PRD-Workflow Refactor).

## 2026-01-19 - Phase 3: PRD-Workflow Refactor (IN PROGRESS)

### Task: Phase 3.1 - Create handlers/ directory with unified handlers

**Context**: The prd-workflow package uses the CQRS pattern with separate reducers (state mutations)
and process managers (signal emissions). The Handler pattern unifies these into single functions
that can both mutate state and return signals to emit.

**Files Created**:

1. **packages/prd-workflow/src/handlers/planning.ts**
   - 4 unified handlers using SignalHandler<PRDWorkflowState> type
   - `planStartHandler` - Transitions to "planning" phase, updates PRD if provided
   - `planCreatedHandler` - Stores plan AND emits task:ready for first task
   - `discoverySubmittedHandler` - Stores discoveries for review
   - `discoveryReviewedHandler` - Adds accepted tasks AND emits task:approved

2. **packages/prd-workflow/src/handlers/execution.ts**
   - 5 unified handlers for task execution
   - `taskReadyHandler` - Sets current task, transitions to executing_task
   - `taskCompleteHandler` - Marks complete AND emits discovery:submitted if discoveries exist
   - `fixRequiredHandler` - Enters fixing phase for failed task
   - `milestoneTestableHandler` - Begins milestone testing
   - `milestonePassedHandler` - Marks passed AND emits next signal (workflow:complete or task:ready)

3. **packages/prd-workflow/src/handlers/review.ts**
   - 4 unified handlers for review workflow
   - `taskApprovedHandler` - Clears state AND emits milestone:testable or task:ready
   - `milestoneFailedHandler` - Updates state AND emits fix:required or milestone:retry
   - `milestoneRetryHandler` - Resets tasks AND emits task:ready for first
   - `workflowCompleteHandler` - Sets terminal state (no signal emission)

4. **packages/prd-workflow/src/handlers/index.ts**
   - Combined PRDWorkflowHandlers map with all 13 handlers
   - Re-exports individual handlers and handler groups for granular testing
   - JSDoc examples for usage with runReactive

**Key Changes from CQRS to Handler Pattern**:

| Signal | Old Pattern | New Pattern |
|--------|-------------|-------------|
| plan:created | Reducer stores data, Process emits task:ready | Handler does BOTH |
| milestone:passed | Reducer marks passed, Process emits next signal | Handler does BOTH |
| task:approved | Reducer clears state, Process determines next | Handler does BOTH |

**Helper Functions Moved**:
- `findFirstPendingTask`, `findNextUntestedMilestone` → execution.ts
- `findNextPendingTask`, `isMilestoneComplete`, `findMilestoneForTask`, `allMilestonesPassed` → review.ts

**Note**: The old reducers/ and processes/ directories are NOT deleted yet (per task instructions).
This allows the handlers to coexist until Phase 3.2 updates workflow.ts to use them.

### GATE: Phase 3.1 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 12 test tasks, 96 tests, ALL passed

**Conclusion**: Phase 3.1 complete. handlers/ directory created with unified handlers.
Ready to proceed with Phase 3.2 (Update workflow.ts to use handlers).

### Task: Phase 3.2 - Update workflow.ts to use handlers

**Context**: Updated the PRD workflow runner to use the unified Handler pattern instead of
the separate CQRS reducers/processes approach.

**Files Modified**:

1. **packages/prd-workflow/src/workflow.ts**
   - Updated module JSDoc to describe the Handler pattern instead of CQRS
   - Removed imports: `processes` from `./processes/index.js`, `reducers` from `./reducers/index.js`
   - Added import: `PRDWorkflowHandlers` from `./handlers/index.js`
   - Updated `runPRDWorkflow` JSDoc to explain unified handler approach
   - Changed `runReactive` call: replaced `reducers` + `processes` with `handlers: PRDWorkflowHandlers`

**Key Changes**:

Old approach (CQRS):
```typescript
return runReactive({
  agents: config.agents,
  state: createInitialState(config.prd),
  // CQRS pattern: reducers handle state mutations, processes handle orchestration
  reducers,
  processes,
});
```

New approach (Unified Handlers):
```typescript
return runReactive({
  agents: config.agents,
  state: createInitialState(config.prd),
  // Unified Handler pattern: handlers do both state mutations AND signal emissions
  handlers: PRDWorkflowHandlers,
});
```

**Why This Works**: The `runReactive` function in `@internal/core` was updated in Phase 1.1
to support a `handlers` option. Handlers execute within Immer's `produce()` for immutable
state updates, and any returned `Signal[]` are emitted after the state update completes.

### GATE: Phase 3.2 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 12 test tasks, 96 prd-workflow tests, ALL passed
- `bun test packages/prd-workflow/tests/workflow.test.ts` - 10 tests, ALL passed

**Conclusion**: Phase 3.2 complete. workflow.ts now uses unified handlers.
Ready to proceed with Phase 3.3 (Remove reducers/ and processes/ directories).

### Task: Phase 3.3 - Remove reducers/ and processes/ directories

**Context**: With the unified Handler pattern in place and workflow.ts using it,
the legacy CQRS directories (reducers/ and processes/) can now be removed.

**Files Removed**:

1. **packages/prd-workflow/src/reducers/** (entire directory)
   - execution.ts, index.ts, planning.ts, review.ts

2. **packages/prd-workflow/src/processes/** (entire directory)
   - index.ts

3. **packages/prd-workflow/tests/reducers/** (entire directory)
   - Tests for the old reducer pattern

4. **packages/prd-workflow/tests/processes.test.ts**
   - Tests for the old process manager pattern

**Files Modified**:

1. **packages/prd-workflow/src/index.ts**
   - Updated JSDoc: Changed from "CQRS pattern" to "unified Handler pattern"
   - Updated example to use `PRDWorkflowHandlers` instead of `reducers` + `processes`
   - Removed: `export { processes } from "./processes/index.js";`
   - Removed: `export { planningReducers, reducers } from "./reducers/index.js";`
   - Added: `export { PRDWorkflowHandlers } from "./handlers/index.js";`

2. **packages/prd-workflow/tests/workflow.test.ts**
   - Updated JSDoc comment
   - Changed import from `processes, reducers` to `PRDWorkflowHandlers`
   - Renamed test suite: "reducers and processes integration" → "unified handlers integration"
   - Updated tests to verify handler exports and behavior:
     - "exports handlers for all signal types" (13 handlers)
     - "handlers have correct signature (state, signal) => Signal[] | void"
     - "handlers can return signals for orchestration" (tests plan:created → task:ready)

**Key Changes**:

| Before (CQRS) | After (Handler Pattern) |
|---------------|------------------------|
| `reducers` export | `PRDWorkflowHandlers` export |
| `processes` export | (merged into handlers) |
| `reducers: { ... }` in runReactive | `handlers: PRDWorkflowHandlers` |
| 4 reducer test files | 0 (coverage via workflow tests) |
| 1 process test file | 0 (coverage via workflow tests) |

**Test Count Change**:
- Old tests removed: 76 tests (12 process + 64 reducer tests)
- Tests updated: 4 tests (workflow.test.ts handler tests updated to match new API)
- Net reduction reflects consolidation - handler behavior tested through workflow integration

### GATE: Phase 3.3 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 12 test tasks, ALL passed
- `ls packages/prd-workflow/src/reducers/` - "No such file or directory" ✓
- `ls packages/prd-workflow/src/processes/` - "No such file or directory" ✓

**Conclusion**: Phase 3.3 complete. Legacy reducers/ and processes/ directories removed.
Ready to proceed with Phase 3.4 (Fix type safety - remove all casts).

### Task: Phase 3.4 - Fix type safety - remove all casts

**Context**: Handlers were using unsafe type casts (`as FooPayload`) to access signal payloads.
The task required eliminating these casts for type safety.

**Solution Approach**:
Instead of requiring casts in every handler, created a centralized type-safe pattern:
1. Consolidate all signal payload types in `types.ts`
2. Create `createHandler<TPayload>()` utility that wraps handler functions
3. The utility performs a SINGLE documented cast internally
4. Handler implementations receive properly typed payloads without any casts

**Files Modified**:

1. **packages/prd-workflow/src/types.ts**
   - Added 13 signal payload type interfaces (PlanStartPayload, TaskReadyPayload, etc.)
   - Added `PRDSignalPayloads` interface mapping signal names to payload types
   - Added `DraftState` type alias for Immer Draft<PRDWorkflowState>
   - Added `TypedHandler<TPayload>` type for handler function signature
   - Added `createHandler<TPayload>()` utility function

2. **packages/prd-workflow/src/handlers/planning.ts**
   - Refactored all 4 handlers to use `createHandler<>()`:
     - `planStartHandler = createHandler<PlanStartPayload | undefined>(...)`
     - `planCreatedHandler = createHandler<PlanCreatedPayload>(...)`
     - `discoverySubmittedHandler = createHandler<DiscoverySubmittedPayload>(...)`
     - `discoveryReviewedHandler = createHandler<DiscoveryReviewedPayload>(...)`
   - Removed all `signal.payload as FooPayload` casts
   - Removed local payload interface definitions (now in types.ts)

3. **packages/prd-workflow/src/handlers/execution.ts**
   - Refactored all 5 handlers to use `createHandler<>()`:
     - `taskReadyHandler = createHandler<TaskReadyPayload>(...)`
     - `taskCompleteHandler = createHandler<TaskCompletePayload>(...)`
     - `fixRequiredHandler = createHandler<FixRequiredPayload>(...)`
     - `milestoneTestableHandler = createHandler<MilestoneTestablePayload>(...)`
     - `milestonePassedHandler = createHandler<MilestonePassedPayload>(...)`
   - Removed all `signal.payload as FooPayload` casts
   - Removed local payload interface definitions (now in types.ts)

4. **packages/prd-workflow/src/handlers/review.ts**
   - Refactored all 4 handlers to use `createHandler<>()`:
     - `taskApprovedHandler = createHandler<TaskApprovedPayload>(...)`
     - `milestoneFailedHandler = createHandler<MilestoneFailedPayload>(...)`
     - `milestoneRetryHandler = createHandler<MilestoneRetryPayload>(...)`
     - `workflowCompleteHandler = createHandler<WorkflowCompletePayload>(...)`
   - Removed all `signal.payload as FooPayload` casts
   - Removed local payload interface definitions (now in types.ts)

**Key Implementation Pattern**:
```typescript
// Before (unsafe cast in every handler):
export const taskReadyHandler: SignalHandler<PRDWorkflowState> = (state, signal) => {
  const draft = state as DraftState;
  const payload = signal.payload as TaskReadyPayload;  // ❌ Cast
  draft.execution.currentTaskId = payload.taskId;
};

// After (type-safe, no casts in handlers):
export const taskReadyHandler = createHandler<TaskReadyPayload>((draft, payload) => {
  // payload is TaskReadyPayload - no cast needed! ✅
  draft.execution.currentTaskId = payload.taskId;
});
```

**Why This Is Better**:
1. Single centralized cast in `createHandler()` - documented and auditable
2. Handler implementations receive properly typed payloads
3. TypeScript enforces payload structure at handler definition site
4. Eliminates 12 scattered `as FooPayload` casts across handler files
5. Payload types consolidated in types.ts for discoverability

### GATE: Phase 3.4 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings
- `bun run test` - 12 test tasks, 19 prd-workflow tests, ALL passed
- `grep -r "as.*Payload" packages/prd-workflow/src/handlers/` - ZERO casts found

**Conclusion**: Phase 3.4 complete. Type-safe handler pattern implemented.
Ready to proceed with Phase 3.5 (GATE - Verify prd-workflow refactor).

### Task: Phase 3.5 - GATE - Verify prd-workflow refactor

**Context**: Verification gate to confirm the prd-workflow refactor to Handler pattern is complete.

**Issue Discovered**: TypeScript error with `TypedHandler` return type.
- `SignalHandler` from `@internal/core` uses `Signal[] | void`
- `TypedHandler` was defined with `Signal[] | undefined`
- Handlers that don't return anything have implicit `void` return
- TypeScript distinguishes `void` from `undefined` strictly

**Fix Applied**: Changed `TypedHandler` to use `Signal[] | void` to match `SignalHandler`.
Added biome-ignore comment to suppress lint warning about void in union (necessary for type compatibility).

**Files Modified**:
1. **packages/prd-workflow/src/types.ts**
   - Updated `TypedHandler` return type from `Signal[] | undefined` to `Signal[] | void`
   - Added biome-ignore comment with rationale

**Verification Results**:

**STRUCTURAL CHECKS**:
1. `ls packages/prd-workflow/src/handlers/`
   - Result: planning.ts, execution.ts, review.ts, index.ts
   - Status: ✓ All expected files present

2. `ls packages/prd-workflow/src/reducers/`
   - Result: "No such file or directory"
   - Status: ✓ Old directory removed

3. `ls packages/prd-workflow/src/processes/`
   - Result: "No such file or directory"
   - Status: ✓ Old directory removed

**QUALITY CHECKS**:
1. `bun run typecheck`
   - Result: 15 successful, 15 total
   - Status: ✓ ZERO errors

2. `bun run lint`
   - Result: 14 successful, 14 total
   - Status: ✓ ZERO warnings

3. `grep -r "as.*Payload" packages/prd-workflow/src/handlers/`
   - Result: 0 casts found (only type imports)
   - Status: ✓ ZERO casts in handlers

4. `bun run test`
   - Result: 12 test tasks, 19 prd-workflow tests, ALL passed
   - Status: ✓ ALL tests pass

**Gate Criteria**: ALL PASSED
- Old directories removed ✓
- handlers/ exists with all files ✓
- No type casts remain ✓
- All quality checks pass ✓

**Conclusion**: Phase 3.5 GATE passed. PRD-workflow refactor to Handler pattern is complete.
Ready to proceed with Phase 4 (CLI).

## 2026-01-19 - Phase 4: CLI (IN PROGRESS)

### Task: Phase 4.1 - Create sandbox directory and example PRD

**Context**: Setup the sandbox directory for PRD workflow execution and create an example PRD file.

**Files Created**:

1. **.sandbox/.gitkeep**
   - Empty file to ensure the .sandbox directory is tracked by git
   - The directory itself is ignored (for generated content)

2. **examples/hello-world.prd.md**
   - Simple example PRD for testing the CLI
   - Contains: Overview, 2 Tasks (create function + tests), 1 Milestone

**Files Modified**:

1. **.gitignore**
   - Added `.sandbox/` to "Test Artifacts & Workspaces" section
   - This ignores generated content but .gitkeep ensures directory exists

**Verification**:
- `ls -la .sandbox/` - .gitkeep present
- `grep sandbox .gitignore` - Shows `.sandbox/` at line 81
- `cat examples/hello-world.prd.md` - Shows expected PRD content
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings

**Conclusion**: Phase 4.1 complete. Sandbox directory and example PRD created.
Ready to proceed with Phase 4.2 (Create CLI entry point).

### Task: Phase 4.2 - Create CLI entry point

**Context**: Created the CLI script for running PRD workflows with live/record/replay modes.

**Files Created**:

1. **packages/prd-workflow/src/cli.ts**
   - Full CLI implementation using Node.js `parseArgs`
   - Three modes: `live`, `record`, `replay`
   - Options:
     - `--mode, -m`: Mode selection (default: live)
     - `--recording`: Recording ID for replay mode
     - `--sandbox, -s`: Sandbox directory (default: .sandbox)
     - `--database, -d`: SQLite database path (default: .sandbox/recordings.db)
     - `--name, -n`: Recording name for record mode
     - `--tags, -t`: Recording tags, comma-separated
     - `--help, -h`: Show help
   - Uses SqliteSignalStore from @open-harness/stores
   - Dynamic imports to avoid loading heavy dependencies when showing help

2. **packages/prd-workflow/tests/cli.test.ts**
   - 14 comprehensive tests covering:
     - Argument parsing (help flags, required arguments, invalid modes)
     - Replay mode (validates recording exists, replays existing recordings)
     - Sandbox directory (creation, defaults)
     - Database path (defaults, directory creation)
     - Tag parsing

**Files Modified**:

1. **packages/prd-workflow/package.json**
   - Added `@open-harness/stores` dependency
   - Added `bin` field for CLI entry point
   - Added scripts: `prd:live`, `prd:record`, `prd:replay`

**Key Implementation Pattern**:
```bash
# Run live workflow
bun run prd:live examples/hello-world.prd.md

# Record a workflow run
bun run prd:record examples/hello-world.prd.md --name "test run" --tags "integration,ci"

# Replay a recorded workflow
bun run prd:replay --recording rec_abc12345
```

### GATE: Phase 4.2 Verification Passed
- `bun run typecheck` - 15 packages, ZERO errors
- `bun run lint` - 14 packages, ZERO warnings (1 file auto-fixed)
- `bun run test` - 33 prd-workflow tests, ALL passed
  - 19 existing tests (workflow, dx-integration)
  - 14 new CLI tests
- `bun run prd:live --help` - Shows help output correctly
- `cat packages/prd-workflow/package.json | grep prd:` - Shows all 3 scripts

**Conclusion**: Phase 4.2 complete. CLI entry point created with live/record/replay modes.
Ready to proceed with Phase 4.3 (Update workflow.ts for CLI options).

