# Ralphy Progress Log
# Iteration started: Mon Jan 19 14:42:31 GMT 2026

## 2026-01-19 14:42 - PRD Created

### Declarative Agent Pattern with Structured Outputs

Created PRD to fix agent→handler contract mismatch by:
1. Adding `defineAgent()` utility with Zod→JSON schema conversion
2. Creating shared schemas for agents and handlers
3. Wiring structured outputs through workflow
4. Migrating planner agent as first example

Key insight: ClaudeHarness ALREADY supports structured outputs,
we just need to wire Zod schemas through agent config.

Next step: /ralphy:tasks


## 2026-01-19 14:43 - Tasks Generated

### Validation: PASSED

Generated tasks.yaml with 4 phases, 9 tasks:
- Phase 1: Dependencies & Core Utility (3 tasks)
- Phase 2: Shared Schemas (2 tasks)
- Phase 3: Agent & Workflow Wiring (3 tasks)
- Phase 4: Verification (1 task)

Constitution check: 0 violations

Next step: /ralphy:run


## 2026-01-19 15:04 - Task 1.1 Complete

### Zod 4 Native JSON Schema Support Verified

**Discovery**: The original task specified using `zod-to-json-schema`, but that
library doesn't support Zod 4.x (returns empty schema object). Zod 4 has native
JSON Schema conversion via `z.toJSONSchema()`.

**Actions taken**:
1. Installed zod-to-json-schema to test - confirmed incompatible with zod 4.x
2. Verified Zod 4's native `z.toJSONSchema()` works correctly
3. Removed zod-to-json-schema (not needed with native support)
4. Updated tasks.yaml to reflect the correct approach

**Impact on remaining tasks**:
- Task 1.2 will use `z.toJSONSchema(schema)` instead of `zodToJsonSchema()`
- No additional dependency needed
- Simpler implementation

Tests: PASSED
Lint: PASSED

Next step: Task 1.2 - Create defineAgent utility


## 2026-01-19 15:14 - Tasks 1.2 & 1.3 Complete

### defineAgent Utility Created and Exported

**Task 1.2: Create defineAgent utility**

Created `packages/internal/core/src/api/define-agent.ts` with:
- `defineAgent<TOutput, TState>()` function accepting Zod schemas
- Uses Zod 4's native `z.toJSONSchema()` for conversion (no external lib)
- Returns `CompiledAgent` with both `zodSchema` and `jsonSchema`
- Supports dynamic prompts: `prompt: string | (ctx) => string`
- Supports `when` guards for conditional activation
- Supports `updates` field for direct state mapping

**Key design decisions**:
1. Custom `ZodSchema<T>` type for Zod 3/4 compatibility
2. JSON Schema cached at definition time (not per-call)
3. Type inference preserved through generic parameters

**Task 1.3: Export from @internal/core**

Updated `packages/internal/core/src/api/index.ts` to export:
- `defineAgent` function
- `AgentDefinition` type
- `CompiledAgent` type
- `JSONSchema` type

**Tests**: Created comprehensive test suite with 9 tests covering:
- Basic schema conversion
- Dynamic prompts
- When guards
- Agents without schemas
- Complex nested schemas
- Type inference

**Verification**:
- All 143 tests pass
- Typecheck passes (15 packages)
- Lint passes (14 packages)

Next step: Task 2.1 - Create plan.schema.ts with Zod schemas


## 2026-01-19 16:30 - Task 2.1 Complete

### Shared Zod Schemas Created

**Task 2.1: Create plan.schema.ts with Zod schemas**

Created `packages/prd-workflow/src/schemas/plan.schema.ts` with:
- `TaskStatusSchema` - enum for task status
- `AttemptRecordSchema` - record of task execution attempts
- `TaskSchema` - full task definition (matches Task interface)
- `MilestoneSchema` - milestone definition (matches Milestone interface)
- `PlanCreatedPayloadSchema` - structured output for planner agent

**Key design decisions**:
1. All schemas use `.describe()` for LLM-friendly documentation
2. Default values for status/attempt/passed ensure agents can return minimal data
3. Types exported via `z.infer<>` for single source of truth
4. Structure exactly matches existing interfaces in types.ts

**Tests**: Created comprehensive test suite with 12 tests covering:
- Schema validation for all types
- Default value application
- JSON Schema generation via `z.toJSONSchema()`
- Description preservation in generated JSON Schema

**Verification**:
- All 54 tests pass in prd-workflow (12 new + 42 existing)
- Lint passes

Next step: Task 2.2 - Create schemas index and update types.ts
