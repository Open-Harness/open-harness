# Anti-Patterns Registry
# ─────────────────────────────────────────────────────────────────────────────
# Central registry of known anti-patterns learned from retrospectives.
# Read by Scout (context curation) and Verifier (behavioral checks).
# Updated by oharnes.close when crystallizing retrospective decisions.
# ─────────────────────────────────────────────────────────────────────────────

last_updated: "2025-12-26"

source_retros:
  - specs/003-harness-renderer/retro
  - specs/004-test-infra-audit/retro

# ─────────────────────────────────────────────────────────────────────────────
# CODE PATTERNS
# Grep-able patterns that indicate problems when found in specific contexts.
# ─────────────────────────────────────────────────────────────────────────────

code_patterns:
  # Test categorization violations
  - pattern: "createRecordingContainer"
    context: "tests/unit/**"
    issue: "Uses recording infrastructure - not a unit test"
    recommendation: "Move to tests/integration/"
    severity: critical
    source: "004-test-infra-audit RC001"

  - pattern: "fetch\\("
    context: "tests/unit/**"
    issue: "Makes HTTP calls - not a unit test"
    recommendation: "Move to tests/integration/"
    severity: critical
    source: "004-test-infra-audit RC001"

  - pattern: "ANTHROPIC_API_KEY"
    context: "tests/unit/**"
    issue: "Requires real API credentials - not a unit test"
    recommendation: "Move to tests/e2e/"
    severity: critical
    source: "004-test-infra-audit RC001"

  - pattern: "process\\.env\\.ANTHROPIC"
    context: "tests/unit/**"
    issue: "Environment dependency - may need test isolation"
    recommendation: "Mock environment or move to integration/"
    severity: high
    source: "004-test-infra-audit RC001"

  # Bun CLI confusion
  - pattern: "bun test "
    context: "*.md"
    issue: "bun test ignores package.json scripts"
    recommendation: "Use 'bun run test' to respect package.json config"
    severity: medium
    source: "004-test-infra-audit RC004"

# ─────────────────────────────────────────────────────────────────────────────
# STRUCTURAL PATTERNS
# Anti-patterns that aren't grep-able but describe systemic issues.
# Used for agent awareness, not automated detection.
# ─────────────────────────────────────────────────────────────────────────────

structural_patterns:
  - name: "static-validation-only"
    description: "Verifying file exists without testing runtime behavior"
    detection: "Verifier output missing behavioral_checks section"
    mitigation: "Always run tests for test files, check categorization"
    source: "003-harness-renderer, 004-test-infra-audit (recurring)"

  - name: "file-list-context"
    description: "Scout returning file paths without WHY/WHAT/HOW context"
    detection: "Scout output lacks line numbers, interfaces, or patterns"
    mitigation: "Scout must extract key interfaces and categorization warnings"
    source: "004-test-infra-audit RC002"

  - name: "prototype-contamination"
    description: "Reading prototype/example files when implementing production code"
    detection: "Context includes files matching **/prototype/** or examples/**"
    mitigation: "Strict Context Scope exclusions, scout warnings"
    source: "003-harness-renderer"

# ─────────────────────────────────────────────────────────────────────────────
# PROBLEM PATHS
# File paths/globs that have historically been sources of issues.
# Higher scrutiny during verification.
# ─────────────────────────────────────────────────────────────────────────────

problem_paths:
  - glob: "tests/unit/**"
    risk: high
    note: "Unit tests frequently misclassified in 003, 004"
    check: "Grep for API patterns, verify no network calls"

  - glob: "**/prototype/**"
    risk: critical
    note: "Prototype code should never be read during implementation"
    check: "Should be excluded by Context Scope"

  - glob: "examples/**"
    risk: high
    note: "Example code may have different patterns than production"
    check: "Should be excluded unless explicitly needed"

# ─────────────────────────────────────────────────────────────────────────────
# MAINTENANCE
# ─────────────────────────────────────────────────────────────────────────────
#
# This file is updated by oharnes.close when crystallizing decisions:
# 1. Read new patterns from decisions.yaml
# 2. Append new code_patterns or structural_patterns
# 3. Update source_retros list
# 4. Bump last_updated
#
# To add a pattern manually:
# 1. Identify the root cause from a retrospective
# 2. Determine if it's grep-able (code_pattern) or structural
# 3. Add with source reference to the retrospective
# 4. Update last_updated
# ─────────────────────────────────────────────────────────────────────────────
